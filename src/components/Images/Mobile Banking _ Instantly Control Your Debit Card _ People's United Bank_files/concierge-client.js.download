/* Copyright 2014-2020 © Moxie Software. All Rights Reserved. Concierge Version: v1.22.0 */
!function(){"use strict";function e(e){return"function"==typeof e}var t,n,i=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},r=0,o=function(e,t){m[r]=e,m[r+1]=t,2===(r+=2)&&(n?n(w):g())};var a="undefined"!=typeof window?window:void 0,s=a||{},c=s.MutationObserver||s.WebKitMutationObserver,u="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),l="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function d(){var e=setTimeout;return function(){return e(w,1)}}var g,h,f,p,v,m=new Array(1e3);function w(){for(var e=0;e<r;e+=2){(0,m[e])(m[e+1]),m[e]=void 0,m[e+1]=void 0}r=0}function y(e,t){var n=this,i=new this.constructor(C);void 0===i[S]&&W(i);var r=n._state;if(r){var a=arguments[r-1];o((function(){return x(r,i,a,n._result)}))}else T(n,i,e,t);return i}function b(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(C);return I(t,e),t}u?g=function(){return process.nextTick(w)}:c?(f=0,p=new c(w),v=document.createTextNode(""),p.observe(v,{characterData:!0}),g=function(){v.data=f=++f%2}):l?((h=new MessageChannel).port1.onmessage=w,g=function(){return h.port2.postMessage(0)}):g=void 0===a&&"function"==typeof require?function(){try{var e=Function("return this")().require("vertx");return void 0!==(t=e.runOnLoop||e.runOnContext)?function(){t(w)}:d()}catch(e){return d()}}():d();var S=Math.random().toString(36).substring(2);function C(){}function _(t,n,i){n.constructor===t.constructor&&i===y&&n.constructor.resolve===b?function(e,t){1===t._state?E(e,t._result):2===t._state?O(e,t._result):T(t,void 0,(function(t){return I(e,t)}),(function(t){return O(e,t)}))}(t,n):void 0===i?E(t,n):e(i)?function(e,t,n){o((function(e){var i=!1,r=function(e,t,n,i){try{e.call(t,n,i)}catch(e){return e}}(n,t,(function(n){i||(i=!0,t!==n?I(e,n):E(e,n))}),(function(t){i||(i=!0,O(e,t))}),e._label);!i&&r&&(i=!0,O(e,r))}),e)}(t,n,i):E(t,n)}function I(e,t){if(e===t)O(e,new TypeError("You cannot resolve a promise with itself"));else if(r=typeof(i=t),null===i||"object"!==r&&"function"!==r)E(e,t);else{var n;try{n=t.then}catch(t){return void O(e,t)}_(e,t,n)}var i,r}function N(e){e._onerror&&e._onerror(e._result),k(e)}function E(e,t){void 0===e._state&&(e._result=t,e._state=1,0!==e._subscribers.length&&o(k,e))}function O(e,t){void 0===e._state&&(e._state=2,e._result=t,o(N,e))}function T(e,t,n,i){var r=e._subscribers,a=r.length;e._onerror=null,r[a]=t,r[a+1]=n,r[a+2]=i,0===a&&e._state&&o(k,e)}function k(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var i,r,o=e._result,a=0;a<t.length;a+=3)i=t[a],r=t[a+n],i?x(n,i,r,o):r(o);e._subscribers.length=0}}function x(t,n,i,r){var o,a,s=e(i),c=!0;if(s){try{o=i(r)}catch(e){c=!1,a=e}if(n===o)return void O(n,new TypeError("A promises callback cannot return that same promise."))}else o=r;void 0!==n._state||(s&&c?I(n,o):!1===c?O(n,a):1===t?E(n,o):2===t&&O(n,o))}var L=0;function W(e){e[S]=L++,e._state=void 0,e._result=void 0,e._subscribers=[]}var M=function(e,t){this._instanceConstructor=e,this.promise=new e(C),this.promise[S]||W(this.promise),i(t)?(this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?E(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),0===this._remaining&&E(this.promise,this._result))):O(this.promise,new Error("Array Methods must be provided an Array"))};M.prototype._enumerate=function(e){for(var t=0;void 0===this._state&&t<e.length;t++)this._eachEntry(e[t],t)},M.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,i=n.resolve;if(i===b){var r,o,a=!1;try{r=e.then}catch(e){a=!0,o=e}if(r===y&&void 0!==e._state)this._settledAt(e._state,t,e._result);else if("function"!=typeof r)this._remaining--,this._result[t]=e;else if(n===A){var s=new n(C);a?O(s,o):_(s,e,r),this._willSettleAt(s,t)}else this._willSettleAt(new n((function(t){return t(e)})),t)}else this._willSettleAt(i(e),t)},M.prototype._settledAt=function(e,t,n){var i=this.promise;void 0===i._state&&(this._remaining--,2===e?O(i,n):this._result[t]=n),0===this._remaining&&E(i,this._result)},M.prototype._willSettleAt=function(e,t){var n=this;T(e,void 0,(function(e){return n._settledAt(1,t,e)}),(function(e){return n._settledAt(2,t,e)}))};var A=function e(t){this[S]=L++,this._result=this._state=void 0,this._subscribers=[],C!==t&&("function"!=typeof t&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof e?function(e,t){try{t((function(t){I(e,t)}),(function(t){O(e,t)}))}catch(t){O(e,t)}}(this,t):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())};A.prototype.catch=function(e){return this.then(null,e)},A.prototype.finally=function(t){var n=this.constructor;return e(t)?this.then((function(e){return n.resolve(t()).then((function(){return e}))}),(function(e){return n.resolve(t()).then((function(){throw e}))})):this.then(t,t)},A.prototype.then=y,A.all=function(e){return new M(this,e).promise},A.race=function(e){var t=this;return i(e)?new t((function(n,i){for(var r=e.length,o=0;o<r;o++)t.resolve(e[o]).then(n,i)})):new t((function(e,t){return t(new TypeError("You must pass an array to race."))}))},A.resolve=b,A.reject=function(e){var t=new this(C);return O(t,e),t},A._setScheduler=function(e){n=e},A._setAsap=function(e){o=e},A._asap=o;var D={EQUAL:0,GREATER:1,LESS:2,GREATEREQ:3,LESSEQ:4,BETWEEN:5,NOTEQUAL:6,CONTAINS:10,NOTCONTAINS:11,STARTSWITH:12,NOTSTARTSWITH:13,ENDSWITH:14,NOTENDSWITH:15,MATCH:16,NOTMATCH:17,CUSTOM:18,FIRST:0,CURRENT:1,PREVIOUS:2};function R(e){return"string"==typeof e&&(e=isNaN(e)?Date.parse(e):Number(e)),"object"==typeof e&&e instanceof Date&&(e=e.getTime()),"number"==typeof e&&e<9999999999&&(e*=1e3),e}function P(e,t,n){if(null==e)throw new TypeError('"array" is null or not defined');var i=e.length>>>0;for(n=+n||0,Math.abs(n)===1/0&&(n=0),n<0&&(n+=i)<0&&(n=0);n<i;n++)if(e[n]===t)return n;return-1}function j(e,t,n){return n=n||0,e.lastIndexOf(t,n)===n}function V(e,t,n){var i=e.toString();(void 0===n||n>i.length)&&(n=i.length),n-=t.length;var r=i.indexOf(t,n);return-1!==r&&r===n}function F(e,t,n){return-1!==e.indexOf(t,n)}function J(e){var t=".",n=V(e=(""+e).trim(),"%"),i=(e=e.replace(/[^0-9.,]/g,"")).lastIndexOf(","),r=e.lastIndexOf(".");r>=0&&i>=0&&r<i&&(t=","),(e.match(new RegExp("\\"+t,"g"))||[]).length>1&&(t=""),e=(e=e.replace(new RegExp("[^0-9"+t+"]","g"),"")).replace(",",".");var o=parseFloat(e);return n&&(o/=100),o}function q(e,t,n){if(t<10){var i=J(n),r=J(e);return function(e,t,n){if("number"!=typeof e||!("number"==typeof n||n instanceof Array))return!1;switch(t){case 0:return e===n;case 6:return e!==n;case 1:return e>n;case 2:return e<n;case 3:return e>=n;case 4:return e<=n;case 5:return e>=parseFloat(n[0])&&e<=parseFloat(n[1]);default:return!1}}(isNaN(r)?J(e.replace(/\./g,"").replace(/,/g,".")):r,t,n instanceof Array?n:isNaN(i)?J(n.replace(/\./g,"").replace(/,/g,".")):i)}return function(e,t,n){switch(e=e.toLowerCase(),n=n.toLowerCase(),t){case 12:return j(e,n);case 10:return F(e,n);case 16:return e===n;case 14:return V(e,n);case 13:return!j(e,n);case 11:return!F(e,n);case 17:return e!==n;case 15:return!V(e,n);case 18:return null!==e.match(n);default:return!1}}(e,t,n)}function $(e,t){return e=R(e),t?(e-R(t))/1e3:(Date.now()-e)/1e3}function H(e,t,n,i){void 0===i&&(i=!0);var r=0;switch(t){case 0:r=0;break;case 1:r=e.journey.length-1;break;case 2:n||(n=2),(e.journey.length>n||!1===i)&&(r=e.journey.length-n)}return e.journey[r]}function U(e,t,n){var i=0;switch(t){case 0:i=0;break;case 1:i=e.session.visits.length-1;break;case 2:n||(n=2),e.session.visits.length>n&&(i=e.session.visits.length-n)}return e.session.visits[i]}function B(e){return void 0===e?e:JSON.parse(JSON.stringify(e))}function G(e,t,n){e&&e[t]!==n&&(e[t]=n,e.dirty=!0)}function K(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function z(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}var Q=String.prototype.valueOf,X=Object.prototype.toString,Y="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag;function Z(e){return"string"==typeof e||"object"==typeof e&&(Y?function(e){try{return Q.call(e),!0}catch(e){return!1}}(e):"[object String]"===X.call(e))}var ee=Math.pow(2,53)-1;function te(e){return"function"==typeof e||"[object Function]"===X.call(e)}function ne(e){var t=function(e){var t=Number(e);if(isNaN(t))return 0;if(0===t||!isFinite(t))return t;return(t>0?1:-1)*Math.floor(Math.abs(t))}(e);return Math.min(Math.max(t,0),ee)}function ie(e,t,n){var i=arguments.length;if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var r=Object(e);if(i>1&&!te(t))throw new TypeError("Array.from: when provided, the second argument must be a function");for(var o,a=ne(r.length),s=te(Array)?Object(new Array(a)):new Array(a),c=0;c<a;)o=r[c],s[c]=t?i>2?t.call(n,o,c):t(o,c):o,c+=1;return s.length=a,s}function re(e){var t=new Set;if(null!=e)for(var n=0;n!==e.length;n++)t.add(e[n]);return t}function oe(){return window.innerHeight}function ae(){return window.innerWidth}function se(e){return t=e,!isNaN(parseFloat(t))&&isFinite(t)?e+"px":e;var t}var ce={top:se,bottom:se,left:se,right:se,height:se,width:se};function ue(e){var t=(e=e.toString()).indexOf("px");return t>0&&(e=Number(e.slice(0,t))),e}var le={top:ue,bottom:ue,left:ue,right:ue,height:ue,width:ue};function de(e,t){var n=ce[e];return n?n(t):t}function ge(e,t){var n=le[e];return n?n(t):t}function he(e){return getComputedStyle(e,null)}function fe(e){var t=ue(he(e).height);return""===t&&(t=e.getBoundingClientRect.height),t}function pe(e){var t=ue(he(e).width);return""===t&&(t=e.getBoundingClientRect.width),t}function ve(e){var t=he(e);if("none"==t.display)return!1;if("hidden"==t.visibility)return!1;var n=He(e);return!n||ve(n)}function me(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];if(0!==e.length){for(var n=e[0],i=1;i<e.length;i++){var r=e[i];if(null==n)return;n="function"==typeof r?r(n):n[r]}return n}}function we(){}var ye=new function(){var e,t,n;e=console,t=me(console,"log"),n=me(console,"error"),t||(e={},t=we),n||(n=t),this.log=function(){t.apply(e,arguments)},this.error=function(){n.apply(e,arguments)},this.suppressLogs=function(){this.log=we}};function be(e,t){for(var n=[],i=arguments.length-2;i-- >0;)n[i]=arguments[i+2];if(e&&void 0!==e.length)for(var r=0;r<e.length;r++){var o=e[r];t.apply(void 0,[o].concat(n))}else{var a=e;t.apply(void 0,[a].concat(n))}}function Se(e,t){for(var n=[],i=arguments.length-2;i-- >0;)n[i]=arguments[i+2];e&&void 0!==e.length&&e.length>0&&t.apply(void 0,[e[0]].concat(n))}function Ce(e){return document.getElementById(e)}function _e(e,t){try{return e.querySelectorAll(t)}catch(e){return ye.error("Encountered error trying to select dom element with selector: '"+t+"' : "+e.message),document.createDocumentFragment().childNodes}}function Ie(e,t){var n=e.length;if(t>=0){if(0===n)return e;if(0===t&&1===n)return e;if(n>t)return[e[t]]}return[]}function Ne(e){return function(e,t){for(var n=[],i=arguments.length-2;i-- >0;)n[i]=arguments[i+2];var r=[];return be(e,(function(e){t.apply(void 0,[e].concat(n))&&r.push(e)})),r}(e,ve)}function Ee(e){return function e(t,n){if(!n)return[];if(n.indexOf(",")>=0){var i=[];return n.split(",").forEach((function(n){i.push.apply(i,e(t,n.trim()))})),i}var r=n.match(/:(eq|first|last|visible)(\((\d+)\))?$/i);if(!r)return _e(t,n);var o=n.slice(0,r.index),a=r[1].toLowerCase();if("eq"==a){var s=r[3];return Ie(_e(t,o),s)}return"first"==a?Ie(_e(t,o),0):"last"==a?function(e){var t=e.length;return t>1?[e[t-1]]:e}(_e(t,o)):"visible"==a?Ne(_e(t,o)):void 0}(document,e)}function Oe(e){K(e,"remove")?e.remove():e.parentNode&&e.parentNode.removeChild(e)}function Te(e,t){e.innerHTML=t}function ke(e,t,n){e.insertAdjacentHTML(t,n)}function xe(e,t){ke(e,"afterbegin",t)}function Le(e,t){ke(e,"beforeend",t)}function We(e,t){!function(e,t){ke(e,"afterend",t)}(e,t),Oe(e)}function Me(e){be(e.childNodes,Oe)}function Ae(e,t){e.appendChild(t)}function De(e,t){e.childNodes.length>0?e.insertBefore(t,e.childNodes[0]):Ae(e,t)}function Re(e){e.focus()}function Pe(e){e.blur()}function je(e){return function e(t,n){return t===n||!!n.parentNode&&e(t,n.parentNode)}(e.ownerDocument,e)}function Ve(e,t){return e.tagName===t}function Fe(e,t){var n=e.classList;return null==n?-1!==function(e){var t=e.getAttribute("class");return null==t?[]:t.split(" ")}(e).indexOf(t):e.classList.contains(t)}function Je(e,t){return e.attributes&&null!==e.getAttribute(t)}var qe=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector;function $e(e,t){return qe.call(e,t)}function He(e){return void 0===e.parentElement?e.parentNode:e.parentElement}function Ue(e,t){return e.getAttribute(t)}function Be(e,t,n){e.setAttribute(t,n)}function Ge(e,t){e.removeAttribute(t)}function Ke(e,t,n){e.style[t]=de(t,n)}function ze(e,t){for(var n in t)Ke(e,n,t[n])}var Qe=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&je(e)&&"none"===he(e).display},Xe=function(){return null},Ye=function(){},Ze={};function et(e){var t,n=e.ownerDocument,i=e.nodeName,r=Ze[i];return r||(r=he(t=n.body.appendChild(n.createElement(i))).display,t.parentNode.removeChild(t),"none"===r&&(r="block"),Ze[i]=r,r)}function tt(e,t){for(var n,i,r=[],o=0,a=e.length;o<a;o++)(i=e[o]).style&&(n=i.style.display,t?("none"===n&&(r[o]=Xe(i,"display")||null,r[o]||(i.style.display="")),""===i.style.display&&Qe(i)&&(r[o]=et(i))):"none"!==n&&(r[o]="none",Ye(i,"display",n)));for(o=0;o<a;o++)null!=r[o]&&(e[o].style.display=r[o]);return e}function nt(e,t){if(void 0!==e.classList)e.classList.add(t);else if(!Fe(e,t)){var n,i=e.getAttribute("class");n=null!=i?i+" "+t:t,e.setAttribute("class",n)}}function it(e,t){if(void 0!==e.classList)e.classList.remove(t);else for(var n=!1;!n;){var i=e.getAttribute("class");if(null==i||0===i.length)return void(n=!0);for(var r=null,o=0,a=!1,s=t.length;!a;){var c=i.indexOf(t,o);if(-1===c)a=!0,n=!0;else{var u=c+s,l=u===i.length||" "===i[u],d=0===c||" "===i[c-1];if(l&&d){var g=i.substring(0,c-1),h=i.substring(u+1,i.length);r=0===g.length||0===h.length?g+h:g+" "+h,a=!0}else o=c+1}}null!==r&&e.setAttribute("class",r)}}function rt(e,t,n){e.addEventListener(t,n,!1)}function ot(e,t,n){e.addEventListener(t,n,{passive:!0})}function at(e,t,n){e.removeEventListener(t,n)}function st(e){for(var t=[],n=arguments.length-1;n-- >0;)t[n]=arguments[n+1];return function(n){if(n&&n.target)for(var i=n.target,r=n.currentTarget,o=i;null!==o&&!o.isEqualNode(r);){if(e.apply(void 0,[o].concat(t)))return[!0,o];o=He(o)}return[!1,null]}}function ct(e,t,n,i,r){var o=function(e){var t=n(e),o=t[0],a=t[1];o&&(null===a&&(a=this),!1===i.bind(a)(e)&&(e.stopPropagation(),r||e.preventDefault()))};return be(e,r?ot:rt,t,o),o}function ut(e,t,n){be(e,at,t,n)}function lt(e){return st(Fe,e)}function dt(e){return st(Ve,e.toUpperCase())}function gt(e){return st($e,e)}function ht(e){var t=arguments;if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),i=1;i<arguments.length;i++){var r=t[i];if(null!=r)for(var o in r)K(r,o)&&(n[o]=r[o])}return n}var ft=Object.prototype.propertyIsEnumerable;function pt(e){if(null==e)throw new TypeError("Sources cannot be null or undefined");return Object(e)}function vt(e,t,n){var i=t[n];if(null!=i)if(K(e,n)){if(void 0===e[n]||null===e[n])throw new TypeError("Cannot convert undefined or null to object ("+n+")");z(i)?e[n]=mt(Object(e[n]),i):e[n]=i}else z(i)?e[n]=mt(Object({}),i):e[n]=i}function mt(e,t){if(e===t)return e;for(var n in t=Object(t))K(t,n)&&vt(e,t,n);if(Object.getOwnPropertySymbols)for(var i=Object.getOwnPropertySymbols(t),r=0;r<i.length;r++)ft.call(t,i[r])&&vt(e,t,i[r]);return e}function wt(e){for(var t=[],n=!1,i=0;i!==e.length;i++){var r=e[i];"-"===r?n=!0:n?(t.push(r.toUpperCase()),n=!1):t.push(r)}return t.join("")}function yt(e){return encodeURIComponent(e)}var bt=Date.now()%1e9;function St(){var e="__stash_"+(1e9*Math.random()>>>0)+bt+++"__";this.set=function(t,n){var i=t[e];return i&&i[0]===t?i[1]=n:Object.defineProperty(t,e,{value:[t,n],writable:!0}),this},this.get=function(t){var n=t[e];return n&&n[0]===t?n[1]:void 0},this.delete=function(t){var n=t[e];if(!n)return!1;var i=n[0]===t;return n[0]=n[1]=void 0,i},this.has=function(t){var n=t[e];return!!n&&n[0]===t}}var Ct=!1||"undefined"==typeof WeakMap?new St:new WeakMap;function _t(e){var t;return Ct.has(e)?t=Ct.get(e):(t={},Ct.set(e,t)),t}function It(e,t,n){var i=_t(e),r=i[t];return i[t]=n,r}function Nt(e,t){return _t(e)[t]}function Et(e,t){delete _t(e)[t]}function Ot(e,t){var n=Nt(e,t);return void 0===n&&(n=Ue(e,"data-"+function(e){return e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}(t))),n}function Tt(e){for(var t=ht({},_t(e)),n=e.attributes,i=0;i<n.length;i++){var r=n.item(i);0===r.name.indexOf("data-")&&(t[wt(r.name.slice(5))]=r.value)}return t}var kt=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return setTimeout(e,1e3/60)},xt=window.cancelAnimationFrame||window.mozCancelAnimationFrame||function(e){clearTimeout(e)},Lt=function(){this.duration=300,this.aniCount=0,this.frameCount=0,this.timeCount=0,this.animations={},this.frames={},this.timeouts={}};Lt.prototype.count=function(){return this.aniCount+this.frameCount+this.timeCount},Lt.prototype.animationIds=function(){return Object.keys(this.animations)},Lt.prototype.frameIds=function(){return Object.keys(this.frames)},Lt.prototype.timeoutIds=function(){return Object.keys(this.timeouts)};var Wt=new Lt;function Mt(e){!function(e,t){var n=Nt(e,"_animations");void 0===n?It(e,"_animations",[t]):n.push(t)}(e.element,e.id),Wt.animations[e.id]=e,Wt.aniCount+=1}function At(e){Wt.frames[e]&&(Wt.frameCount-=1,delete Wt.frames[e])}function Dt(e){Wt.timeouts[e]&&(Wt.timeCount-=1,delete Wt.timeouts[e])}function Rt(e){!function(e,t){var n=Nt(e,"_animations");if(void 0!==n){var i=n.indexOf(t);0===i?Et(e,"_animations"):i>=0&&n.splice(i,1)}}(e.element,e.id),function(e){Wt.animations[e.id]&&(delete Wt.animations[e.id],Wt.aniCount-=1)}(e),e.curAniFrame&&(qt(e.curAniFrame),e.curAniFrame=!1),e.doneTimeout&&(Dt(e.doneTimeout),window.clearTimeout(e.doneTimeout),e.doneTimeout=!1)}var Pt=0,jt=function(e,t,n,i){Pt+=1,this.id=Pt,this.element=e,this.duration=t,this.doneHandler=n,this.label=i,this.startTime=null,this.doneTimeout=!1,this.curAniFrame=!1,this.animator=null,this.doneFunction=null};function Vt(e,t){var n=Nt(e,"_animations");if(n&&n.length){n=ie(n);for(var i=0;i<n.length;i++){var r=Wt.animations[n[i]];r&&(t?r.done():r.cancel())}}Et(e,"_animations")}function Ft(e,t,n){var i=he(e),r={};for(var o in t)r[o]=Number(ge(o,i[o]));var a=(n=n||{}).duration||Wt.duration,s=n.label||"css.animate",c=new jt(e,a,n.done,s);c.animator=function(e){this.curAniFrame=!1,this.startTime||(this.startTime=e);var n=e-this.startTime,i=n>=a?1:n/a,o={};for(var s in t){var c=Number(ge(s,t[s]))-r[s];o[s]=de(s,r[s]+c*i)}ze(this.element,o),n>=this.duration?this.done():this.curAniFrame=Jt(this.animator,this.label)}.bind(c),a>0?(c.curAniFrame=Jt(c.animator,c.label),c.doneTimeout=window.setTimeout(function(){Dt(c.doneTimeout),c.doneTimeout=!1,Rt(c);var e=Date.now();c.startTime=e-a,c.animator(e)}.bind(c),a),function(e,t){Wt.timeCount+=1,Wt.timeouts[e]=t||"unknown"}(c.doneTimeout,c.label),Mt(c)):c.animator(Date.now())}function Jt(e,t){var n=kt((function(t){At(n),e(t)}));return function(e,t){Wt.frameCount+=1,Wt.frames[e]=t||"unknown"}(n,t),n}function qt(e){e&&(At(e),xt(e))}jt.prototype.finish=function(){if(Rt(this),this.animator){var e=Date.now();this.startTime=e-this.duration,this.animator(e)}},jt.prototype.done=function(){if(Rt(this),this.doneHandler)try{this.doneHandler.call(this.element)}catch(e){ye.error("ERROR in animation done handler",e)}},jt.prototype.cancel=function(){Rt(this)};var $t=null;function Ht(e){null===$t&&($t=document.createElement("DIV")),xe($t,e);var t=ie($t.childNodes);return be(t,Oe),t}var Ut=function(e){this.length=0,null==e||("string"==typeof e?e.length>0&&("<"===e.charAt(0)?this.pushAll(Ht(e)):this.pushAll(_e(document,e))):void 0!==e.length?this.pushAll(e):this.push(e))};function Bt(e){return new Ut(e)}function Gt(e,t){Object.defineProperty(this,"name",{enumerable:!1,writable:!1,value:"AJAXError"}),Object.defineProperty(this,"message",{enumerable:!1,writable:!0,value:e.statusText}),Object.defineProperty(this,"elapsed",{enumerable:!1,writable:!0,value:t}),Object.defineProperty(this,"request",{enumerable:!1,writable:!0,value:e}),K(Error,"captureStackTrace")?Error.captureStackTrace(this,Gt):Object.defineProperty(this,"stack",{enumerable:!1,writable:!1,value:new Error(e.statusText).stack})}Ut.prototype.push=function(e){return e&&1===e.nodeType&&(this[this.length]=e,this.length+=1),this},Ut.prototype.pushAll=function(e){for(var t=0;t<e.length;t++)this.push(e[t]);return this},Ut.prototype.each=function(e){for(var t=[],n=arguments.length-1;n-- >0;)t[n]=arguments[n+1];return be.apply(void 0,[this,e].concat(t)),this},Ut.prototype.hasClass=function(e){return this.length>0&&Fe(this[0],e)},Ut.prototype.attr=function(e,t){var n=arguments.length;if(2===n)be(this,Be,e,t);else if(1===n){var i=this.length>0?Ue(this[0],e):null;return null!==i?i:void 0}return this},Ut.prototype.removeAttr=function(e){return be(this,Ge,e),this},Ut.prototype.data=function(e,t){var n=arguments.length;if(2===n)be(this,It,e,t);else{if(1===n)return 0===this.length?void 0:Ot(this[0],e);if(0===n)return 0===this.length?void 0:Tt(this[0])}return this},Ut.prototype.addClass=function(e){return be(this,nt,e),this},Ut.prototype.removeClass=function(e){return be(this,it,e),this},Ut.prototype.on=function(e,t,n){var i=this,r=arguments.length;return 2===r&&"string"==typeof e&&"function"==typeof t&&e.split(" ").forEach((function(e){e&&be(i,rt,e,t)})),3===r&&"string"==typeof e&&"string"==typeof t&&"function"==typeof n&&ct(this,e,gt(t),n,!1),this},Ut.prototype.onPassive=function(e,t,n){var i=arguments.length;return 2===i&&"string"==typeof e&&"function"==typeof t&&be(this,ot,e,t),3===i&&"string"==typeof e&&"string"==typeof t&&"function"==typeof n&&ct(this,e,gt(t),n,!0),this},Ut.prototype.css=function(e,t){var n=arguments.length;if(n>0){var i=typeof e;if(1===n){if("string"===i)return this.length>0?he(this[0])[wt(e)]:null;if(Array.isArray(e)){for(var r={},o=he(this[0]),a=0;a<e.length;a++){var s=e[a];r[s]=o[s]}return r}"object"===i&&be(this,ze,e)}if(2===n&&"string"==typeof e){var c=wt(e);be(this,Ke,c,t)}}return this},Ut.prototype.append=function(e){return"string"==typeof e?be(this,Le,e):e instanceof Element&&Se(this,Ae,e),this},Ut.prototype.replaceWith=function(e){return be(this,We,e),this},Ut.prototype.prepend=function(e){return"string"==typeof e?be(this,xe,e):e instanceof Element&&Se(this,De,e),this},Ut.prototype.empty=function(){return be(this,Me),this},Ut.prototype.appendTo=function(e){return e instanceof Ut&&e.length>0&&(e=e[0]),be(this,(function(t){Ae(e,t)})),this},Ut.prototype.html=function(e){return be(this,Te,e),this},Ut.prototype.val=function(){return this.length>0?this[0].value||null:void 0},Ut.prototype.text=function(e){var t=arguments.length;if(0===t){var n=[];return be(this,(function(e){e.textContent&&n.push(e.textContent)})),n.join("")}return 1===t&&this.length>0&&(this[0].textContent=e),this},Ut.prototype.prependHtml=function(e){return be(this,xe,e),this},Ut.prototype.remove=function(){return be(this,Oe),this},Ut.prototype.find=function(e){var t=new Ut;return be(this,(function(n){t.pushAll(_e(n,e))})),t},Ut.prototype.closest=function(e){var t=new Ut;return be(this,(function(n){t.push(function(e,t){if(Element.prototype.closest)return e.closest(t);var n=e;do{if($e(n,t))return n;n=n.parentNode}while(null!==n&&1===n.nodeType);return null}(n,e))})),t},Ut.prototype.first=function(){var e=new Ut;return this.length>0&&e.push(this[0]),e},Ut.prototype.parent=function(){var e=new Ut;return this.length>0&&e.push(this[0].parentNode),e},Ut.prototype.children=function(e){var t=new Ut;return be(this,(function(e){var n=e.childNodes;t.pushAll(n)})),e&&(t=t.filter(e)),t},Ut.prototype.index=function(){return this.length>0?function(e){var t=e.parentNode.childNodes,n=0;for(n=0;n<t.length;n++)if(t[n]===e)return n;return-1}(this[0]):0},Ut.prototype.filter=function(e){var t=new Ut;return be(this,(function(n){$e(n,e)&&t.push(n)})),t},Ut.prototype.not=function(e){var t=new Ut;if("string"==typeof e)be(this,(function(n){$e(n,e)||t.push(n)}));else if(e instanceof Ut){var n=e.length;be(this,(function(i){for(var r=!1,o=0;o<n&&!r;o++)r=i===e[o];r||t.push(i)}))}return t},Ut.prototype.animate=function(e,t){return Se(this,Ft,e,t),this},Ut.prototype.stop=function(e,t){return be(this,Vt,t),this},Ut.prototype.show=function(){return tt(this,!0),this},Ut.prototype.hide=function(){return tt(this,!1),this},Ut.prototype.focus=function(){return Se(this,Re),this},Ut.prototype.blur=function(){return Se(this,Pe),this},Ut.prototype.height=function(e){return 0===arguments.length?this.length>0?fe(this[0]):0:(be(this,ze,{height:e+"px"}),this)},Ut.prototype.width=function(e){return 0===arguments.length?this.length>0?pe(this[0]):0:(be(this,ze,{width:e+"px"}),this)},Ut.prototype.sort=function(e){var t=ie(this);t.sort(e);for(var n=0;n<this.length;n++)this[n]=t[n];return this},Ut.prototype.detach=function(){return be(this,Oe),this},"function"==typeof Object.setPrototypeOf?Object.setPrototypeOf(Gt.prototype,Error.prototype):Gt.prototype=Object.create(Error.prototype,{constructor:{value:Gt}});function Kt(){var e={},t={};var n={retainFor:1e4,timeout:2e4};this.retainFor=function(e){return(e=Number(e))>=0&&(n.retainFor=e),n.retainFor},this.timeout=function(e){return(e=Number(e))>=0&&(n.timeout=e),n.timeout},this.urls=function(){return Object.keys(e)},this.get=function(i,r){r=function(e,t){return t?ht({},e,t):e}(n,r);var o=e[i];if(!o){var a={url:i,method:"GET"};r.crossDomain&&(a.crossDomain=r.crossDomain),r.contentType&&(a.contentType=r.contentType),void 0!==r.data&&(a.data=r.data),r.dataType&&(a.dataType=r.dataType),r.headers&&(a.headers=r.headers);var s=function(){!function(n,i){e[n]===i&&(delete e[n],t[n]&&(clearTimeout(t[n]),delete t[n]))}(i,o)},c=new XMLHttpRequest;if(o=new A((function(e,t){var n=Date.now();c.open("GET",i,!0),r.crossDomain&&(c.withCredentials=!0),c.setRequestHeader("Accept","application/json");var o=!1;r.timeout&&r.timeout>=0&&(c.addEventListener("loadstart",(function(){o=setTimeout((function(){o=!1,c.abort(),t(new Error("Operation timed out"))}),r.timeout)})),c.addEventListener("loadend",(function(){o&&clearTimeout(o)}))),c.addEventListener("load",(function(){c.status>=200&&c.status<400?e(JSON.parse(c.response)):t(new Gt(c,Date.now()-n))})),c.addEventListener("error",(function(){t(new Gt(c,Date.now()-n))})),c.send()})),e[i]=o,r.retainFor>0){var u=setTimeout(s,r.retainFor);t[i]=u}o.catch((function(){return s(),null}))}return o},this.remove=function(n){delete e[n],t[n]&&(clearTimeout(t[n]),delete t[n])},this.set=function(t,n){e[t]=A.resolve(n)},this.clear=function(){for(var n in t)clearTimeout(t[n]);e={},t={}}}var zt="function"==typeof CustomEvent?function(e,t){return new CustomEvent(e,{detail:t})}:function(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n};function Qt(e,t,n){var i=zt("GoMoxie:"+e,t);return i.version=n,i}var Xt={kb:1,chat:2,email:3,kbot:2,link:4},Yt={_blank:1,_self:2};function Zt(e){var t=e.userAgent;return t.match(/GoogleTV|SmartTV|Internet.TV|NetCast|NETTV|AppleTV|boxee|Kylo|Roku|DLNADOC|CE-HTML/i)?"Desktop":t.match(/Xbox|PLAYSTATION.3|Wii/i)?"Desktop":t.match(/Windows.(NT|XP|ME|9)/)&&!t.match(/Phone/i)||t.match(/Win(9|.9|NT)/i)?"Desktop":t.match(/iPad/i)||t.match(/tablet/i)&&!t.match(/RX-34/i)||t.match(/FOLIO/i)?"Tablet":t.match(/Linux/i)&&t.match(/Android/i)&&!t.match(/Fennec|mobi|HTC.Magic|HTCX06HT|Nexus.One|SC-02B|fone.945/i)?"Tablet":t.match(/Kindle/i)||t.match(/Mac.OS/i)&&t.match(/Silk/i)?"Tablet":t.match(/GT-P10|SC-01C|SHW-M180S|SGH-T849|SCH-I800|SHW-M180L|SPH-P100|SGH-I987|zt180|HTC(.Flyer|_Flyer)|Sprint.ATP51|ViewPad7|pandigital(sprnova|nova)|Ideos.S7|Dell.Streak.7|Advent.Vega|A101IT|A70BHT|MID7015|Next2|nook/i)||t.match(/MB511/i)&&t.match(/RUTEM/i)?"Tablet":t.match(/BOLT|Fennec|Iris|Maemo|Minimo|Mobi|mowser|NetFront|Novarra|Prism|RX-34|Skyfire|Tear|XV6875|XV6975|Google.Wireless.Transcoder/i)?"Mobile":t.match(/Opera/i)&&t.match(/Windows.NT.5/i)&&t.match(/HTC|Xda|Mini|Vario|SAMSUNG-GT-i8000|SAMSUNG-SGH-i9/i)?"Mobile":t.match(/Macintosh|PowerPC/i)&&!t.match(/Silk/i)?"Desktop":t.match(/Linux/i)&&t.match(/X11/i)?"Desktop":t.match(/Solaris|SunOS|BSD/i)?"Desktop":t.match(/Bot|Crawler|Spider|Yahoo|ia_archiver|Covario-IDS|findlinks|DataparkSearch|larbin|Mediapartners-Google|NG-Search|Snappy|Teoma|Jeeves|TinEye/i)&&!t.match(/Mobile/i)?"Desktop":t.match(/CrOS/i)?"Desktop":"Mobile"}function en(e){return function(){try{return e.apply(this,arguments)}catch(e){ye.error(e)}}}function tn(e,t){var n,i,r,o,a;if(e&&e.rulesEngine&&e.rulesEngine.siteRules&&e.rulesEngine.siteRules.rules)e:for(i=0;i<e.rulesEngine.siteRules.rules.length;i++)if((r=e.rulesEngine.siteRules.rules[i]).id===t){if(r.action&&r.action.success)for(o=0;o<r.action.success.length;o++)if((a=r.action.success[o]).parameters&&a.parameters.rule&&a.parameters.rule.id===t){n=o;break e}break}return n}function nn(e,t){return e.widgetManager.engagementWidgets.widgets[t]}function rn(e){var t=null,n=e.contextMonitor.getLastDevice();if(n)switch(n){case"Desktop":t=1;break;case"Tablet":t=2;break;case"Mobile":t=3}var i={};return i.d=Date.now(),i.u=function(e){return e.cacheManager.getVisitorProfileId()}(e),i.w=t,i.W=1,i.p=e.url,i.q=e.pageTitle,i.v="v1.22.0",i.$="1.1",i["@"]=e.cacheManager.makeEventSerialNumber(),i}function on(e,t,n,i){var r=rn(e);return r.t=t,r.z=Xt[n],r.r=i.id,r.i=1,r.o=e.currentOfferCreatedAt.toString(),r}function an(e,t){e.logDisabled||(ye.log("Events.sendToEventService:",t),e.eventService.notifyEventService(t))}function sn(e,t){e.logDisabled||(ye.log("Events.sendToEventServiceImmediately:",t),e.eventService.notifyEventServiceImmediately(t))}function cn(e,t,n){var i=function(e,t){var n=nn(e,t);return n&&n.widgetParameters&&n.widgetParameters.rule?n.widgetParameters.rule.id:null}(e,n);if(i){t.r=i;var r=tn(e,i);void 0!==r&&(t.i=r),t.x=function(e,t){var n=nn(e,t),i=2;return n&&n.proactive&&(i=1),i}(e,n)}return t}var un=en((function(e,t,n,i,r,o,a,s){var c=rn(e);c.t=t?10:9,i&&(c.a=i.toString()),r&&(c.A=r),o&&(c.S=o.toString()),void 0!==a&&(c.f=a),s&&(c["!"]=s.toString()),an(e,c=cn(e,c,n))})),ln=en((function(e,t,n,i,r,o){var a=rn(e);a.t=t?17:18,void 0!==i&&(a.S=i.toString()),a=cn(e,a,n),void 0!==r&&(a.f=r),void 0!==o&&(a["!"]=o.toString()),an(e,a)})),dn=en((function(e,t,n,i){var r=rn(e);r.t=11,void 0!==n&&(r.k=n),void 0!==i&&(r.K=i),(r=cn(e,r,t)).z=Xt[t],an(e,r)})),gn=en((function(e,t,n,i,r,o,a){var s=rn(e);s.t=33,void 0!==n&&(s.k=n),void 0!==i&&(s.K=i),void 0!==r&&(s.Q=r),void 0!==o&&(s.j=o),void 0!==a&&(s["+"]=a),(s=cn(e,s,t)).z=Xt[t],sn(e,s)})),hn=en((function(e,t,n,i,r,o,a,s){var c=rn(e);c.t=34,void 0!==n&&(c.k=n),void 0!==i&&(c.K=i),void 0!==r&&(c.Q=r),void 0!==o&&(c.j=o),void 0!==a&&(c["+"]=a),void 0!==s&&(c.m=s),(c=cn(e,c,t)).z=Xt[t],sn(e,c)})),fn=en((function(e,t,n){var i=rn(e);i.t=12,n&&(i.E=parseInt(n,10)),an(e,i=cn(e,i,t))})),pn=en((function(e,t,n){var i=rn(e);return i.t=99,void 0!==n&&(i.I=n),i.V=parseFloat(t),sn(e,i),i})),vn=en((function(e,t,n){var i=rn(e);return i.t=5,i.V=parseFloat(t),void 0!==n&&(i.F=n),an(e,i),i})),mn=en((function(e,t,n){var i=on(e,21,t,n);return an(e,i),i})),wn=en((function(e,t,n){var i=on(e,22,t,n);return i["Δ"]=Date.now()-e.currentOfferCreatedAt,an(e,i),i})),yn=en((function(e,t,n){var i=on(e,23,t,n);return i["Δ"]=Date.now()-e.currentOfferCreatedAt,an(e,i),i})),bn=en((function(e,t,n,i,r){var o=rn(e);if(o.t=15,void 0!==n&&(o.Q=n),i&&(o.h=parseInt(i,10)),r){o.H=[];for(var a=0;a<r.length;a++){var s={};s.k=r[a].articleId,s.K=r[a].articleTitle,o.H.push(s)}}an(e,o)})),Sn=en((function(e,t,n,i){var r=rn(e);r.t=16,r=cn(e,r,t),void 0!==n&&(r.f=n),i&&(r["!"]=i.toString()),an(e,r)})),Cn=en((function(e,t,n,i,r){if(i){var o=rn(e);switch(t){case"service-line-closed":o.t=25;break;case"no-agent-available":o.t=26;break;case"wait-too-long":o.t=27}if(n&&(o["!"]=n.toString()),void 0!==i){o.r=i;var a=tn(e,i);void 0!==a&&(o.i=a)}o.x="proactive"===r?1:2,an(e,o)}})),_n=en((function(e,t,n){var i=rn(e);if(t){if(i.t=31,i=cn(e,i,n),void 0!==n){if(void 0===Xt[n])return;i.z=Xt[n]}}else i.t=30;an(e,i)})),In=en((function(e){var t=rn(e);t.t=1;var n=e.contextMonitor.getLastBrowseInfo().name;n&&(t.B=n),an(e,t)})),Nn=en((function(e){var t=rn(e);t.t=2,t.U=window.navigator.userAgent;var n=e.contextMonitor.getLastBrowseInfo().version;n&&(t.b=n);var i=e.contextMonitor.getLastLocation()||{};t.l=i.latitude,t.L=i.longitude,t.C=i.city,t.T=i.state,t.Y=i.country,an(e,t)})),En=en((function(e){var t=rn(e);t.t=3,an(e,t)})),On=en((function(e,t){var n=rn(e);n.t=6,n.D=JSON.stringify(t),an(e,n)})),Tn=en((function(e,t,n,i,r){var o=rn(t);o.t=e?13:14,o.G=n,o.r=i,o.i=r,an(t,o)})),kn=en((function(e,t,n,i,r,o){var a=rn(e);a.t=20,a.r=t,a.i=n,i&&(a["!"]=i.toString()),r&&(a.z=Xt[r]),a.x="proactive"===o?1:2,an(e,a)})),xn=en((function(e,t,n,i){var r=rn(e);r.t=32,r.r=i,r["^"]=Yt[n],r["&"]=t,r.z=Xt.link,r.x=1,"_self"===n?sn(e,r):an(e,r)}));function Ln(e,t){var n=new Qt(e,t,"1.0");return setTimeout((function(){try{window.dispatchEvent(n)}catch(t){ye.log("PublicAPI.broadcast("+e+"): error: "+(t.stack?t.stack:t.message))}})),n}function Wn(e,t,n){var i,r,o,a,s,c,u;if(c={cartValue:!1,cartItems:!1},!t||!function(e){return!!(e&&e.session&&e.session.visits&&e.session.visits.length>=1)}(e))return e;if(a=e.session.visits.length-1,o=e.session.visits[a].journey.length-1,void 0!==t.currentCartValue&&(r=Number(t.currentCartValue),isNaN(r)||(e.session.visits[a].journey[o].current_cart_value=r,c.cartValue=r)),void 0!==t.currentCartItems&&(i=(u=t.currentCartItems)&&u.length>0?u.filter((function(e){if("name"in e&&""!==e.name||"sku_or_id"in e&&""!==e.sku_or_id)return!0})):[],e.session.visits[a].journey[o].current_cart_items=i,c.cartItems=i),void 0!==t.transactionTotal&&(s=Number(t.transactionTotal),isNaN(s)||(e.session.end_cart_value=s)),e.last_updated=Date.now(),c.cartValue||c.cartItems){var l=c.cartValue||r,d=c.cartItems||i;Ln("cartUpdated",{cartValue:l,cartItems:d}),vn(n,l,d)}return e}function Mn(e){return-1!==["link"].indexOf(e)}var An="MoxieCache_visitorProfile_lastUpdated",Dn={chat:1,kb:2,email:3,kbot:4};function Rn(e,t){return new A((function(n,i){n(void 0===t?e():e.call(t))}))}function Pn(e){return function(){var t=this,n=[].slice.call(arguments,0);return new A((function(i){i(e.apply(t,n))}))}}function jn(e){try{var t=window[e],n="__test__";return t.setItem(n,n),t.removeItem(n),!0}catch(e){return!1}}var Vn=new Array(16);for(var Fn,Jn,qn=[],$n=0;$n<256;++$n)qn[$n]=($n+256).toString(16).substr(1);var Hn=0,Un=0;function Bn(e,t,n){var i=t&&n||0,r=t||[],o=(e=e||{}).node||Fn,a=void 0!==e.clockseq?e.clockseq:Jn;if(null==o||null==a){var s=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),Vn[t]=e>>>((3&t)<<3)&255;return Vn}();null==o&&(o=Fn=[1|s[0],s[1],s[2],s[3],s[4],s[5]]),null==a&&(a=Jn=16383&(s[6]<<8|s[7]))}var c=void 0!==e.msecs?e.msecs:(new Date).getTime(),u=void 0!==e.nsecs?e.nsecs:Un+1,l=c-Hn+(u-Un)/1e4;if(l<0&&void 0===e.clockseq&&(a=a+1&16383),(l<0||c>Hn)&&void 0===e.nsecs&&(u=0),u>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");Hn=c,Un=u,Jn=a;var d=(1e4*(268435455&(c+=122192928e5))+u)%4294967296;r[i++]=d>>>24&255,r[i++]=d>>>16&255,r[i++]=d>>>8&255,r[i++]=255&d;var g=c/4294967296*1e4&268435455;r[i++]=g>>>8&255,r[i++]=255&g,r[i++]=g>>>24&15|16,r[i++]=g>>>16&255,r[i++]=a>>>8|128,r[i++]=255&a;for(var h=0;h<6;++h)r[i+h]=o[h];return t||function(e,t){var n=t||0,i=qn;return[i[e[n++]],i[e[n++]],i[e[n++]],i[e[n++]],"-",i[e[n++]],i[e[n++]],"-",i[e[n++]],i[e[n++]],"-",i[e[n++]],i[e[n++]],"-",i[e[n++]],i[e[n++]],i[e[n++]],i[e[n++]],i[e[n++]],i[e[n++]]].join("")}(r)}function Gn(e){return!0===e?"p":"s"}function Kn(e){return JSON.stringify(e)}function zn(e){if(void 0!==e)try{return JSON.parse(e)}catch(t){return e}}var Qn=function(){this.name="DefaultStoragePlugin",this.data={p:{},s:{}}};Qn.prototype.destroy=function(){},Qn.prototype.clear=function(){this.data.p={},this.data.s={}},Qn.prototype.has=function(e,t){return K(this.data[Gn(t)],e)},Qn.prototype.set=function(e,t,n){this.data[Gn(n)][e]=t},Qn.prototype.del=function(e,t){delete this.data[Gn(t)][e]},Qn.prototype.get=function(e,t){var n=Gn(t);return K(this.data[n],e)?zn(this.data[n][e]):null},Qn.prototype.removeKeysOtherThan=function(e,t){var n;n=t?this.data.p:this.data.s;var i=Object.keys(n);if(0!==i.length)for(var r=re(e),o=0;o!==i.length;o++){var a=i[o];r.has(a)||delete n[a]}};var Xn=["rules_version","uuid","widgets_version"],Yn=["chat-","conclient_","email-","kbot-","kb-","MoxieCache_","moxie"];function Zn(e){if(P(Xn,e,0)>=0)return!0;for(var t=0;t<Yn.length;t++)if(0===e.indexOf(Yn[t]))return!0;return!1}function ei(e){var t,n,i=[];for(n=0;n<e.length;n++)Zn(t=e.key(n))&&i.push(t);for(n=0;n<i.length;n++)e.removeItem(i[n])}function ti(e,t){t=re(t);var n,i,r=function(e){var t,n,i=[];for(n=0;n!==e.length;n++)Zn(t=e.key(n))&&i.push(t);return i}(e),o=[];for(i=0;i!==r.length;i++)n=r[i],t.has(n)||o.push(n);return o}var ni=function(e){this.parentStorage=e,this.name="LocalStorageStoragePlugin",this.skip=["Rules","engagementWidgets"]};ni.prototype.destroy=function(){this.parentStorage.destroy()},ni.prototype.has=function(e,t){return!!this.parentStorage.has(e,t)||(!0===t?null!==localStorage.getItem(e):null!==sessionStorage.getItem(e))},ni.prototype.set=function(e,t,n){if(this.parentStorage.set(e,t,n),!(P(this.skip,e)>=0))if(!0===n)try{localStorage.setItem(e,Kn(t))}catch(t){ye.log("Error setting "+e+": "+t)}else try{sessionStorage.setItem(e,Kn(t))}catch(t){ye.log("Error setting "+e+": "+t)}},ni.prototype.get=function(e,t){if(this.parentStorage.has(e,t))return this.parentStorage.get(e,t);var n=!0===t?localStorage.getItem(e):sessionStorage.getItem(e);return null!==n&&(n=zn(n)),n},ni.prototype.del=function(e,t){this.parentStorage.del(e,t),!0===t?localStorage.removeItem(e):sessionStorage.removeItem(e)},ni.prototype.clear=function(){this.parentStorage.clear(),ei(localStorage),ei(sessionStorage)},ni.prototype.removeKeysOtherThan=function(e,t){var n;this.parentStorage.removeKeysOtherThan(e,t);for(var i=ti(n=t?localStorage:sessionStorage,e),r=0;r!==i.length;r++){var o=i[r];n.removeItem(o)}};var ii="moxie=".length,ri="!--moxie".length,oi=window.top||window;function ai(e){var t="",n="",i=e.indexOf("moxie=");if(i>=0){i>0&&(t=e.slice(0,i));var r=e.indexOf("!--moxie",i+ii);r>=0?(n=e.slice(i+ii,r),t+=e.slice(r+ri)):n=e.slice("moxie=".length)}return[t,n]}function si(e){var t=ai(oi.name||"");oi.name=t[0]+"moxie="+JSON.stringify(e)+"!--moxie"}var ci=function(e,t){this.name="WindowNameStoragePlugin",this.parentStorage=e,this.clientName=t.clientName,this._data=function(e){var t=ai(oi.name||"")[1],n={};if(t.length>0)try{n=JSON.parse(t)}catch(e){ye.log("JSON: unable to parse window.name value:",t)}return n[e]||(n[e]={p:{},s:{}}),n}(this.clientName);var n,i=this;this.saveItListener||(this.saveItListener=function(){si(i._data)},oi.addEventListener("unload",this.saveItListener,!1));var r=i._data[this.clientName];for(n in r.p)e.set(n,r.p[n],!0);for(n in r.s)e.set(n,r.s[n],!1)};function ui(e){var t=e.widgetManager,n=e.cacheManager;return e._clearingHistoryPromise||(e._clearingHistoryPromise=A.resolve(!0).then((function(){return e.contextMonitor.stop(),t.clearHistory().then((function(){t.destroy()})).then((function(){var t=e.eventService;return e.eventService={clearHistoryStub:!0,notifyEventServiceImmediately:function(){},notifyEventService:function(){}},A.resolve(t.stopEventService())})).then((function(){return A.resolve(n.storagePlugin.clear()).then((function(){n.destroy(),e.cacheManager=null}))})).catch((function(e){throw ye.log("History.clearHistory received an error:",e),e}))}))),e._clearingHistoryPromise}function li(e){var t=e.userAgent.toString().toLowerCase(),n=e.appName,i=/(dolfin)[ /]([\w.]+)/.exec(t)||/(javafx)[/]([\w.]+)/.exec(t)||/(chrome)[ /]([\w.]+)/.exec(t)||/(opera)(?:.*version)?[ /]([\w.]+)/.exec(t)||/(webkit)(?:.*version)?[ /]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+))?/.exec(t)||["","unknown"];return"webkit"===i[1]?i=/fbav|instagram/.test(t)&&/(iphone|ipad|ipod)/.test(t)?[i[0],"safari",i[2]]:/(iphone|ipad|ipod)\/?\s*(\.?\d+(\.\d+)*)/.exec(t)||/(android)[ /]([\w._-]+);/.exec(t)||[i[0],"safari",i[2]]:"mozilla"===i[1]?/trident/.test(t)?i[1]="MSIE":i[1]="firefox":/polaris|natebrowser|([010|011|016|017|018|019]{3}\d{3,4}\d{4}$)/.test(t)&&(i[1]="Polaris"),[i[1].toLowerCase(),"unknown"===i[2]?[n,window.navigator.appVersion,"-?"]:i[2]]}ci.prototype.destroy=function(){this.parentStorage.destroy(),this.saveItListener&&(oi.removeEventListener("unload",this.saveItListener),delete this.saveItListener)},ci.prototype.has=function(e,t){return this.parentStorage.has(e,t)},ci.prototype.set=function(e,t,n){if(this.parentStorage.set(e,t,n),!this.skipSaveForKey||!this.skipSaveForKey(e)){var i=!1;!0===n?(this._data[this.clientName].p[e]!==t&&(i=!0),this._data[this.clientName].p[e]=t):(this._data[this.clientName].s[e]!==t&&(i=!0),this._data[this.clientName].s[e]=t),i&&si(this._data)}},ci.prototype.get=function(e,t){var n=!0===t?this._data[this.clientName].p[e]:this._data[this.clientName].s[e];if(void 0!==n)try{return JSON.parse(n)}catch(e){return n}return this.parentStorage.has(e,t)?(n=this.parentStorage.get(e,t),this.skipSaveForKey&&this.skipSaveForKey(e)?n:(!0===t?this._data[this.clientName].p[e]=n:this._data[this.clientName].s[e]=n,si(this._data),n)):null},ci.prototype.del=function(e,t){this.parentStorage.del(e,t),!0===t?delete this._data[this.clientName].p[e]:delete this._data[this.clientName].s[e],si(this._data)},ci.prototype.clear=function(){this.parentStorage.clear(),this._data[this.clientName].p={},this._data[this.clientName].s={},si(this._data)};var di={},gi=0,hi={},fi=0,pi={},vi={};var mi=!1;function wi(){mi||(ye.error("Double load of concierge suspected"),mi=!0)}function yi(e,t){var n=++fi;return t.bridgeName="storage_bridge",t.requesterId=e.id,t.requestId=n,t.client=e.concierge.clientName,t.signature="moxie_concierge",e&&e.ifrm&&e.ifrm.contentWindow&&e.ifrm.contentWindow.postMessage?(e.ifrm.contentWindow.postMessage(JSON.stringify(t),"*"),new A((function(e,i){var r=setTimeout((function(){r=!1,i(new Error("TIMEOUT waiting for shared storage."))}),2e3),o=function(){r&&(clearTimeout(r),r=!1)};pi[n]={message:t,resolve:function(t){o(),e(t)},reject:function(e){o(),i(e)}}})).finally((function(){delete pi[n]}))):(wi(),A.resolve(!0))}function bi(e,t){this.useSharedStorage=!1,this.parentStorage=e,this.concierge=t,this.scriptLocation=t.scriptLocation,this.created=Date.now(),this.sharedStorageId=function(e){var t=hi[e];return t||(t="concierge-shared-storage",++gi>1&&(t=t+"-"+gi),hi[e]=t),t}(this.scriptLocation),this.id=Date.now()}function Si(e){this.name="InvalidArgumentException",this.message=e,this.toString=function(){return this.name+": "+this.message}}function Ci(e){return V(e,"_file")&&e.indexOf("profileJSON")<0||"Rules"===e||"engagementWidgets"===e}function _i(e,t,n,i){return A.resolve(e.storagePlugin.set(t,n,i))}bi.prototype.destroy=function(e){e&&this.parentStorage.destroy(),this.ifrm.remove(),this.removeListener?(this.removeListener(),delete this.ifrm):wi()},bi.prototype.init=function(){var e=this;if(di[this.id]=this,this.data={p:{},s:{}},e.ifrm=Ce(e.sharedStorageId),!e.ifrm){e.ifrm=document.createElement("iframe"),e.ifrm.setAttribute("id",e.sharedStorageId),e.ifrm.setAttribute("tabindex","-1");var t=e.scriptLocation+"/client/storage_bridge.html";e.ifrm.setAttribute("src",t);var n=function(t){if("."===e.scriptLocation||0===e.scriptLocation.indexOf(t.origin)){var n={};try{n="string"==typeof t.data?JSON.parse(t.data):t.data}catch(e){}if(n&&"storage_bridge"===n.bridgeName){var i,r,o,a=e;if(n.requesterId&&di[n.requesterId]&&(a=di[n.requesterId]),n.requesterId===a.id)n.error?(i=n.requestId,r=new Error("Error from shared storage: "+n.error.message),(o=pi[i])?o.reject(r):ye.log("SharedStorageBridge: rejectRequest("+i+", "+JSON.stringify(r)+") cannot find outstanding request")):"updated"===n.request?(ye.log("CONCIERGE StoragePlugin update: ",n),"moxie_cc"!==n.key||n.newValue||ui(e.concierge).catch((function(e){ye.log("ERROR clearing history"+e)}))):function(e,t){var n=pi[e];n?n.resolve(t):ye.log("SharedStorageBridge: resolveRequest("+e+", "+JSON.stringify(t)+") cannot find outstanding request")}(n.requestId,n);else mi||ye.log('CONCIERGE StoragePlugin request ID mismatch: plug in "'+a.id+'" receved an event for "'+n.requesterId+'"')}}};e.removeListener=function(){window.removeEventListener("message",n,!1)},vi[e.scriptLocation]=new A((function(t){e.ifrm.onload=function(e){e.target&&e.target.src&&t(e)}})).then((function(){window.addEventListener("message",n,!1)})),e.ifrm.style.display="none",document.body.appendChild(e.ifrm)}return vi[e.scriptLocation].then((function(){var t="safari"===li(window.navigator)[0];return yi(e,{request:"init",shadowInSessionStorage:t}).then((function(t){for(var n in e.parentStorage.removeKeysOtherThan(Object.keys(t.lsValue),!0),e.parentStorage.removeKeysOtherThan(Object.keys(t.ssValue),!1),t.lsValue)e.parentStorage.set(n,t.lsValue[n],!0);for(var i in t.ssValue)e.parentStorage.set(i,t.ssValue[i],!1);e.useSharedStorage=!0}),(function(t){throw ye.log("SharedStoragePlugin#init: Failed to load from shared storage, removing listener: "+t.message),e.removeListener(),t}))}))},bi.prototype.name="SharedStoragePlugin",bi.prototype.has=function(e,t){return this.parentStorage.has(e,t)},bi.prototype.get=function(e,t){return this.parentStorage.get(e,t)},bi.prototype.clear=function(){this.parentStorage.clear();return yi(this,{request:"clear"}).then((function(e){return"ack"===e.request}))},bi.prototype.set=function(e,t,n){if(this.parentStorage.set(e,t,n),!this.skipSaveForKey||!this.skipSaveForKey(e))return yi(this,{request:"store",key:e,value:t,persist:!0===n}).then((function(e){return"ack"===e.request}))},bi.prototype.del=function(e,t){return this.parentStorage.del(e,t),yi(this,{request:"remove",key:e,persist:!0===t}).then((function(e){return"ack"===e.request}))};var Ii=0;function Ni(e){this.id=++Ii,this.concierge=e,this.storagePlugin=this.defaultStoragePlugin=new Qn;var t=jn("sessionStorage");jn("localStorage")&&t?(this.storagePlugin=new ni(this.defaultStoragePlugin),this.storagePluginToLoad="SharedStorage"):this.storagePluginToLoad="window.name",this.eventSerialNumber=null,this.saveEventSerialNumber=null,t&&(this.saveEventSerial=this.storeEventSerialNumberSessionStorage,this.eventSerialNumber=this.readEventSerialNumberFromSessionStorage())}function Ei(e,t,n){return A.resolve(e.storagePlugin.del(t,n))}function Oi(e){return"MoxieCache_"+e+"_file"}function Ti(e){if(e&&(delete e.last_updated,delete e.last_submitted,e.session&&e.session.visits)){var t=e.session.visits.length-1;if(t>=0){var n=e.session.visits[t].journey;if(n){var i=n.length-1;i>=0&&(e.session.visits[t].journey[i].end_time=0)}}}}function ki(e){var t=Oi("profileJSON");return function(e,t){return A.resolve(e.storagePlugin.get(t,!0)).then((function(e){return e?void 0===e.contents?(ye.log("Loaded "+t+" from localStorage, but .contents was undefined"),null):(ye.log("Loaded "+t+" from localStorage"),e.contents):null}))}(e,t).then((function(e){if(null!==e)try{return JSON.parse(e)}catch(e){ye.log("Error parsing profile: "+e.message)}return null})).then((function(t){if(null!==t)return e.setData("profileJSON",JSON.stringify(t),!0)})).then((function(){return e}))}function xi(e){return function(e){return e.storagePlugin.get("moxie_cc",!0)||e.storagePlugin.get("uuid",!0)}(e)?e.autoLoadProperties().then(ki).then((function(){return e})):function(e){ye.log("Creating new identity");var t=e.makeProfileId();return A.all([_i(e,"uuid",t,!0),_i(e,"moxie_cc",t+"|2147483647",!0)]).then((function(){return e.uuid=t,e}))}(e).then(ki).then((function(){return e}))}Ni.prototype.storeEventSerialNumberSessionStorage=function(e){window.sessionStorage.setItem("moxie_concierge_event_serial_number",JSON.stringify(e))},Ni.prototype.readEventSerialNumberFromSessionStorage=function(){var e=window.sessionStorage.getItem("moxie_concierge_event_serial_number");if(null==e||""===e)return null;var t=null;try{t=JSON.parse(e)}catch(e){return ye.log("Could not read serial number from session storage: "+e.message),null}return"number"!=typeof t?null:Math.floor(t)!==t?null:t<0||t>4294967295?null:t},Ni.prototype.makeEventSerialNumber=function(){null===this.eventSerialNumber&&(this.eventSerialNumber=Math.floor(Math.random()*(Math.pow(2,32)-1)));var e=this.eventSerialNumber++;return this.saveEventSerial&&this.saveEventSerial(this.eventSerialNumber),this.eventSerialNumber>4294967295&&(this.eventSerialNumber=0),e},Ni.prototype.cleanup=function(){delete this.profileJSON,delete this.uuid},Ni.prototype.destroy=function(){this.cleanup(),this.storagePlugin.destroy()},Ni.prototype.skipSaveForKey=Ci,Ni.prototype.isValidUserProfile=function(e){return void 0!==e.session&&void 0!==e.session.id},Ni.prototype.getVisitorProfileId=function(){return this.getDataClone("uuid")},Ni.prototype.emitEvent=function(e){var t;return"function"==typeof CustomEvent?t=new CustomEvent(e):(t=document.createEvent("CustomEvent")).initCustomEvent(e,!0,!0,{}),ye.log("CacheManager: emitting profile update event: "+JSON.stringify(t)),this.dispatchEvent(window,t)},Ni.prototype.dispatchEvent=function(e,t){return e.dispatchEvent(t)},Ni.prototype.resetVisitorProfile=function(){var e=this;return this.concierge.contextMonitor.stop(),Ei(this,Oi("profileJSON"),!0).then((function(){e.visitorProfile=null;var t=e.concierge.contextMonitor.createNewProfile();return e.setData("profileJSON",JSON.stringify(t))})).then((function(){e.concierge.contextMonitor.start()}))},Ni.prototype.setData=Pn((function(e,t,n){if(!Z(t))throw new Si("Cannot set "+e+", data must be a string.");if("profileJSON"===e){var i,r=this.getDataClone("profileJSON");try{i=JSON.parse(t)}catch(t){throw new Si("Cannot set "+e+", data is invalid JSON.")}var o=!1,a=!n&&function(e,t){var n=!1;if(e&&e.session&&e.session.visits&&e.session.visits.length>0){var i=e.session.visits.slice(-1)[0];if(i.journey&&i.journey.length>0){var r=i.journey.slice(-1)[0];new Date-new Date(r.end_time)>60*t*1e3&&(n=!0)}else n=!0}else n=!0;return n}(r,30),s=!1;if(n||null!=r){if(void 0!==i.customData)if(r&&void 0!==r.customData)JSON.stringify(r.customData)!==JSON.stringify(i.customData)&&(s=!0);else s=!0}else o=!0,void 0!==i.customData&&(s=!0);return o&&In(this.concierge),a&&Nn(this.concierge),s&&On(this.concierge,i.customData),this.storeProfile(t)}if(e===An)return this[An]=t,_i(this,An,t,!0);if("rules_version"===e)return this.rules_version=t,_i(this,"rules_version",t,!0);if("widgets_version"===e)return this.widgets_version=t,_i(this,"widgets_version",t,!0);throw new Si("Cannot set "+e+", unknown property.")})),Ni.prototype.storeProfile=Pn((function(e){var t,n=JSON.parse(e);if(this.isValidUserProfile(n)){this.profileJSON=n;var i=(t=0,{contents:e,timestamp:(new Date).getTime(),version:t});return _i(this,Oi("profileJSON"),i,!0)}throw new Si("Cannot store profile, it is not valid.")})),Ni.prototype.setVolatileData=Pn((function(e,t){if("moxie_channels_custom_data"===e||"moxie_channels_form_data"===e)return this[e]=t;throw new Si("Cannot set "+e+".")})),Ni.prototype.getVolatileData=function(e){return this[e]},Ni.prototype.profileUpdated=function(e){var t=this.getDataClone("profileJSON"),n=B(e);return Ti(n),Ti(t),JSON.stringify(t)!==JSON.stringify(n)},Ni.prototype.getData=function(e){var t=this[e];return t?"object"==typeof t?B(this[e]):this[e]:null},Ni.prototype.getDataClone=function(e){return this.getData(e)},Ni.prototype.getDataObject=function(e){return this[e]?this[e]:null},Ni.prototype.removeClientCache=function(e,t){return Ei(this,"conclient_"+e,t)},Ni.prototype.setClientCache=function(e,t,n){return _i(this,"conclient_"+e,t,n)},Ni.prototype.getClientCache=function(e,t){return this.storagePlugin.get("conclient_"+e,t)},Ni.prototype.removeWidgetCache=function(e,t,n){return Ei(this,e+"-"+t,n)},Ni.prototype.setWidgetCache=function(e,t,n,i){return _i(this,e+"-"+t,n,i)},Ni.prototype.getWidgetCache=function(e,t,n){return this.storagePlugin.get(e+"-"+t,n)},Ni.prototype.clearWidgetCacheKey=function(e,t){for(var n=[],i=this.storagePlugin;i.parentStorage;)i=i.parentStorage;var r,o=t?"p":"s",a=Object.keys(i.data[o]);for(r=0;r<a.length;r++)V(a[r],e)&&n.push(Ei(this,a[r],t));return A.all(n)},Ni.prototype.init=function(){var e=this;if(!this.ready){var t,n=A.resolve(e);"window.name"===e.storagePluginToLoad?(e.storagePlugin=new ci(e.storagePlugin,e.concierge),e.storagePlugin.skipSaveForKey=Ci):"SharedStorage"===e.storagePluginToLoad&&(t=new bi(e.storagePlugin,e.concierge),n=n.then((function(){return t.init()})).then((function(){e.storagePlugin=t,t.skipSaveForKey=Ci})).catch((function(e){t&&t.destroy(!1),ye.log("FAILED to initialize the SharedStoragePlugin falling back to using regular localStorage: "+e.message)})).then((function(){return e}))),this.ready=n}return this.ready.then(xi)};var Li=function(e,t){A.resolve(e.storagePlugin.get(t,!0)).then((function(n){e[t]=n}))};Ni.prototype.autoLoadProperties=function(){var e=this,t=[];return t.push(e.storagePlugin.get("moxie_cc",!0)),t.push(e.storagePlugin.get("uuid",!0)),t.push(Li(e,An)),t.push(Li(e,"rules_version")),t.push(Li(e,"widgets_version")),A.all(t).then((function(t){var n,i=t[0],r=t[1];return n=i?i.split("|").shift():r,e.uuid=n,e}))},Ni.prototype.makeProfileId=function(){return Bn()};var Wi=null,Mi=null,Ai=null;function Di(e){this.monitoredRules=[],this.concierge=e,this.rulesEngine=e.rulesEngine,this.cacheManager=e.cacheManager,this.moxieData=window.MoxieData||{},this.getLastLocation=function(){return Wi},this.getLastDevice=function(){return Mi},this.getLastBrowseInfo=function(){return Ai};var t=0,n=0;this.nextMonitorId=function(){return++n},this.start=function(){var e=this;t=setInterval((function(){e.poll()}),1e3)},this.stop=function(){t>0&&(clearInterval(t),t=0)}}Di.prototype.cleanup=function(){this.stop()},Di.prototype.evalRules=function(){this.monitoredRules.forEach((function(e){this.rulesEngine.evalRule(e)&&(this.rulesEngine.queueActions(e),this.unregister(e),e.monitor=!1)}),this)},Di.prototype.fetchLocation=function(){return this.concierge.httpGet(this.concierge.serviceUrl.location,{type:"GET"}).then((function(e){var t=e.subdivisions&&e.subdivisions.length?e.subdivisions[0].names.en:"";return{city:e.city?e.city.names.en:"",state:t,country:e.country?e.country.names.en:"",ip_address:"",zip:"",longitude:e.location?e.location.longitude:"",latitude:e.location?e.location.latitude:""}}))},Di.prototype.recordEngagementValue=function(){var e=this.cacheManager.getDataClone("profileJSON"),t=H(U(e,1),1).current_cart_value;return void 0===e.session.first_engagement_cart_value&&(e.session.dirty=!0,e.session.first_engagement_cart_value=t),void 0===e.session.visits[e.session.visits.length-1].first_engagement_cart_value&&(e.session.visits[e.session.visits.length-1].first_engagement_cart_value=t),this.cacheManager.setData("profileJSON",JSON.stringify(e))},Di.prototype.parseMappedContext=function(e){if(void 0!==e){"string"==typeof e&&(e=[e]);var t=function(e,t){t.replace(/^\$\[/,"").replace(/\]\$$/,"");var n=Bt(Ee(t)),i=n.text()||n.val();return i?i.trim():""};for(var n in e)K(e,n)&&"string"==typeof e[n]&&(e[n]=e[n].replace(/\$\[(.*?)\]\$/g,t));return e}},Di.prototype.initTracking=function(){var e,t=0,n=0,i=this.cacheManager.getDataClone("profileJSON"),r=!1,o=!1,a=li(navigator);Ai={name:a[0],version:a[1]},Mi=Zt(navigator);var s=Number(this.cacheManager.getData(An)),c=this;if(null==i)(i={id:this.cacheManager.getData("uuid"),dirty:!0,tags:null,ip_address:"",all_device_names:[],all_browsers:[{name:Ai[0],version:Ai[1],language:navigator.language}],all_locations:null,preferences:{never_invite_to_chat:!1,language:navigator.language},session:null,history:{visits:0,last_visit:Date.now(),articles_viewed:0,invited_chat:0,refused_chat:0},last_updated:Date.now(),last_submitted:0}).all_device_names.push(Mi),r=!0,o=!0;else{if(Number(H(U(i,1),1).end_time)<s&&(t=i.session.visits.length-1,e=i.session.visits[t].journey.length-1,i.session.visits[t].journey[e].end_time=s,i.last_updated=s),!0!==i.session.transaction_completed&&!0!==this.moxieData.transactionComplete||(this.moxieData.transactionComplete&&(i.session.transaction_completed=this.moxieData.transactionComplete=!0,i.session.end_cart_value=this.moxieData.transactionTotal,Ln("transactionCompleted",{transactionTotal:this.moxieData.transactionTotal,cart:{value:this.moxieData.currentCartValue,items:this.moxieData.currentCartItems}}),pn(this.concierge,this.moxieData.transactionTotal),this.cacheManager.setData("profileJSON",JSON.stringify(i))),void 0!==this.moxieData.customData&&this.concierge.publicAPI.customData(this.concierge,this.moxieData.customData),i.session=null),void 0!==i.session&&null!==i.session&&void 0!==i.session.visits){var u=$(H(U(i,0)).start_time);(u>2592e3||isNaN(u))&&(i.session=null)}null!==i.session&&0!==i.session.visits.length&&((n=$(H(U(i,1),1).end_time))>1800||isNaN(n))&&(o=!0)}if(null===i.session||void 0===i.session){var l={};l.id=Bn(),l.visits=[],l.dirty=!0,l.end_cart_value=0,i.session=l,r=!0,o=!0}if(o){var d={};d.id=Bn(),d.dirty=!0,d.journey=[],d.browser={name:Ai[0],version:Ai[1],language:navigator.language},d.device={},d.device.name=Zt(navigator),d.referral={url:document.referrer.substr(0,200)},d.journey=[],i.session.visits.push(d),i.history.visits+=1,r=!0}var g={};g.id=Bn(),g.dirty=!0,g.url=this.concierge.url.substr(0,200),g.title=this.concierge.pageTitle.substr(0,200),g.start_time=Date.now(),g.end_time=Date.now(),g.referral={url:document.referrer.substr(0,200)};var h=H(U(i,1),1),f=h&&h.current_cart_value?h.current_cart_value:0;if(void 0!==this.moxieData.customData&&this.concierge.publicAPI.customData(this.concierge,this.moxieData.customData),void 0!==this.moxieData.currentCartValue){g.current_cart_value=this.moxieData.currentCartValue;var p=this.moxieData.currentCartItems||(h&&h.current_cart_items?h.current_cart_items:[]);Ln("cartUpdated",{cartValue:this.moxieData.currentCartValue,cartItems:p}),vn(this.concierge,this.moxieData.currentCartValue,p)}else g.current_cart_value=f;if(void 0!==this.moxieData.currentCartItems){var v;for(g.current_cart_items=[],v=0;v<this.moxieData.currentCartItems.length;v++)g.current_cart_items.push({name:this.moxieData.currentCartItems[v].name?this.moxieData.currentCartItems[v].name:"",sku_or_id:this.moxieData.currentCartItems[v].skuOrId,value:this.moxieData.currentCartItems[v].value,quantity:this.moxieData.currentCartItems[v].quantity,uom:this.moxieData.currentCartItems[v].uom,description:this.moxieData.currentCartItems[v].description})}else{var m=h&&h.current_cart_items?h.current_cart_items:[];g.current_cart_items=B(m)}t=i.session.visits.length-1;return i.history.last_visit=Date.now(),(r?this.fetchLocation().then((function(e){Wi=e,G(i,"ip_address",e.ip_address),G(i.session,"ip_address",e.ip_address);var n=!0;if(i.all_locations)for(var r=0;r<i.all_locations.length;r++)if(i.all_locations[r].city===e.city){n=!1;break}n&&(i.all_locations=i.all_locations||[],i.all_locations.push(e)),o&&(i.session.visits[t].ip_address=e.ip_address,i.session.visits[t].location=e)})).catch((function(e){ye.log("Failed to fetch location: "+JSON.stringify(e))})):A.resolve()).then((function(){return i.session.visits[t].journey.push(g),c.cacheManager.setData("profileJSON",JSON.stringify(i)).then((function(){return{rules:1,widgets:c.concierge.configuration.widgets.version}}))}))},Di.prototype.createNewProfile=function(){var e=Date.now();return{last_updated:e,last_submitted:0,history:{last_visit:e},session:{id:Bn(),dirty:!0,visits:[{journey:[{id:Bn(),dirty:!0,start_time:e,end_time:e,title:this.concierge.pageTitle.substr(0,200),url:this.concierge.url.substr(0,200),current_cart_value:0,current_cart_items:[]}]}],transaction_completed:!1,end_cart_value:0}}},Di.prototype.poll=function(){var e=Date.now(),t=this;Rn((function(){t.evalRules();var n=[];if(n.push(t.cacheManager.setData(An,e.toString(),!0)),"function"==typeof document.hasFocus&&document.hasFocus()){var i=t.cacheManager.getDataClone("profileJSON"),r=i.session.visits.length-1,o=i.session.visits[r].journey.length-1;i.session.visits[r].journey[o].end_time=e,i.last_updated=e,n.push(t.cacheManager.setData("profileJSON",JSON.stringify(i)))}return A.all(n)})).catch((function(e){ye.log("ContextMonitor.poll: error "+(e.stack?e.stack:e.message))}))},Di.prototype.register=function(e){e.monitor&&!e.monitorId&&(e.monitorId=this.nextMonitorId(),this.monitoredRules.push(e))},Di.prototype.unregister=function(e){if(e.monitor&&void 0!==e.monitorId)for(var t=e.monitorId,n=0;n<this.monitoredRules.length;n++)if(this.monitoredRules[n].monitorId===t){this.monitoredRules.splice(n,1),e.monitorId=!1;break}},Di.prototype.tagProfile=function(e,t){var n=this.cacheManager.getData("profileJSON");n.tags=n.tags||[];var i={status:!1,tags:e.tag.filter((function(e){return-1===n.tags.indexOf(e)}))};return i.tags.length&&(n.tags=n.tags||[],n.tags=n.tags.concat(i.tags),this.cacheManager.setData("profileJSON",JSON.stringify(n)),i.status=!0),i},Di.prototype.removeProfileTag=function(e,t){var n=this.cacheManager.getData("profileJSON");n.tags=n.tags||[];var i={status:!1,tags:e.tag.filter((function(e){return-1!==n.tags.indexOf(e)}))};return i.tags.length&&(n.tags=n.tags.filter((function(e){return-1===i.tags.indexOf(e)})),0===n.tags.length&&(n.tags=null),this.cacheManager.setData("profileJSON",JSON.stringify(n)),i.status=!0),i};var Ri=function(e){this.concierge=e};function Pi(e,t){return e.then((function(e){try{var n=t(e);void 0!==n&&(e=n)}catch(e){ye.error("Error in callback function: "+e)}return e}))}Ri.prototype.log=function(e){ye.log(e)},Ri.prototype.location=function(){return this.concierge.scriptLocation+"/widgets/"+this.concierge.assetVersion.widgets+"/translation.json"},Ri.prototype.navigator=function(){return navigator},Ri.prototype.htmlElement=function(){return document.documentElement},Ri.prototype.sanitizeLang=function(e){return e=(e=e.toLowerCase()).replace("_","-")},Ri.prototype.parentLang=function(e){return e?e.split("-").slice(0,-1).join("-"):""},Ri.prototype.detectLanguage=function(){var e=this.navigator(),t=this.htmlElement(),n=this.sanitizeLang(t.getAttribute("lang")||t.getAttribute("xml:lang")||e.languages&&e.languages[0]||e.language||e.userLanguage||this.data.defaultLanguage||"en");return this.log("Language: "+n),n},Ri.prototype.getValue=function(e,t){var n=this.data.sourceLangs[e];return!(!n||!K(this.data.langs[n],t))&&this.data.langs[n][t]},Ri.prototype.translate=function(e,t){for(var n=this.data.selectedLanguage,i=!1,r=!1;n;){if(!1!==(i=this.getValue(n,e)))return i;n===this.data.defaultLanguage&&(r=!0),(n=this.parentLang(n))||r||(n=this.data.defaultLanguage)}return t||"__"+e+"__"},Ri.prototype.handleJSONResponse=function(e){this.data=e,e.selectedLanguage=this.detectLanguage(),e.defaultLanguage=this.sanitizeLang(e.defaultLanguage);for(var t={},n=Object.keys(e.langs),i=0;i<n.length;i++)t[this.sanitizeLang(n[i])]=n[i];e.sourceLangs=t,this.concierge.langOptions={defaultLanguage:e.defaultLanguage,selectedLanguage:e.selectedLanguage}},Ri.prototype.init=function(){this.handleJSONResponse(this.concierge.configuration.translations)};var ji=function(){this.callbacks=[]};function Vi(e){this.concierge=e,this.names={}}function Fi(){this.isRunning=!1,this.whenDone=A.resolve(!0),this.queue=[]}function Ji(e){ye.log("ActionQueue: Error thrown from run promise, "+JSON.stringify(e))}function qi(e){this.addWidget=function(t,n,i){return e.widgetManager.addWidget(n,{id:t.id,action:i,name:t.name,source:t.source})},this.removeWidget=function(t,n,i){var r=e.widgetManager.findWidget(n.widget);return e.widgetManager.removeWidget(r)},this.notify=function(t,n,i){return e.widgetManager.notify(n,{id:t.id,action:i,name:t.name,source:t.source})},this.tagProfile=function(t,n,i){return e.contextMonitor.tagProfile(n,{id:t.id,action:i,name:t.name,source:t.source})},this.removeProfileTag=function(t,n,i){return e.contextMonitor.removeProfileTag(n,{id:t.id,action:i,name:t.name,source:t.source})}}function $i(e){var t=e.cacheManager,n=e.rulesEngine;this.visitorProfileHasTag={func:function(e,n,i){for(var r=t.getData("profileJSON"),o=0;o<i.tag.length;o++)if(r.tags&&-1!==r.tags.indexOf(i.tag[o]))return!0;return!1}},this.visitorProfileDoesNotHaveTag={func:function(e,n,i){for(var r=t.getData("profileJSON"),o=0;o<i.tag.length;o++)if(r.tags&&-1!==r.tags.indexOf(i.tag[o]))return!1;return!0}},this.visitsToSite={func:function(e,n,i){var r,o=t.getData("profileJSON"),a=q(o.history.visits,n,i.visits),s=!0;if(a&&i.last_visit){var c=H(U(o,1),2,2,!1);(void 0===c||void 0===c.end_time||$(c.end_time,r)/86400>i.last_visit)&&(s=!1)}return a&&s}},this.currentCartValue={func:function(e,n,i){return q(H(U(t.getData("profileJSON"),1),1).current_cart_value,n,i.value)}},this.productInCart={func:function(e,n,i){for(var r=H(U(t.getData("profileJSON"),1),1),o=0;o<r.current_cart_items.length;o++)for(var a=0;a<i.name.length;a++)if(q(r.current_cart_items[o].name,n,i.name[a]))return!0;return!1}},this.userDeviceName={func:function(e,n,i){for(var r=U(t.getData("profileJSON"),1),o=0;o<i.device.length;o++)if(q(r.device.name,n,i.device[o]))return!0;return!1}},this.userBrowserName={func:function(e,n,i){return q(U(t.getData("profileJSON"),1).browser.name,n,i.browser)}},this.secondsOnCurrentPage={func:function(e,n,i){var r=H(U(t.getData("profileJSON"),1),1);return q($(Date.now(),r.start_time),n,i.seconds)}},this.secondsOnSite={func:function(e,n,i){var r=U(t.getData("profileJSON"),1),o=H(r,0);return q($(H(r,1).end_time,o.start_time),n,i.seconds)}},this.secondsFromLastVisit={func:function(n,i,r){for(var o=U(t.getData("profileJSON"),1),a=-1,s=o.journey.length-1-1;s>=0;s--){var c=H(o,2,s);if(c.url===e.url){a=$(Date.now(),c.end_time);break}}return-1!==a&&q(a,i,r.seconds)}},this.numberOfPagesVisited={func:function(e,n,i){return q(U(t.getData("profileJSON"),1).journey.length,n,i.pages)}},this.geographicLocation={func:function(e,n,i){for(var r=U(t.getData("profileJSON"),1),o=JSON.parse(i.locations),a=0;a<o.length;a++){var s=o[a],c=!s.city_name||s.city_name===r.location.city,u=!s.subdivision_name||s.subdivision_name===r.location.state,l=s.country_name===r.location.country;if(c&&u&&l)return!0}return!1}},this.excludedGeographicLocation={func:function(e,n,i){for(var r=U(t.getData("profileJSON"),1),o=JSON.parse(i.locations),a=0;a<o.length;a++){var s=o[a],c=!s.city_name||s.city_name===r.location.city,u=!s.subdivision_name||s.subdivision_name===r.location.state,l=s.country_name===r.location.country;if(c&&u&&l)return!1}return!0}},this.numberOfTimesPageViewed={func:function(n,i,r){for(var o=U(t.getData("profileJSON"),1),a=0,s=o.journey.length-1;s>=0;s--){H(o,2,s).url===e.url&&a++}return q(a,i,r.views)}},this.referralURL={func:function(e,n,i){for(var r=H(U(t.getData("profileJSON"),1),1).referral.url,o=0;o<i.url.length;o++)if(q(r,n,i.url[o]))return!0;return!1}},this.notReferralURL={func:function(e,n,i){for(var r=H(U(t.getData("profileJSON"),1),1).referral.url,o=0;o<i.url.length;o++)if(!q(r,n,i.url[o]))return!1;return!0}},this.lastPageVisitedURL={func:function(e,n,i){for(var r=H(U(t.getData("profileJSON"),1),2),o=0;o<i.url.length;o++)if(q(r.url,n,i.url[o]))return!0;return!1}},this.lastPageVisitedTitle={func:function(e,n,i){for(var r=H(U(t.getData("profileJSON"),1),2),o=0;o<i.title.length;o++)if(q(r.title,n,i.title[o]))return!0;return!1}},this.previouslyVisitedURL={func:function(e,n,i){for(var r=U(t.getData("profileJSON"),1),o=r.journey.length-1,a=0;a<o;a++)for(var s=H(r,2,a),c=0;c<i.url.length;c++)if(q(s.url,n,i.url[c]))return!0;return!1}},this.previouslyVisitedTitle={func:function(e,n,i){for(var r=U(t.getData("profileJSON"),1),o=r.journey.length-1,a=0;a<o;a++)for(var s=H(r,2,a),c=0;c<i.title.length;c++)if(q(s.title,n,i.title[c]))return!0;return!1}},this.enterFormData={event:{change:function(e){e.data.rule.state=!0,n.evalRule(e.data.ruleset)&&e.data.ruleset.action.success&&n.queueActions(e.data.ruleset),e.data.rule.state=!1}},func:function(e,t,n){if(e.state){var i=Bt(Ee(n.element));return q(i.val()||i.text(),t,n.value)}return!1}},this.editForm={event:{change:function(e){e.data.rule.element=e.target,e.data.rule.state=!0,n.evalRule(e.data.ruleset)&&e.data.ruleset.action.success&&n.queueActions(e.data.ruleset),e.data.rule.state=!1,e.data.rule.element=null}},func:function(e,t,n){if(e.state){var i=Bt(Ee(e.element));return q(i.val()||i.text(),t,n.value)}return!1}},this.selectedElementValue={event:{change:function(e){n.evalRule(e.data.ruleset)&&e.data.ruleset.action.success&&n.queueActions(e.data.ruleset)}},func:function(e,t,n){var i=Bt(Ee(n.element)).find("option:checked");return q(i.val()||i.text(),t,n.value)}},this.clickedOnButton={event:{"touchend click":function(e){e.data.rule.state=!0,n.evalRule(e.data.ruleset)&&e.data.ruleset.action.success&&n.queueActions(e.data.ruleset),e.data.rule.state=!1}},func:function(e,t,n){return void 0!==e.state&&e.state}},this.elementExists={func:function(e,t,n){for(var i=0;i<n.element.length;i++)if(Bt(Ee(n.element[i])).length)return!0;return!1}},this.elementValue={func:function(e,t,n){for(var i,r=0;r<n.element.length;r++)if(q((i=Bt(Ee(n.element[r]))).val()||i.text(),t,n.value))return!0;return!1}},this.customValue={func:function(e,t,n){return q(window.MoxieData[n.name],t,n.value)}}}function Hi(e){this.pageUrl={func:function(t,n,i){for(var r=0;r<i.url.length;r++)if(q(e.url,n,i.url[r]))return!0;return!1}},this.userPlatformName={func:function(e,t,n){for(var i=0;i<n.platform.length;i++)if(q("web",t,n.platform[i]))return!0;return!1}},this.pageTitle={func:function(t,n,i){for(var r=0;r<i.title.length;r++)if(q(e.pageTitle,n,i.title[r]))return!0;return!1}},this.notPageUrlOrTitle={func:function(t,n,i){for(var r=0,o=0;o<i.exclusions.length;o++){var a=i.exclusions[o];switch(a.type){case"url":for(var s=0;s<a.values.length;s++)if(!q(e.url,a.operator,a.values[s])){r++;break}break;case"title":for(var c=0;c<a.values.length;c++)if(!q(e.pageTitle,a.operator,a.values[c])){r++;break}}}return r!==i.exclusions.length}}}function Ui(e){this.siteRules=null,this.concierge=e,this.actionQueue=new Fi,this.rulesSucceeded={},this.categorySucceeded={notify:{},addWidget:{},removeWidget:{},tagProfile:{},removeProfileTag:{}}}ji.prototype.add=function(e){this.callbacks.push(e)},ji.prototype.doCallbacksAsync=function(e){for(var t=A.resolve(e),n=0;n<this.callbacks.length;n++)t=Pi(t,this.callbacks[n]);return t},ji.prototype.doCallbacksSync=function(e){for(var t=0;t<this.callbacks.length;t++)try{var n=this.callbacks[t](e);void 0!==n&&(e=n)}catch(e){ye.error("Error in callback function: "+e)}return e},Vi.prototype.getServiceLines=function(){var e,t;return this.linesPromise||(this.linesPromise=(e=this.concierge,t=e.serviceUrl.connector+"/connector/channels/service_lines",e.httpGet(t).then((function(e){for(var t={},n=e.response,i=0;i<n.length;i+=1)t[n[i].id]=n[i].name;return t})).catch((function(e){throw ye.log("Error in fetchServiceLines"+e),e})))),this.linesPromise},Vi.prototype.setName=function(e,t){this.names[e]=A.resolve(t)},Vi.prototype.getName=function(e){return this.names[e]?this.names[e]:this.getServiceLines().then((function(t){return t[e]})).catch((function(){}))},Fi.prototype={done:function(){return 0===this.queue.length?(this.isRunning=!1,this.finishedRunning&&this.finishedRunning(!0),!0):this.next()},enqueue:function(e){return this.queue.unshift(e),this.run()},next:function(){var e=this,t=this.queue.pop();return Rn((function(){var e=A.resolve(t.func(t.params.rule,t.params.parameters,t.params.type));return t.postAction?t.postAction(e):e})).catch((function(e){ye.log("ActionQueue: Error thrown while executing action, "+t.label+"; "+e.message+"; "+e.stack)})).finally((function(){return e.done()}))},run:function(){var e=this;return!e.isRunning&&e.queue.length>0&&(e.isRunning=!0,e.whenDone=new A((function(t){e.finishedRunning=t})),setTimeout((function(){return e.isRunning?e.next().catch(Ji):null}))),this.whenDone}},Ui.prototype.ActionLibrary=qi,Ui.prototype.CriteriaLibrary=$i,Ui.prototype.ScopeLibrary=Hi;var Bi=function(e,t,n){try{return e.definition.func(e,e.operator,e.parameters)}catch(e){return ye.log('Moxie Concierge Client: Critieria Eval Error ("'+n.name+'" criteria:'+t+"): "+e.message),!1}};function Gi(e,t){var n=t.definition;if(n&&"string"==typeof n){var i=n.split(".");if(2===i.length){var r=e[i[0]][i[1]];void 0!==r&&(t.definition=r)}}var o=t.operator;if(o&&"string"==typeof o){var a=o.split(".");if(3===a.length){var s=D[a[2]];void 0!==s&&(t.operator=s)}}if(t.parameters&&t.parameters.exclusions&&t.parameters.exclusions.length>0)for(var c=t.parameters.exclusions,u=0;u<c.length;u++)Gi(e,c[u])}Ui.prototype.init=function(e){this.siteRules=e,this.actionLibrary=new qi(this.concierge),this.criteriaLibrary=new $i(this.concierge),this.scopeLibrary=new Hi(this.concierge);for(var t=0;t<this.siteRules.rules.length;t++)for(var n=this.siteRules.rules[t],i=0;i<n.criteria.length;i++){var r=n.criteria[i];Gi(this,r);for(var o=!0,a=0;a<n.scope.length;a++)Gi(this,n.scope[a]),Bi(n.scope[a])||(o=!1);var s=Date.now();if((void 0!==n.start&&n.start>s||void 0!==n.end&&n.end<s)&&(o=!1),o&&(n.monitor&&this.concierge.contextMonitor.register(n),r.definition.event)){var c=function(e){var t=r.definition.event[e],i={ruleset:n,rule:r};Bt(Ee(r.parameters.element)).on(e,(function(e){e.data=i,t(e)}))};for(var u in r.definition.event)c(u)}}},Ui.prototype.getSiteRules=function(){return this.siteRules||{}},Ui.prototype.getSiteSettings=function(){return this.siteRules.settings||{}},Ui.prototype.queueWaitTime=function(){return this.siteRules&&this.siteRules.settings&&this.siteRules.settings.queue_wait_time>=0?this.siteRules.settings.queue_wait_time:5},Ui.prototype.minTimeBetween=function(){return this.siteRules&&this.siteRules.settings&&this.siteRules.settings.min_time_between>=0?this.siteRules.settings.min_time_between:60},Ui.prototype.hideWhenServiceLineClosed=function(){return this.siteRules&&this.siteRules.settings&&this.siteRules.settings.hide_on_demand_chat_when_service_line_is_closed},Ui.prototype.checkQueueWaitTimeForReactive=function(){return this.siteRules&&this.siteRules.settings&&this.siteRules.settings.use_min_time_between_for_on_demand_chat},Ui.prototype.checkQueueWaitTimeForProactive=function(){return this.siteRules&&this.siteRules.settings&&this.siteRules.settings.use_min_time_between_for_proactive_chat},Ui.prototype.run=function(){var e,t,n;for(e=[],t=0;t<this.siteRules.rules.length;t++){var i=this.siteRules.rules[t];n=this.evalRule(i),e.push({ruleset:i,success:n}),n&&i.action.success&&this.queueActions(i)}return e},Ui.prototype.evalRule=function(e){var t,n;if(this.rulesSucceeded[e.id])return!1;if(n=Date.now(),void 0!==e.start&&e.start>n||void 0!==e.end&&e.end<n)return!1;for(t=0;t<e.scope.length;t++)if(!Bi(e.scope[t]))return!1;for(t=0;t<e.criteria.length;t++)if(!Bi(e.criteria[t],t,e))return!1;return e.action.success&&(this.rulesSucceeded[e.id]=!0),!0},Ui.prototype.isRedundantAction=function(e,t,n,i){if("tagProfile"===e||"removeProfileTag"===e)return!1;if(i)return!1;for(var r=0;r<n.length;r++)if(n[r].definition&&n[r].definition.event)return!1;return this.categorySucceeded[e][t]||this.categorySucceeded.removeWidget[t]},Ui.prototype.isRemoveOk=function(e){return this.categorySucceeded.addWidget[e]||this.categorySucceeded.notify[e]},Ui.prototype.queueActions=function(e){var t,n,i,r=e.criteria,o=void 0!==e.monitorId,a=this.concierge.cacheManager.getDataClone("profileJSON"),s=["addWidget","notify","tagProfile","removeProfileTag"];if(e.action&&e.action.success)for(var c=0;c<e.action.success.length;c++)if(n=(t=e.action.success[c]).actionFunc,i=-1!==s.indexOf(n)&&function(e,t,n,i,r,o){return o.then((function(n){if(n&&n.status)if("addWidget"===t||"notify"===t){var o=null;n.parameters&&n.parameters.serviceLineId&&(o=n.parameters.serviceLineId);var a=null;n.parameters&&n.parameters.widget&&(a=n.parameters.widget);var s="reactive";"notify"===t&&(s="proactive"),kn(e,i,r,o,a,s)}else if("tagProfile"===t||"removeProfileTag"===t){Tn("tagProfile"===t,e,n.tags,i,r)}return null}))}.bind(void 0,this.concierge,n,a,e.id,c),!(this.isRedundantAction(n,t.parameters.widget,r,o)||"removeWidget"===n&&this.isRemoveOk(t.parameters.widget)))try{this.actionQueue.enqueue({label:e.name+":"+c+":"+n,func:this.actionLibrary[n],params:{rule:e,parameters:this.concierge.contextMonitor.parseMappedContext(t.parameters),type:"success"},postAction:i}),this.categorySucceeded[n][t.parameters.widget]=!0}catch(t){ye.log('Moxie Concierge Client: Action Function Error ("'+e.name+'" action:'+c+"): "+t.message)}};function Ki(e){var t,n;this.wm=e,this.concierge=e.concierge,Ar(e)?this.spots=((t={}).single=new zi("single"),t):this.spots=((n={}).chat=new zi("chat"),n.kb=new zi("kb"),n.email=new zi("email"),n),this.offer=null,this.notification=null,this.open=null,this.active=[],this.alive=[]}function zi(e){this.name=e,this.reactive=null,this.widget=null}function Qi(e,t){return e.spots[t]}function Xi(e,t){var n=t.preferredSpotName();return n?Ar(e.wm)?"single":K(e.spots,n)?n:null:null}function Yi(e,t){if(e.wm.notificationDisplayed())return!1;if(er(e))return!1;if(Zi(e))return!1;if(tr(e))return!1;var n=Xi(e,t);if(n){var i=me(Qi(e,n),"widget");if(i&&!i.hasFinished&&0!==i.state)return!1}return!0}function Zi(e){return!!e.offer}function er(e){return!!e.open}function tr(e){return!!e.notification}function nr(e,t){return kr(t)?function(e,t){if(null===t.preferredSpotName())return!0;var n=Qi(e,t.spot);if(n){if(!n.widget)return!0;if(mr(e,n.widget))return!1;if(n.widget.hasFinished)return!0;if(n.widget.priority<t.priority)return!0;if(0===n.widget.state)return!0}return!1}(e,t):t.parameters.proactive||!1?function(e,t){if(Zi(e))return!1;if(null===t.preferredSpotName())return!0;var n=Qi(e,t.spot);if(n){if(!n.widget)return!0;if(n.widget.priority<t.priority)return!0;if(n.widget.hasFinished)return!0;if(0===n.widget.state)return!0}return!1}(e,t):function(e,t){var n=Qi(e,t.spot);if(n){if(!n.reactive)return!0;if(n.reactive.priority<t.priority)return!0}return!1}(e,t)}function ir(e,t){t&&(e.open===t&&jr(e.wm,!1),t.unload())}function rr(e,t){var n=Qi(e,t.spot);n&&n.widget!==t&&(ir(e,n.widget),n.widget=t,e.wm.engagementWidgets.widgets[t.name]=t,e.wm.widgetsType.updateWidgetElement(t),e.notification&&e.wm.widgetsType.updateNotification())}function or(e,t){var n=Qi(e,t);return n&&n.widget?n.widget:null}function ar(e,t,n){var i=t.spot;if(t.parameters.proactive&&!e.wm.loadingActiveWidgets)return e.offer=t,void function(e,t,n){var i=Qi(e,t);i&&!i.widget&&rr(e,n)}(e,i,t);var r=Qi(e,i);r&&(kr(t)||(r.reactive=t),(n||function(e,t,n){return!t||!mr(e,t)&&(!!t.hasFinished||(n.priority>t.priority||0===t.state))}(e,r.widget,t))&&rr(e,t))}function sr(e,t){var n=t.parameters;n.rule=n.rule||{},n.proactive=!0;var i=t.label();if(function(e){var t=1e3*e.rulesEngine.minTimeBetween();if(t<=0)return!1;return Date.now()<function(e){var t=Number(e.cacheManager.getClientCache("lastNotified"));return isNaN(t)?0:t}(e)+t}(e.concierge))return ye.log("wmStateMakeOffer("+i+"): notified too soon"),A.resolve(xr);if(!Yi(e,t))return ye.log("wmStateMakeOffer("+i+"): cannot display notification"),A.resolve(xr);if(function(e){for(var t=e.active,n=t.length,i=0;i<n;i++)if(t[i].configuration.blockOffersWhileActive)return!0;return!1}(e))return ye.log("wmStateMakeOffer("+i+"): blockOffersWhileActive true"),A.resolve(xr);ye.log("wmStateMakeOffer("+i+"): invoked.");var r=e.wm,o=r.createEngagementRecord(t);t.engagementId=o;var a={status:!0,ref:t,parameters:t.parameters,engagementId:o,rule:t.parameters.rule};return t.beforeNotify(a).then(Fr(r,(function(){return vr(e,t)}))).then(Fr(r,(function(){return Yi(e,t)?(pr(e,t),t.autoOpen?A.resolve(r.widgetsType.openConcierge(t)).then((function(){return xr})):a):(ye.log("WidgetManager.notify("+i+"): cannot display notification after beforeNotify is complete"),A.resolve(xr))}))).then(Fr(r,(function(){t.notificationType=1,e.notification=t,r.showNotification(t);var n=r.getEngagementRecord(o);return null!==n&&(n.decision_type="Ignored",r.setEngagementRecord(o,n)),a}))).then(Fr(r,(function(e){return ye.log("wmStateMakeOffer("+i+"): ready to notify."),e}))).catch((function(e){var t=e.message?e.message:e;return ye.log("wmStateMakeOffer("+i+"): error: "+t+"\n"+e.stack),xr}))}function cr(e){if(Zi(e)){var t=e.offer;!function(e,t){if(!t)return;var n=t.engagementId,i=e.getEngagementRecord(n),r=t.parameters;if("chat"===t.name){if(i.proactive&&r.rule){var o=new Date(i.time).getTime();i.chat.time_to_decide=Math.round(((new Date).getTime()-o)/1e3),i.decision_type="Declined",e.setEngagementRecord(n,i)}}else null!==i&&i.proactive&&(i.decision_type="Declined",e.setEngagementRecord(n,i))}(e.wm,t),ur(e),e.wm.broadcastCloseProactiveNotification(t,"declined")}}function ur(e){if(Zi(e)){var t=e.offer,n=Qi(e,t.spot);e.offer=null,n&&n.widget===t?n.reactive&&n.reactive!==t&&rr(e,n.reactive):ir(e,t)}}function lr(e){if(tr(e)){var t=e.notification;Ln("notification",{widgetName:Mr(t.name),rule:t.parameters.rule,engagementId:t.engagementId,notificationType:Vr(t.notificationType),status:"closed"}),e.wm.setNotificationType(0);var n=e.wm.widgetsType.closeNotification();return e.notification=null,n}}function dr(e){if(tr(e)){var t=e.notification;lr(e),Zi(e)?function(e){var t=e.offer;t&&(e.offer=null,e.wm.broadcastCloseProactiveNotification(t,"accepted"),rr(e,t),0===t.state&&t.execute(e.wm))}(e):e.wm.showWidget(t)}}function gr(e){tr(e)&&(lr(e),Zi(e)&&cr(e))}function hr(e){tr(e)&&(lr(e),Zi(e)&&function(e){Zi(e)&&ur(e)}(e))}function fr(e,t){var n=t.label();return vr(e,t).then((function(i){return i.status?(pr(e,t),t.autoOpen?A.resolve(e.wm.widgetsType.openConcierge(t)).then((function(){return i})):i):(ye.log("WidgetManager.addWidget("+n+"): did not add widget"),i)})).catch((function(e){return ye.log("WidgetManager.addWidget("+n+"): failed: "+e),ye.log(e.stack),xr}))}function pr(e,t){var n=e.wm,i=t.name,r=t.spot;if(ar(e,t,!1),r){var o=Rr(r);if(0===o.length)n.widgetsType.addWidget(t);else{var a=o.find("button");t.buttonEnabled?a.removeAttr("disabled"):a.attr("disabled","")}}t.shouldDisplayBell()&&(n.shouldDisplayBell=!0),Bt("#concierge").show();var s=Bt("#concierge-tab");Ar(n)&&n.isMobile()&&n.shouldDisplayBell?s.show():n.shouldDisplayBell&&!Ar(n)?s.show():s.hide(),ye.log("wmStateAddWidget("+t.label()+"): complete OK"),Ln("widgetAdded",{widgetName:Mr(i),rule:{id:me(t,"parameters","rule","id"),name:me(t,"parameters","rule","name")}})}function vr(e,t){t.parameters=t.parameters||{};var n=t.parameters,i=e.wm,r=t.engagementId;if(ye.log("wmStatePrepareToAddWidget called with:",n,r),n.proactive=n.proactive||!1,n.rule=n.rule||{},kr(t)&&(t.priority=2),t.spot=Xi(e,t),!nr(e,t))return A.resolve(xr);var o=t.label();ye.log("wmStatePrepareToAddWidget("+o+"): invoked.'");var a={status:!0,ref:t,parameters:n,proactive:n.proactive,engagementId:r,ruleSettings:i.concierge.rulesEngine.getSiteSettings()};return t.beforeAdd(a).then(Fr(i,(function(e){return void 0!==t.prepareToLoad&&(t.prepareToLoadPromise=t.prepareToLoad(e).then((function(e){return e&&e.autoOpen?i.widgetsType.openConcierge(t):e}))),e})))}function mr(e,t){return P(e.active,t)>=0}function wr(e,t){P(e.alive,t)<0&&e.alive.push(t)}function yr(e,t){var n=P(e.alive,t);n>=0&&e.alive.splice(n,1)}function br(e,t){return mr(e,t)?A.resolve(null):(t.active=!0,e.active.push(t),Ln("widgetActivated",{widgetName:t.name}),Cr(e))}function Sr(e,t){var n=P(e.active,t);n>=0&&(t.active=!1,e.active.splice(n,1),Cr(e))}function Cr(e){var t=e.active.map((function(e){return{widgetName:e.name,loadParams:e.parameters}}));return e.wm.concierge.cacheManager.setClientCache("activeWidgets",t)}function _r(e){return 9===e}function Ir(e){return 13===e}function Nr(e){return 32===e}function Er(e){return 38===e}function Or(e){return 40===e}function Tr(e){return"externalAPI"===e||"externalLink"===e}function kr(e){return Tr(me(e,"parameters","rule","source"))}var xr={status:!1};function Lr(e){return"kbot"===e}function Wr(e){return function(e){return"chat"===e}(e)||Lr(e)}function Mr(e){return Lr(e)?"chat":e}function Ar(e){return!!e.engagementWidgets.globalSettings.singleChannelMode}function Dr(e,t){var n=Qi(e,t.spot);return!n||(!n.widget||t!==n.widget&&(!mr(e,n.widget)&&(!!t.parameters&&!!function(e,t){if(!e||!t)return!0;var n=e.parameters,i=t.parameters;if(!n||!i)return!1;if(e.name!==t.name)return!0;switch(e.name){case"chat":if(parseInt(n.portalId,10)!==parseInt(i.portalId,10))return!0;break;case"kb":if(parseInt(n.portalId,10)!==parseInt(i.portalId,10))return!0;if(""+n.searchText!=""+i.searchText)return!0;if(""+n.articleId!=""+i.articleId)return!0;break;case"email":if(parseInt(n.mailboxId,10)!==parseInt(i.mailboxId,10))return!0}return!1}(n.widget,t))))}function Rr(e){return Bt('#concierge-widgets ul li[data-spot="'+e+'"]')}function Pr(e){if(void 0!==e){var t,n;try{t=e.width.animVal.value,n=e.height.animVal.value}catch(e){return!1}Ue(e,"viewBox")||Be(e,"viewBox","0 0 "+t+" "+n),Be(e,"height",25),Be(e,"width",25)}}function jr(e,t){var n=A.resolve(),i=e.wmState.open;if(!i)return n;var r=Bt("#concierge-widget-area");r.removeClass("con-open"),e.widgetsType.closeWidgets&&e.widgetsType.closeWidgets();var o=i.name;return e.$concierge.find("#concierge-widgets li[data-widget="+o+"] .con-icon").attr("aria-expanded","false"),"Tablet"===e.device&&(r.hasClass("con-animating")&&(n=n.then((function(){return r.promise()}))),n=n.then((function(){e.makePositionFixed(),e.forceBlur()}))),e.$concierge.removeClass("con-open-widget"),e.openWidget=!1,e.wmState.open=null,n.then((function(){if(e.widgetsType.focusWidgetButton(o),t)return Ln("widgetClosed",{widgetName:o})})).catch((function(e){ye.log("Error Closing Widget:"+e)}))}function Vr(e){var t="other";return 2===e?t="widgetMessage":1===e&&(t="proactiveOffer"),t}function Fr(e,t){return function(n){return!e._disabled&&n&&n.status?t(n):n&&!n.status?n:xr}}function Jr(e,t){var n=e.wmState,i=Bt("#concierge-widgets ul"),r=i.children("li");if(!(r.length<=1)){var o=t?1:-1;r.sort((function(e,t){var i=e.getAttribute("data-spot"),r=t.getAttribute("data-spot"),a=Qi(n,i).widget.sortKey,s=Qi(n,r).widget.sortKey;return a>s?1*o:a<s?-1*o:0})),r.detach().appendTo(i)}}function qr(e,t,n,i,r){if(e&&parseInt(t,10)>n&&!i&&!r)throw new Error("queue wait time is too long");return!0}function $r(e,t){var n=e.getDataClone("profileJSON"),i=n.session.visits.length-1,r=n.session.visits[i].journey.length-1;n.session.visits[i].journey[r].engagements||(n.session.visits[i].journey[r].engagements=[]),n.session.visits[i].journey[r].engagements.push(t),e.setData("profileJSON",JSON.stringify(n))}function Hr(e,t,n){for(var i=e.getData("profileJSON"),r=i.session.visits[i.session.visits.length-1].journey,o=r.length-1,a=JSON.stringify(n),s=o;s>=0;s--){var c=r[s].engagements;if(c)for(var u=c.length-1;u>=0;u--){var l=c[u];if(l.id===t){if(JSON.stringify(l)===a)return A.resolve();if(n.dirty=!0,s===o)c[u]=n;else{c.splice(u,1),0===c.length&&delete r[s].engagements;var d=r[o];d.engagements?d.engagements.push(n):d.engagements=[n]}return e.setData("profileJSON",JSON.stringify(i))}}}return A.resolve()}function Ur(e,t){for(var n=e.getDataObject("profileJSON"),i=n.session.visits.length-1,r=0;r<n.session.visits[i].journey.length;r++)if(n.session.visits[i].journey[r].engagements)for(var o=0;o<n.session.visits[i].journey[r].engagements.length;o++)if(n.session.visits[i].journey[r].engagements[o].id===t)return B(n.session.visits[i].journey[r].engagements[o]);return null}function Br(e,t){t=t||{},this.concierge=e,this.isValid=this.validateParams(t),this.config=t}function Gr(e,t){t&&(t.conciergeV2=this,e.isTestMode&&(this.root=e)),this.broadcast=Gr.broadcast,this.transactionComplete=function(t){return e.ready.then((function(){var n,i,r,o;return n=e.cacheManager,(r=n.getDataClone("profileJSON")).last_updated=Date.now(),r.session.transaction_completed=!0,void 0!==t&&(r=Wn(r,t,e),o=t.vendorTxnId),i=H(U(r,1),1),e.contextMonitor.stop(),n.setData("profileJSON",JSON.stringify(r),!0).then((function(){return Ln("transactionCompleted",{transactionTotal:r.session.end_cart_value,cart:{value:i.current_cart_value,items:i.current_cart_items}}),pn(e,r.session.end_cart_value,o),e.contextMonitor.initTracking().then((function(){e.contextMonitor.start()}))}))}))},this.updateSession=function(t){return e.ready.then((function(){var n,i;return t=t||{},i=Wn((n=e.cacheManager).getDataClone("profileJSON"),t,e),n.setData("profileJSON",JSON.stringify(i))}))},this.startEngagement=function(t){return e.ready.then((function(){var n=e.widgetManager;if(!t||"string"!=typeof t.widget)throw ye.log("GoMoxie.concierge.startEngagement: missing required configuration parameter"),new Error("GoMoxie.concierge.startEngagement: missing required configuration parameter");if(Mn(t.widget))return A.reject(new Error("The engagement type is not allowed: "+t.widget));if(!n.engagementWidgets.widgets[t.widget])throw ye.log('GoMoxie.concierge.startEngagement: invalid value for configuration parameter "widget"'),new Error('GoMoxie.concierge.startEngagement: invalid value for configuration parameter "widget"');if(!n.isValidEngagementConfig(t))throw ye.log("GoMoxie.concierge.startEngagement: invalid widget configuration"),new Error("GoMoxie.concierge.startEngagement: invalid widget configuration");return n.startExternal("externalAPI",t)}))},this.closeNotification=function(t){return e.ready.then((function(){var n=e.widgetManager;return t?gr(n.wmState):hr(n.wmState)}))},this.startTrackingEngagement=function(t){return e.ready.then((function(){new Br(e,t).startEngagement()}))},this.updatePage=function(t,n){var i=null;return e.ready.catch((function(){return!1})).then((function(){return e.eventService.clearHistoryStub||(i=e.eventService),e.contextMonitor.stop(),e.cacheManager&&e.cacheManager.cleanup(),e.widgetManager.destroy(),null})).then((function(){return e.prepare(t,n,{eventService:i}),e.init()})).then((function(){return function(e){delete e._clearingHistoryPromise}(e),null}))},this.clearHistory=function(){var t=e.loadState;if("READY"!==t&&"LOADING"!==t)return A.reject(new Error("Invalid State: "+t+". Can only be invoked in READY or LOADING states."));function n(){return e.loadState="CLEARING",ui(e)}return e.loadState="CLEARING",("READY"===t?n():e.apiReady.then(n)).then((function(){return e.loadState="CLEARED",null}))};var n={},i=function(e){return e.status},r=function(e){return ye.log("checkAvailability error thrown: "+e.message),!1};this.checkAvailability=function(t,o){return e.ready.then((function(){if("chat"===t&&void 0===o.portalId)return e.rulesEngine.actionQueue.whenDone})).then((function(){var a={parameters:o},s=e.widgetManager,c="availability";if("chat"===t){if(void 0===o.portalId){var u=s.engagementWidgets.widgets.chat.portalId;if(void 0===u)throw new Error("No Moxie portal/mailbox ID specified for engagement.");a.parameters.portalId=u}a.ruleSettings=e.rulesEngine.getSiteSettings(),c+="|"+o.portalId+"|"+s.device}var l=s.engagementWidgets.widgets[t],d=Date.now(),g=n[c];return g&&g.timeout>d?g.value:(g={timeout:d+5e3,value:l.checkAvailability(a).then(i,r)},n[c]=g,g.value)}))},this.customData=function(t){return e.ready.then((function(){var n=e.cacheManager,i=n.getDataClone("profileJSON");if(void 0===i)throw new Error("Could not find visitor profile.");if(void 0===t)return i.customData;if(!JSON.stringify(t))throw new Error("Could not stringify customData");return i.customData=t,n.setData("profileJSON",JSON.stringify(i)).then((function(){return t}))}))},this.channelsData=function(t){return e.ready.then((function(){var n=e.cacheManager;return void 0===t?n.getVolatileData("moxie_channels_custom_data"):n.setVolatileData("moxie_channels_custom_data",t)}))},this.channelsFormData=function(t){return e.ready.then((function(){var n=e.cacheManager;return void 0===t?n.getVolatileData("moxie_channels_form_data"):n.setVolatileData("moxie_channels_form_data",t)}))},this.onQuestionnaireLoaded=function(t){e.onQuestionnaireLoadedCallbacks.add(t)},this.onQuestionnaireSubmit=function(t){e.onQuestionnaireSubmitCallbacks.add(t)}}function Kr(){function e(e){return e.status}function t(e){return ye.log("checkAvailability error thrown: "+e.message),"false"}this.broadcast=Kr.broadcast,this.transactionComplete=function(e,t){var n,i,r;return n=e.cacheManager,(r=n.getDataClone("profileJSON")).last_updated=Date.now(),r.session.transaction_completed=!0,void 0!==t&&(r=Wn(r,t,e)),i=H(U(r,1),1),e.contextMonitor.stop(),n.setData("profileJSON",JSON.stringify(r),!0).then((function(){return Kr.broadcast("transactionCompleted",{transactionTotal:r.session.end_cart_value,cart:{value:i.current_cart_value,items:i.current_cart_items}}),pn(e,r.session.end_cart_value),e.contextMonitor.initTracking().then((function(){e.contextMonitor.start()}))}))},this.updateSession=function(e,t){var n,i;t=t||{},i=Wn((n=e.cacheManager).getDataClone("profileJSON"),t,e),n.setData("profileJSON",JSON.stringify(i))},this.startEngagement=function(e,t){var n,i,r={};if(i=e.widgetManager,t&&"string"==typeof t.widget){if(Mn(t.widget))throw new Error("The engagement type is not allowed: "+t.widget);if(i.engagementWidgets.widgets[t.widget]){if(i.isValidEngagementConfig(t)){for(n in K(t,"enableChatDeflection")&&!0===t.enableChatDeflection&&(t.widget="kbot"),t)K(t,n)&&(r[n]=t[n]);var o={name:t.ruleName,source:"externalAPI",id:-2,action:"success"};return r.rule=o,i.addWidget(t,o).then((function(e){!1!==i.openWidget&&i.openWidget!==t.widget&&i.hideWidget(!0),gr(i.wmState),i.showWidget(e.ref),i.showConcierge(),i.widgetsType.openConcierge()}))}ye.log("GoMoxie.concierge.startEngagement: invalid widget configuration")}else ye.log('GoMoxie.concierge.startEngagement: invalid value for configuration parameter "widget"')}else ye.log("GoMoxie.concierge.startEngagement: missing required configuration parameter")},this.closeNotification=function(e,t){var n=e.widgetManager;return t?gr(n.wmState):hr(n.wmState)},this.startTrackingEngagement=function(e,t){new Br(e,t).startEngagement()},this.updatePage=function(e,t,n){var i;return e.ready.catch((function(){return!1})).then((function(){return e.eventService.stub||(i=e.eventService),e.contextMonitor.stop(),e.cacheManager.cleanup(),e.widgetManager.destroy(),null})).then((function(){return e.init(t,n,{eventService:i})}))},this.checkAvailability=function(n,i,r,o){var a,s,c,u,l,d,g,h,f,p;if(a={parameters:r},s=n.cacheManager,c=n.widgetManager,h=r.portalId,u="availability",l="availability-timestamp","chat"===i){if(void 0===h){if(void 0===(g=c.engagementWidgets.widgets.chat.portalId))return void ye.log("No Moxie portal/mailbox ID specified for engagement.");h=g,a.parameters.portalId=h}a.ruleSettings=n.rulesEngine.getSiteSettings(),u+="|"+h+"|"+c.device,l+="|"+h+"|"+c.device}return d=c.engagementWidgets.widgets[i],p=1e5,(f=s.getWidgetCache(i,l,!1))&&(p=(Date.now()-f)/1e3),(f&&p<=5&&s.getWidgetCache(i,u,!1)?A.resolve(s.getWidgetCache(u)):d.checkAvailability(a).then(e,t).then((function(e){return A.all([s.setWidgetCache(i,u,e,!1),s.setWidgetCache(i,l,Date.now(),!1)]).then((function(){return e}))}))).then((function(e){return o(e),e}))},this.customData=function(e,t){var n,i;return i=(n=e.cacheManager).getDataClone("profileJSON"),void 0===t?void 0!==i?i.customData:void 0:!!JSON.stringify(t)&&(i.customData=t,n.setData("profileJSON",JSON.stringify(i)),!0)},this.channelsData=function(e,t){var n=e.cacheManager;if(void 0===t)return n.getVolatileData("moxie_channels_custom_data");try{n.setVolatileData("moxie_channels_custom_data",t)}catch(e){return ye.log("channelsData: "+e),!1}return!0},this.channelsFormData=function(e,t){var n=e.cacheManager;if(void 0===t)return n.getVolatileData("moxie_channels_form_data");try{n.setVolatileData("moxie_channels_form_data",t)}catch(e){return ye.log("Error: "+e),!1}return!0},this.onQuestionnaireLoaded=function(e,t){e.onQuestionnaireLoadedCallbacks.add(t)},this.onQuestionnaireSubmit=function(e,t){e.onQuestionnaireSubmitCallbacks.add(t)},this.registerMethods=function(e,t){void 0!==t&&void 0!==t.concierge&&(t.concierge.updateSession=this.updateSession.bind(void 0,e),t.concierge.transactionComplete=this.transactionComplete.bind(void 0,e),t.concierge.startEngagement=this.startEngagement.bind(void 0,e),t.concierge.checkAvailability=this.checkAvailability.bind(void 0,e),t.concierge.customData=this.customData.bind(void 0,e),t.concierge.closeNotification=this.closeNotification.bind(void 0,e),t.concierge.channelsData=this.channelsData.bind(void 0,e),t.concierge.channelsFormData=this.channelsFormData.bind(void 0,e),t.concierge.startTrackingEngagement=this.startTrackingEngagement.bind(void 0,e),t.concierge.onQuestionnaireLoaded=this.onQuestionnaireLoaded.bind(void 0,e),t.concierge.onQuestionnaireSubmit=this.onQuestionnaireSubmit.bind(void 0,e),t.concierge.updatePage=this.updatePage.bind(void 0,e),e.isTestMode&&(t.concierge.root=e))}}function zr(e){return e.signature="moxie_concierge",e}Br.prototype.startEngagement=function(){if(!this.isValid)return ye.log("GoMoxie.concierge.startTrackingEngagement: unable to start engagement that had an invalid configuration"),!1;var e=function(e){var t={chat:null,decision_type:"",email:null,id:Bn(),kb:null,name:e.engagementType,proactive:!1,rule:{name:e.ruleName,source:"externalAPI",id:-2,ruleAction:"success"},time:Date.now(),type:2};for(var n in e)"engagementType"!==n&&"ruleName"!==n&&K(e,n)&&(t[n]=e[n]);return t}(this.config);return $r(this.concierge.cacheManager,e),!0},Br.prototype.validateParams=function(e){var t,n;for(t in n=!0,"object"==typeof e&&e.engagementType&&e.ruleName||(ye.log("GoMoxie.concierge.TrackingEngagement.validateParams: missing required configuration parameter"),n=!1),e)K(e,t)&&"string"!=typeof e[t]&&(ye.log("GoMoxie.concierge.TrackingEngagement.validateParams: invalid engagement parameter: "+t),n=!1);return n},Gr.broadcast=Ln,Kr.broadcast=Ln;var Qr=[" ","\n","\t"];function Xr(){this.outputRaw=[],this.outputSub=[],this.currentSub=null,this.state=1,this.compiled=[],this.actions=[]}function Yr(e){var t=new Xr;return t.compile(e),function(e){return t.evaluate(e)}}Xr.prototype.compile=function(e){var t,n;for(t=0;t!==e.length;t++)switch(n=e[t],this.state){case 1:this.handleStateInput(n);break;case 2:this.handleStateOpen(n);break;case 4:this.handleStateSubOperator(n);break;case 3:this.handleStateSubInit(n);break;case 5:this.handleStateSub(n);break;case 6:this.handleStateSubFinal(n);break;case 7:this.handleStateClose(n)}var i=[],r=null;for(t=0;t!==this.outputRaw.length;t++)null===(n=this.outputRaw[t])?null!==r&&(i.push([r,t]),r=null):null===r&&(r=t);null!==r&&i.push([r,this.outputRaw.length]),this.outputSub.reduce((function(e,t){return null!==t&&e.push(t),e}),[]);var o=0;for(t=0;t!==i.length;t++){r=i[t][0];for(var a=i[t][1];o!==r;o++)this.actions.push(2),this.compiled.push(this.outputSub[o]);this.compiled.push(this.outputRaw.slice(r,a).join("")),o=a,this.actions.push(1)}this.outputRaw=null,this.outputSub=null},Xr.prototype.evaluate=function(e){for(var t,n=[],i=0;i!==this.actions.length;i++){switch(this.actions[i]){case 1:n.push(this.compiled[i]);break;case 2:null!=(t=e[this.compiled[i]])&&n.push(t)}}return n.join("")},Xr.prototype.handleStateInput=function(e){"<"===e?this.state=2:(this.outputRaw.push(e),this.outputSub.push(null))},Xr.prototype.handleStateOpen=function(e){"%"===e?this.state=4:(this.outputRaw.push("<"),this.outputRaw.push(e),this.outputSub.push(null),this.outputSub.push(null),this.state=1)},Xr.prototype.handleStateSubOperator=function(e){if("="!==e)throw new Error("Operator for the template must be '=', not '"+e+"'");this.state=3},Xr.prototype.handleStateSubInit=function(e){-1===Qr.indexOf(e)&&(this.currentSub=[e],this.state=5)},Xr.prototype.handleStateSub=function(e){if(-1===Qr.indexOf(e))return"%"===e?(this.finishSub(),void(this.state=7)):void this.currentSub.push(e);this.finishSub(),this.state=6},Xr.prototype.finishSub=function(){this.outputSub.push(this.currentSub.join("")),this.outputRaw.push(null),this.currentSub=null},Xr.prototype.handleStateSubFinal=function(e){if(-1===Qr.indexOf(e)){if("%"!==e)throw new Error("Stray character '"+e+"' after substitution");this.state=7}},Xr.prototype.handleStateClose=function(e){if(">"!==e)throw new Error("Invalid sequence '"+e+"' after closing percent sign");this.state=1};var Zr=function(e){e.$notifAnimate&&(e.$notifAnimate.stop(!0,!0),delete e.$notifAnimate),e.$areaAnimate&&(e.$areaAnimate.stop(!0,!0),delete e.$areaAnimate),e.conciergePendingUpdate&&(qt(e.conciergePendingUpdate),delete e.conciergePendingUpdate)},eo=function(e){return 0===e.tabStyle.cascade},to=function(e,t){var n=t.index();if(n<0)return 0;eo(e)||(n=t.parent().children("li").length-(n+1));return n+1},no=function(e,t,n){var i=e.widgetsType.getNotification(),r=t.children("ul").first(),o=r.height(),a=r.children("li").length,s={display:"block",height:o+65},c={opacity:1},u={opacity:0};if(eo(e)?(c.top=40,u.top=-(50*a-10),s.top=25):(c.bottom=-10,u.bottom=-(o+30),s.bottom=25),r.data("animating")?(r.stop(),i.stop()):(r.css(c),t.addClass("con-animating")),t.css(s),r.data("animating",!0).animate(u,{label:"desktopWidgetsClose",done:function(){t.removeAttr("style"),t.removeClass("con-animating"),r.removeAttr("style").data("animating",!1)}}),e.widgetsType.notificationDisplayed){Zr(n);var l={};l[eo(e)?"top":"bottom"]=0,i.animate(l,{label:"desktopNotificationSlideClosed"})}},io=function(e,t,n){var i=t.find(".con-notch"),r={},o=to(e,n);return r[eo(e)?"top":"bottom"]=function(e,t){return Ar(e)?13:65*t+13}(e,o),"tab-widgets-content"===e.state?(i.animate(r,{label:"adjustNotch"}),!1):(i.css(r),!0)},ro=function(e){var t=e.$concierge;e.engagementWidgets.globalSettings.hideMoxieBranding&&t.addClass("hide-moxie")},oo=function(e,t){"object"==typeof window.visualViewport&&e.widgetsType.resetKeyboardOffset();var n=e.$concierge.find("#concierge-widget-area");"tab-widgets-content"===e.state&&(n.hasClass("con-animating")?n.stop():n.css({opacity:1,right:75,display:"block"}),t.css({display:"block"}),n.addClass("con-animating").removeClass("con-open").animate({opacity:0,right:50},{label:"desktopCloseArea",done:function(){delete e.widgetsType.$areaAnimate,n.removeAttr("style"),n.removeClass("con-animating"),t.removeAttr("style")}}),e.state="tab-widgets",e.widgetsType.$areaAnimate=n)},ao=function(e){var t=e.$concierge.find("#concierge-widgets"),n=e.$concierge.find("#concierge-tab");"tab"===e.state?(e.$concierge.addClass("with-widgets").removeClass("con-closed"),n.addClass("con-pressed"),n.attr("aria-expanded","true"),e.state="tab-widgets",function(e,t,n){var i=e.widgetsType.getNotification(),r=t.children("ul").first(),o=r.height(),a=r.children("li").length,s={height:o+50+15},c={opacity:0},u={opacity:1};if(eo(e)?(c.top=-(50*a-10),u.top=40,s.top=25):(c.bottom=-(o+30),u.bottom=-10,s.bottom=25),r.data("animating")?(r.stop(),i.stop()):(r.css(c),t.css(s),t.addClass("con-animating")),r.data("animating",!0).animate(u,{label:"desktopWidgetsOpen",done:function(){t.removeAttr("style"),t.removeClass("con-animating"),r.removeAttr("style").data("animating",!1)}}),tr(e.wmState)){var l={},d=Rr(e.wmState.notification.spot),g=65*to(e,d);1===d.length&&(l[eo(e)?"top":"bottom"]=g),i.animate(l,{label:"desktopNotificationSlideOpen",done:function(){delete n.$notifAnimate}}),n.$notifAnimate=i}}(e,t,this)):"tab-widgets-content"===e.state?(e.$concierge.find("#concierge-widget-area").removeClass("con-open"),n.removeClass("con-pressed"),n.attr("aria-expanded","false"),e.$concierge.removeClass("with-widgets"),so(e),e.state="tab",no(e,t,this),e.$concierge.addClass("con-closed")):(n.removeClass("con-pressed"),n.attr("aria-expanded","false"),e.$concierge.removeClass("with-widgets"),e.state="tab",no(e,t,this),e.$concierge.addClass("con-closed"))},so=function(e){var t=e.$concierge.find("#concierge-widgets li.con-active");t.removeClass("con-active").removeClass("con-pressed"),t.find(".con-notch").remove(),t.find(".con-icon").attr("aria-expanded","false");var n=e.$concierge.find("#concierge-widget-area .concierge-widget.con-active");e.openWidget&&e.hideWidget(!1),oo(e,n)},co=function(e,t){var n=t.parameters,i=t.engagementId,r=Rr(t.spot);if(!r.hasClass("con-active")){r.addClass("con-active").addClass("con-pressed"),r.find(".con-icon").attr("aria-expanded","true");var o=n.rule.source;return i&&"offer"!==o&&"notification"!==o&&"button"!==o&&(n.rule.source="internal"),t.execute(e)}e.openWidget&&e.openWidget!==t.name&&e.hideWidget(!1)},uo=function(){var e=Bt(this);e.addClass("con-pressed"),e.data("pressing",1),"concierge-tab"===e.attr("id")&&e.attr("aria-expanded","true"),e.find(".con-icon")&&e.find(".con-icon").attr("aria-expanded","true")},lo=function(){var e=Bt(this);1===e.data("pressing")&&(e.data("pressing",0),e.removeClass("con-pressed"),e.find(".con-icon")&&e.find(".con-icon").attr("aria-expanded","false"),"concierge-tab"===e.attr("id")&&e.attr("aria-expanded","false"))},go=function(){return'<div id="concierge" class="con-right con-closed<%= CON_CLOSED %>">\n  <button id="concierge-tab" type="button" aria-label="<%= CONCIERGE %>" aria-expanded="false" aria-haspopup="true">\n    <%= CONCIERGE_TAB_ICON_SVG %>\n  </button>\n  <div id="concierge-widgets"><ul id="concierge-widgets-ul"<%= CON_ROLE_ATTRIBUTE %>></ul></div>\n  <div id="concierge-widget-area" tabindex="0" role="dialog" aria-live="assertive" aria-label=""><div class="con-notch"><div class="con-notch-inner"></div></div></div>\n\n  <div id="con-notification" class="con-inactive" role="alert" aria-live="assertive">\n  \x3c!--\n    CON-5221: Don\'t include (causes JAWS and NVDA to read twice):\n    aria-labelledby="con-notification-title" aria-describedby="con-notification-body"\n  --\x3e\n    <div class="con-notch"><div class="con-notch-inner"></div></div>\n    <h2 id="con-notification-title" class="concierge-notification-title" aria-hidden="true" tabindex="0">Live Chat</h2>\n    <div class="con-notification-content">\n      <div class="con-notification-icon" aria-live="off" aria-hidden="true"></div>\n      <div id="con-notification-body" aria-hidden="true">\n      \x3c!--\n        CON-5221: Don\'t include (causes JAWS to skip reading):\n        aria-live="polite" aria-atomic="true"\n      --\x3e\n        <div class="con-notification-body" tabindex="0"></div>\n        <div class="con-notification-helptext"><%=NOTIFICATION_ANNOUNCE%></div>\n      </div>\n      <div class="con-notification-calltoaction" role="link" tabindex="0"></div>\n    </div>\n    <button class="con-x" aria-label="<%= CLOSE_ICON %>">\n      <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" enable-background="new 0 0 20 20" stroke-width="0">\n        <title><%= CLOSE_ICON %></title>\n        <polygon points="17.3,1.1 10.2,8.3 3.1,1.1 1.3,2.9 8.4,10 1.3,17.1 3.1,18.9 10.2,11.8 17.3,18.9 19.1,17.1 11.9,10 19.1,2.9 "/>\n      </svg>\n    </button>\n  </div>\n</div>\n'};function ho(e){this.html=go,this.cssType="desktop",this.notificationDisplayed=!1,this.visualViewportHasScroll=!1,this.visualViewportHasResize=!1;var t=this;this.start=function(){var n=e.$concierge.find("#concierge-tab"),o=e.$concierge.find("#concierge-widgets");n.on("mousedown",uo),n.onPassive("touchstart",uo),n.on("mouseleave",lo);var a=function(i){("click"===i.type||Ir(i.which))&&("click"===i.type&&n.removeClass("highlight"),Bt(this).removeClass("con-pressed").data("pressing",0).attr("aria-expanded","false"),_n(e.concierge,!1),Ln("bellClicked",{}),t.toggleWindow())};n.on("click",a),n.on("keypress",a),n.on("keyup",(function(e){_r(e.which)?Bt(this).addClass("highlight"):Er(e.which)?i(Bt(this)):Or(e.which)&&r(Bt(this))})),n.on("blur",(function(){Bt(this).removeClass("highlight")})),ct(o,"mousedown",dt("li"),uo),ct(o,"touchstart",dt("li"),uo,!0),ct(o,"mouseleave",dt("li"),lo);var s=function(t){("click"===t.type||Ir(t.which))&&(Bt(this).removeClass("con-pressed").data("pressing",0),Bt(this).find(".con-icon").attr("aria-expanded","false"),Rn((function(){return function(e,t){var n=Bt(t.target).closest("li"),i=n.data("spot"),r=or(e.wmState,i);if(r){if(r.buttonEnabled){var o=r.name,a=Mr(o),s=r.parameters;return n.removeClass("highlight"),(s=s||{}).rule=s.rule||{},s.rule.source="button",Rn((function(){if(!n.hasClass("con-active"))return co(e,r);e.hideWidget(!1)})).then((function(){return _n(e.concierge,!0,o),Ln("buttonClicked",{buttonName:a}),null}))}}else ye.log("DesktopWidgets: widgetsClicked: could not find widget for spot, "+i)}(e,t)})).catch((function(e){ye.log((e.stack,e.stack))})))};ct(o,"click",dt("li"),s),ct(o,"keypress",dt("li"),s);var c=function(n){if("click"===n.type||Ir(n.which)||Nr(n.which)){var i=Bt(n.target);if(i.hasClass("con-x")||i.closest(".con-x").length>0)gr(e.wmState);else{var r=e.wmState.notification;dr(e.wmState),r&&r.shouldDisplayBell()&&e.$concierge.hasClass("con-closed")&&(t.toggleWindow(),e.state="tab-widgets")}}};e.$concierge.find("#con-notification").on("click",c).on("keypress",c)},this.toggleWindow=function(){ao.call(this,e)},this.focusWidgetButton=function(t){e.$concierge.find("#concierge-widgets li[data-widget="+t+"] .con-icon").focus()};function n(e,t,n){if(tr(e.wmState)){n=n||{};var i=0,r=e.wmState.notification,o=Rr(r.spot);o.length>0&&!Ar(e)&&e.$concierge.hasClass("with-widgets")&&(i=65*to(e,o)),n[eo(e)?"top":"bottom"]=i,t.css(n);var a=!0;if(r.spot){var s=Qi(e.wmState,r.spot);s.widget&&s.widget.preferredSpotName()===r.preferredSpotName()&&(a=!1)}a?function(e){e.addClass("free-floating")}(t):function(e){e.removeClass("free-floating")}(t)}}this.makeWidgetActive=function(e){e.addClass("con-active")},this.makeWidgetInactive=function(e){e.removeClass("con-active")},this.openWidget=function(t){var n=t.name,i=e.$concierge.find("#concierge-widget-area");!function(e,t){var n={kb:"K B Engagement Widget",chat:"Live Chat",kbot:"Live Chat",email:"Email Engagement Widget"}[e]||"";t.attr("aria-label",n)}(n,i);var r=e.widgetAreaForWidget(n),o=i.children(".concierge-widget.con-active").not(r);function a(){Bt(this).removeAttr("style")}this.makeWidgetInactive(o),this.makeWidgetActive(r),e.$concierge.find("#concierge-widgets li.con-active").removeClass("con-active").removeClass("con-pressed"),e.$concierge.find("#concierge-widgets li.con-active .con-icon").attr("aria-expanded","false"),"Tablet"===e.device&&r.find("iframe.widget-content").css({overflow:"auto"});var s=e.$concierge.find("#concierge-widgets li[data-widget="+n+"]");s.addClass("con-active").addClass("con-pressed"),s.find(".con-icon").attr("aria-expanded","true"),"tab-widgets-content"===e.state&&o.length>0&&(ye.log("openWidget(): invoked and willHide sent to already opened widget -"+o.data("widget")),ro(e),e.postMessageToWidget(o.data("widget"),"willHide"),r.css({opacity:.3}).animate({opacity:1},{label:"desktopOpenWidget",done:a}),o.css({display:"block",position:"absolute",top:2,height:"calc(100% - 4px)",width:"100%","padding-right":"4px",opacity:1,"z-index":100}).animate({opacity:0},{label:"desktopCloseWidget",done:a})),function(e,t){var n=e.$concierge.find("#concierge-widget-area");io(e,n,t)&&(n.hasClass("con-animating")?n.stop():n.css({opacity:0,right:50,display:"inline-block"}),ro(e),n.addClass("con-animating").addClass("con-open").animate({opacity:1,right:75},{label:"desktopOpenArea",done:function(t,i){delete e.widgetsType.$areaAnimate,n.removeAttr("style"),n.removeClass("con-animating"),i||"object"!=typeof window.visualViewport||e.widgetsType.applyKeyboardOffset()}})),e.state="tab-widgets-content",e.widgetsType.$areaAnimate=n}(e,s)},this.closeWidgets=function(){e.$concierge.find("#concierge-widgets li.con-active").removeClass("con-active").removeClass("con-pressed"),e.$concierge.find("#concierge-widgets li.con-active .con-icon").attr("aria-expanded","false");var t=e.$concierge.find("#concierge-widget-area .concierge-widget.con-active");this.makeWidgetInactive(t),t.removeAttr("style"),oo(e,t),e.$concierge.find("#concierge-widget-area").removeClass("con-open"),e.state="tab"},this.getNotification=function(){return e.$concierge.find("#con-notification")},this.getNotificationBody=function(){return e.$concierge.find("#con-notification-body")},this.getNotificationTitle=function(){return e.$concierge.find("#con-notification-title")},this.setAriaHidden=function(e){this.getNotificationBody().attr("aria-hidden",e),this.getNotificationTitle().attr("aria-hidden",e)},this.canDisplayNotification=function(){return!this.notificationDisplayed&&!e.$concierge.hasClass("con-open-widget")},this.viewportHandler=function(){var t=Ce("concierge");t&&!this.conciergePendingUpdate&&(this.conciergePendingUpdate=Jt(function(){var n;delete this.conciergePendingUpdate,0===e.tabStyle.verticalAnchor?n=window.visualViewport.offsetTop:(n=0,oe()>window.visualViewport.height&&(n=window.visualViewport.height-oe()+window.visualViewport.offsetTop)>0&&(n=0)),t.style.transform="translateY("+n+"px) scale("+1/window.visualViewport.scale+")"}.bind(this),"desktopViewportHandler"))}.bind(this),this.applyKeyboardOffset=function(){this.visualViewportHasScroll||(window.visualViewport.addEventListener("scroll",this.viewportHandler),this.visualViewportHasScroll=!0),this.visualViewportHasResize||(window.visualViewport.addEventListener("resize",this.viewportHandler),this.visualViewportHasResize=!0)},this.resetKeyboardOffset=function(){this.visualViewportHasScroll&&(window.visualViewport.removeEventListener("scroll",this.viewportHandler),this.visualViewportHasScroll=!1),this.visualViewportHasResize&&(window.visualViewport.removeEventListener("resize",this.viewportHandler),this.visualViewportHasResize=!1)},this.updateNotification=function(){var t=this.getNotification();n(e,t,{})},this.displayNotification=function(){var t=this;this.notificationDisplayed=!0;var i=this.getNotification();i.addClass("con-active").removeClass("con-inactive"),this.setAriaHidden("false"),i.removeAttr("style");n(e,i,{opacity:0}),i.animate({opacity:1},{label:"desktopShowNotification",done:function(e,n){delete t.$notifAnimate,n||"object"!=typeof window.visualViewport||t.applyKeyboardOffset()}}),t.$notifAnimate=i},this.closeNotification=function(){"object"==typeof window.visualViewport&&this.resetKeyboardOffset();var e=this;this.notificationDisplayed=!1;var t=this.getNotification();t&&(t.animate({opacity:0},{label:"desktopHideNotification",done:function(){delete e.$notifAnimate,t.addClass("con-inactive").removeClass("con-active").removeAttr("style"),e.setAriaHidden("true")}}),e.$notifAnimate=t)},this.openConcierge=function(t){"tab-widgets-content"!==e.state&&(e.state="tab-widgets");var n=e.$concierge.find("#concierge-widgets");e.$concierge.addClass("with-widgets").removeClass("con-closed");var i=e.$concierge.find("#concierge-tab");if(i.addClass("con-pressed"),i.attr("aria-expanded","true"),n.addClass("con-visible"),t)return co(e,t)};var i=function(t){if(!Ar(e)){var n=null;1===(n="concierge-tab"===t.attr("id")?Bt("#concierge-widgets-ul li").last():t.prev()).length?(n.find(".con-icon").focus(),n.addClass("highlight")):Bt("#concierge-tab").focus().addClass("highlight")}},r=function(t){if(!Ar(e)){var n=null;1===(n="concierge-tab"===t.attr("id")?Bt("#concierge-widgets-ul li").first():t.next()).length?(n.find(".con-icon").focus(),n.addClass("highlight")):Bt("#concierge-tab").focus().addClass("highlight")}};this.createWidgetElement=function(t){var n=Ar(e)?"":' role="menuitem"',o=e.concierge.getTranslation(Mr(t.name),"title"),a="";t.buttonEnabled||(a="disabled");var s=Bt('<li data-spot="'+t.spot+'" data-widget="'+t.name+'"'+n+'><button type="button" aria-expanded="false" class="con-icon" '+a+' aria-label="'+o+'">'+t.icon.svg+"</button></li>"),c=s.find("svg");c.length>0&&Pr(c[0]);var u=s.find(".con-icon");return u.on("keyup",(function(e){_r(e.which)?s.addClass("highlight"):Er(e.which)?i(s):Or(e.which)&&r(s)})),u.on("blur",(function(){s.removeClass("highlight")})),s},this.updateWidgetElement=function(t){var n=Rr(t.spot);if(n.length>0){n.attr("data-widget",t.name);var i=e.concierge.getTranslation(Mr(t.name),"title"),r=n.find("button");r.attr("aria-label",i),r.html(t.icon.svg);var o=n.find("svg");o.length>0&&Pr(o[0])}},this.addWidget=function(t){ye.log("DesktopWidgets: addWidget:",t.name,t);var i=Bt("#concierge-widgets ul"),r=this.createWidgetElement(t);return i.append(r[0]),Jr(e,eo(e)),n(e,this.getNotification()),Ar(e)&&e.$concierge.removeClass("con-closed"),r};var o=function(t){var n={right:e.tabStyle.horizontalOffset,bottom:""},i=window.pageYOffset;0===e.tabStyle.verticalAnchor?n.top=e.tabStyle.verticalOffset+i:n.top=i+oe()-(e.tabStyle.verticalOffset+50),t.css(n)},a=function(t){var n={right:e.tabStyle.horizontalOffset};0===e.tabStyle.verticalAnchor?n.top=e.tabStyle.verticalOffset:n.bottom=e.tabStyle.verticalOffset,t.css(n)};this.fixPosition=function(e,t){"javascript"===e?(t.addClass("position-method-javascript"),ye.log("Concierge Client: PositionMethod - Javascript"),this.scrollHandler||(this.scrollHandler=function(){o(t)},ot(window,"scroll",this.scrollHandler)),o(t)):a(t)},this.beforeAppend=function(t){var n=[],i={right:e.tabStyle.horizontalOffset};a(t),eo(e)?n.push("con-top"):n.push("con-bottom"),t.addClass(n.join(" ")),t.css(i)},this.destroy=function(){Zr(this),this.scrollHandler&&at(window,"scroll",this.scrollHandler),Bt("#concierge-style-desktop").remove(),this.resetKeyboardOffset()}}function fo(e){this.html=function(){return'<div id="concierge" class="con-right con-closed /DEVICE/">\n    <div id="concierge-backdrop"></div>\n    <button id="concierge-tab" type="button" aria-label="<%= CONCIERGE %>" aria-expanded="false">\n        <%= CONCIERGE_TAB_ICON_SVG %>\n    </button>\n    <div id="concierge-widgets">\n      <div class="con-widgets"><ul id="concierge-widgets-ul"<%= CON_ROLE_ATTRIBUTE %>></ul></div>\n      <div class="con-notch con-notch1"></div>\n      <div class="con-notch con-notch2"></div>\n    </div>\n    <div id="concierge-widget-area" role="dialog" aria-live="assertive" aria-label=""></div>\n\n    <div id="con-notification" role="alert" aria-live="assertive" class="con-inactive">\n    \x3c!--\n      CON-5221: Don\'t include (causes JAWS and NVDA to read twice):\n      aria-labelledby=" con-notification-title" aria-describedby="con-notification-body"\n    --\x3e\n      <h2 id="con-notification-title" class="concierge-notification-title" aria-hidden="true" tabindex="0">Notification</h2>\n      <div class="con-notification-content">\n        <div class="con-notification-icon" aria-live="off" aria-hidden="true"></div>\n        <div id="con-notification-body" class="con-notification-body" tabindex="0" aria-hidden="true"></div>\n        \x3c!--\n          CON-5221: Don\'t include (causes JAWS to skip reading):\n          aria-live="polite" aria-atomic="true"\n        --\x3e\n        <div class="con-notification-calltoaction" role="link" tabindex="0"></div>\n      </div>\n      <button class="con-x" aria-label="<%= CLOSE_ICON %>">\n        <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" enable-background="new 0 0 20 20" stroke-width="0">\n          <title><%= CLOSE_ICON %></title>\n          <polygon points="17.3,1.1 10.2,8.3 3.1,1.1 1.3,2.9 8.4,10 1.3,17.1 3.1,18.9 10.2,11.8 17.3,18.9 19.1,17.1 11.9,10 19.1,2.9 "/>\n        </svg>\n      </button>\n    </div>\n</div>\n'},this.cssType="mobile",this.openWidgetCount=0,this.bodyOrigStyle="",this.bodyOrigClasses="",this.htmlOrigStyle="",this.htmlOrigClasses="",this.start=function(){var t=this;navigator.userAgent.match(/instagram/i)&&navigator.userAgent.match(/iphone/i)&&(e.$concierge.addClass("instagram"),e.$concierge.find("#concierge-widget-area").css("height",window.innerHeight+"px")),e.$concierge.find("#concierge-tab").onPassive("touchstart",(function(){Bt(this).addClass("con-pressed").attr("aria-expanded","true"),function(e){var t=e.$concierge.find("#concierge-widgets");if(po(e,t),Ar(e)){var n=Qi(e.wmState,"single").widget;ye.log("widget "+n.name+" clicked");var i=Mr(n.name);_n(e.concierge,!0,n.name),Ln("buttonClicked",{buttonName:i}),n.parameters.rule.source="button",n.execute(e)}else!function(e){e.$concierge.hasClass("con-open")||!e.shouldDisplayBell?vo(e):function(e){var t=e.$concierge.find("#concierge-widgets");e.$concierge.find("#concierge-tab").attr("aria-expanded","true"),po(e,t),t.data("animation","opening"),e.$concierge.removeClass("con-pressed").removeClass("con-closed");var n=t.attr("style");t.removeAttr("style");var i=t.height();void 0===n||!1===n?t.css({overflow:"hidden",opacity:0,height:0}):t.attr("style",n);t.animate({height:i,opacity:1},{label:"mobileOpenMenu",done:function(){t.data("animation",!1),t.removeAttr("style"),e.$concierge.addClass("con-open")}})}(e)}(e)}(e)})).on("touchend",(function(){Bt(this).removeClass("con-pressed")})),e.$concierge.onPassive("touchstart",".con-widgets li",(function(){Bt(this).addClass("con-pressed"),Bt(this).find(".con-icon").attr("aria-expanded","true")})).on("touchend",".con-widgets li",(function(){var t=Bt(this);t.removeClass("con-pressed"),t.find(".con-icon");var n=t.data("spot"),i=or(e.wmState,n);if(i){var r=i.name;return i.parameters.rule.source="button",ye.log("widget "+r+" clicked"),i.execute(e).then((function(){return _n(e.concierge,!0,r),Ln("buttonClicked",{buttonName:Mr(r)}),!1}))}ye.log("MobileWidgets: widgetsClicked: could not find widget for spot, "+n)})),e.$concierge.find("#concierge-backdrop").on("click",(function(){hr(e.wmState),vo(e)}));var n=function(t){if("click"===t.type||Ir(t.which)||Nr(t.which)){var n=Bt(t.target);n.hasClass("con-x")||n.closest(".con-x").length>0?gr(e.wmState):dr(e.wmState)}};e.$concierge.find("#con-notification").on("click",n),e.$concierge.find("#con-notification").on("keypress",n);var i=!1;this.orientationListener=function(){if(t.notificationDisplayed){var e=t.getNotification();i&&clearTimeout(i),i=setTimeout((function(){i=!1,e.css({width:ae()})}),500)}},window.addEventListener("orientationchange",this.orientationListener)},this.focusWidgetButton=function(t){Ar(e)?e.$concierge.find("#concierge-tab").focus():e.$concierge.find("#concierge-widgets li[data-widget="+t+"]").focus()};this.addScrollFix=function(){var e=Bt("html");this.htmlOrigStyle=e.attr("style"),this.htmlOrigClasses=e.attr("class"),e.attr("style",""),e.attr("class",""),e.addClass("concierge-modal-displayed");var t=Bt("body");this.bodyOrigStyle=t.attr("style"),this.bodyOrigClasses=t.attr("class"),t.attr("style",""),t.attr("class",""),t.addClass("concierge-modal-displayed"),this.scrollFixApplied=!0},this.removeScrollFix=function(){if(this.scrollFixApplied){var e=Bt("html");e.removeClass("concierge-modal-displayed"),e.attr("style",this.htmlOrigStyle),delete this.htmlOrigStyle,e.attr("class",this.htmlOrigClasses),delete this.htmlOrigClasses;var t=Bt("body");t.removeClass("concierge-modal-displayed"),t.attr("style",this.bodyOrigStyle),delete this.bodyStyleRemoved,t.attr("class",this.bodyOrigClasses),delete this.bodyOrigClasses,Bt("#concierge-widget-area").css({top:""}),delete this.scrollFixApplied}},this.makeWidgetActive=function(e){e.length>0&&(0===this.openWidgetCount&&this.addScrollFix(),e.addClass("con-active"),this.openWidgetCount+=e.length)},this.makeWidgetInactive=function(e){e.length>0&&(e.removeClass("con-active"),this.openWidgetCount-=e.length,0===this.openWidgetCount&&this.removeScrollFix())};this.openWidget=function(t){var n=t.name;!function(e,t){var n={kb:"K B Engagement Widget",chat:"Live Chat",kbot:"Live Chat",email:"Email Engagement Widget"}[e]||"";t.attr("aria-label",n)}(n,e.$concierge.find("#concierge-widget-area"));var i=e.widgetAreaForWidget(n),r=e.$concierge.find("#concierge-widget-area .concierge-widget.con-active").not(i),o=this;this.makeWidgetActive(i),this.$widgetAnimating=i,function(e){var t=e.$concierge;e.engagementWidgets.globalSettings.hideMoxieBranding&&t.addClass("hide-moxie")}(e),i.attr("aria-expanded","true"),i.css({"z-index":1,opacity:0}).animate({opacity:1},{label:"mobileOpenWidget",done:function(){delete o.$widgetAnimating,o.makeWidgetInactive(r),r.attr("aria-expanded","false"),i.removeAttr("style")}}),vo(e)},this.closeWidgets=function(){var t=e.$concierge.find("#concierge-widget-area .concierge-widget.con-active"),n=this;t.css({opacity:1}).animate({opacity:0},{label:"mobileCloseWidgets",done:function(){ye.log("close complete"),n.makeWidgetInactive(t),t.removeAttr("style").attr("aria-expanded","false")}})},this.getNotification=function(){return e.$concierge.find("#con-notification")},this.getNotificationBody=function(){return e.$concierge.find("#con-notification-body")},this.getNotificationTitle=function(){return e.$concierge.find("#con-notification-title")},this.setAriaHidden=function(e){this.getNotificationBody().attr("aria-hidden",e),this.getNotificationTitle().attr("aria-hidden",e)},this.canDisplayNotification=function(){return!this.notificationDisplayed&&!e.$concierge.hasClass("con-open-widget")},this.fixPosition=function(e,t){if("javascript"===e){t.addClass("position-method-javascript"),ye.log("Concierge Client: PositionMethod - Javascript");var n=function(){var e=oe();t.css({top:e})};window.addEventListener("scroll",n),n()}};var t=!1,n=this;this.fixNotificationsUsingVisualViewport=function(){var e=Ce("con-notification");e&&(t=!1,e.style.transform="translateY("+window.visualViewport.offsetTop+"px) scale("+1/window.visualViewport.scale+")")},this.viewportHandler=function(){t||(t=!0,Jt(n.fixNotificationsUsingVisualViewport,"mobileNotifScrollFix"))},this.applyNotificationKeyboardOffset=function(){window.visualViewport.addEventListener("scroll",this.viewportHandler),window.visualViewport.addEventListener("resize",this.viewportHandler),this.viewportHandler()},this.resetNotificationKeyboardOffset=function(){window.visualViewport.removeEventListener("scroll",this.viewportHandler),window.visualViewport.removeEventListener("resize",this.viewportHandler)},this.updateNotification=function(){},this.displayNotification=function(t){var n=this;this.notificationDisplayed=!0,ye.log("opening notification.");var i=this.getNotification();i.data("parameters",t.parameters),i.addClass("con-active").removeClass("con-inactive"),this.setAriaHidden("false");var r="0px";e.engagementWidgets.globalSettings.notificationMobileVerticalOffset&&(r=e.engagementWidgets.globalSettings.notificationMobileVerticalOffset.toString()+"px"),n.$notifAnimating=i,i.css({top:"-150px"}).animate({top:r},{label:"mobileShowNotification",done:function(){n.$notifAnimating=!1;var e=ae();i.css({width:e}),"object"==typeof window.visualViewport&&n.applyNotificationKeyboardOffset()}})},this.closeNotification=function(){"object"==typeof window.visualViewport&&this.resetNotificationKeyboardOffset();var e=this;this.notificationDisplayed=!1;var t=this.getNotification();t&&t.animate({opacity:0},{label:"mobileHideNotification",done:function(){t.addClass("con-inactive").removeClass("con-active").removeAttr("style"),e.setAriaHidden("true")}})},this.openConcierge=function(){},this.destroy=function(){this.$notifAnimating&&(this.$notifAnimating.stop(!0,!0),delete this.$notifAnimating),this.$widgetAnimating&&(this.$widgetAnimating.stop(!0,!0),delete this.$widgetAnimating),this.orientationListener&&(window.removeEventListener("orientationchange",this.orientationListener),delete this.orientationListener),this.removeScrollFix(),Bt("#concierge-style-mobile").remove()},this.createWidgetElement=function(t){var n=Ar(e)?"":' role="menuitem"',i=e.concierge.getTranslation(Mr(t.name),"title");return Bt('<li data-spot="'+t.spot+'" data-widget="'+t.name+'"'+n+'><button type="button" aria-expanded="false" class="con-icon" aria-label="'+i+'">'+t.icon.svg+'</button><span class="con-mobile-primary-menu">'+i+"</span></li>")},this.updateWidgetElement=function(t){var n=Rr(t.spot),i=n.find("button");if(Ar(e)){var r=Bt("#concierge-tab");i.pushAll(r),n.pushAll(r)}n.attr("data-widget",t.name),n.attr("data-spot",t.spot);var o=e.concierge.getTranslation(Mr(t.name),"title");n.find(".con-mobile-primary-menu").text(o),i.attr("aria-label",o),i.html(t.icon.svg);var a=i.find("svg");a.length>0&&Pr(a[0])},this.addWidget=function(t){ye.log("MobileWidgets: addWidget:",t.name,t);var n=Bt("#concierge-widgets ul"),i=this.createWidgetElement(t);if(n.append(i[0]),Jr(e,!0),Ar(e)){var r=Bt("#concierge-tab");return r.html(t.icon.svg),r.attr("data-widget",t.name),r.attr("data-spot",t.spot),r}return i}}function po(e,t){var n=t.data("animation");return n&&("opening"===n?(t.stop(),e.$concierge.addClass("con-open")):"closing"===n&&t.stop(),t.data("animation",!1)),n}function vo(e){var t=e.$concierge.find("#concierge-widgets");(e.$concierge.find("#concierge-tab").attr("aria-expanded","false"),e.$concierge.hasClass("con-closed"))||"closing"!==t.data("animation")&&(po(e,t),t.data("animation","closing"),e.$concierge.removeClass("con-pressed").removeClass("con-open"),t.css({overflow:"hidden"}),t.animate({opacity:0,height:0},{label:"mobileCloseMenu",done:function(){t.data("animation",!1),t.removeAttr("style"),e.$concierge.addClass("con-closed")}}))}function mo(){}mo.prototype.markChat=function(e,t,n){var i=Date.now();return e.transient_data?(e.transient_data.vp_data.chat.session_id=Math.abs(parseInt(t)),"start"===n&&(e.transient_data.vp_data.chat.start_time=i),"end"===n&&(e.transient_data.vp_data.chat.end_time=i)):e.transient_data={vp_data:{chat:{session_id:t,start_time:i}}},ye.log("Marking chat "+t+" as "+n),e};var wo=function(e,t){ht(this,t),this.parameters=this.parameters||{},this.configuration=this.configuration||{},this.configuration.connectorUrl=e.serviceUrl.connector,function(e,t){var n=t.widgetManager;e.priority=1,e.state=0,e.buttonEnabled=!0,e.preferredSpotName=function(){return this.name},e.getSpotName=function(){return this.spot},e.label=function(){var e=me(this,"parameters","rule","name");return e?this.name+":"+e:this.name},e.checkAvailability=function(){return A.resolve({status:!0})},e.shouldDisplayBell=function(){return!0},e.beforeNotify=function(e){return A.resolve(yo(e,!0))},e.beforeAdd=function(e){return A.resolve(yo(e,!0))},e.beforeLoad=function(){},e.getRemoteURL=function(){if(this.remoteURL)return this.remoteURL},e.hideWidget=function(){n.wmState.open===this&&n.hideWidget(!1)},e.closeWidget=function(){if(this.spot){var e=Qi(n.wmState,this.spot);this.hasFinished=!0,e.widget===this&&e.reactive&&e.reactive!==this&&rr(n.wmState,e.reactive)}},e.destroy=function(e){},e.unload=function(){0!==this.state&&(n.widgetAreaForWidget(this.name).remove(),this.state=0)},e.execute=function(e){var t=this;return e.concierge.cacheManager.removeWidgetCache(this.name,"widget-closed").then((function(){e.showWidget(t)}))}}(this,e)};function yo(e,t){return(e=e||{}).status=t,e}var bo=function(e){function t(t,n){e.call(this,t,n),No(this,t),function(e,t){var n=t.widgetManager,i=t.cacheManager;e.beforeAdd=function(e){var r,o,a=e.ref,s=e.parameters,c=Co(n.device),u=a.name,l=a.getEngagmentId(),d=a.getSuspendedSession(),g=a.getActiveSession();if(!e.ruleSettings)throw new Error("obj.ruleSettings is missing");return o=e.ruleSettings.skip_chat_queue_status_check?t.serviceUrl.connector+"/connector/channels/portal_with_service_line/"+s.portalId+"/device/"+c:t.serviceUrl.connector+"/connector/channels/portals_with_queue_status/"+s.portalId+"/device/"+c,t.httpGet(o).then((function(o){var c;if(e.ruleSettings.skip_chat_queue_status_check)s.serviceLineId||(s.serviceLineId=o.response.serviceLineId,s.serviceLine=o.response.serviceLineName),t.serviceLines.setName(s.serviceLineId,s.serviceLine),c=o.response;else{if(s.serviceLineId||(s.serviceLineId=o.response.queueStatus.id,s.serviceLine=o.response.queueStatus.name),t.serviceLines.setName(s.serviceLineId,s.serviceLine),!o.response)throw new Error("status.response evaluates to false");var h=s.rule&&s.rule.source?s.rule.source:"internal";if(!Tr(h)&&e.ruleSettings.hide_on_demand_chat_when_service_line_is_closed&&"true"!==o.response.queueStatus.queueopen)throw new Error("service line is closed");if(r="true"===o.response.queueStatus.slotavailable,!Tr(h)&&e.ruleSettings.hide_on_demand_chat_when_no_available_agent_slots&&!r&&!d&&!g&&!e.engagementId)throw new Error("spot not available");qr(e.ruleSettings.check_queue_wait_time_for_on_demand_chat,me(o,"response","queueStatus","holdtime"),e.ruleSettings.queue_wait_time,d,g),c=o.response.portalData}s.widgetpath=t.scriptLocation+"/widgets/chat/"+t.assetVersion.widgets+"/",s.langOptions=t.langOptions;var f=0;c.deviceList.length>1&&(f=Co(n.device));var p="<%=host %>/netagent/cimlogin.aspx?questid=<%=questId %>&portid=<%=portalId %>&defaultStyleId=<%=styleId %>&widgetpath=<%=widgetpath %>&flyout=1";p=Yr(p)({host:s.host,questId:c.deviceList[f].questid,styleId:c.deviceList[f].styleid,portalId:c.deviceList[f].styleid,widgetpath:t.scriptLocation+"/widgets/chat/"+t.assetVersion.widgets+"/"}),("string"==typeof a.remoteURL||a.remoteURL instanceof String)&&(a.remoteURL={}),a.portalId=s.portalId,a.remoteURL[s.portalId]=p,a.oldRemoteUrl=p,navigator.appVersion&&-1!==navigator.appVersion.indexOf("MSIE 10")?a.remoteURL[s.portalId]+="&fullScreen=false":"Mobile"!==n.device&&"Tablet"!==n.device||(a.remoteURL[s.portalId]+="&fullScreen=true"),e.engagementId&&e.engagementId!==l&&(l=!1);var v=0!==n.notificationType;return s.questId=c.deviceList[f].questid,s.styleId=c.deviceList[f].styleid,a.shouldReplaceIframeSrc=!0,d&&l?(v&&n.widgetsType.closeNotification(),i.removeWidgetCache(u,"suspended_session",!0),void(a.autoOpen=!0)):n.loadingActiveWidgets&&g&&l?(a.origRemoteURL=a.remoteURL,a.oldRemoteUrl=a.remoteURL[s.portalId],a.remoteURL[s.portalId]=Yr(g)({host:s.host,widgetpath:t.scriptLocation+"/widgets/chat/"+t.assetVersion.widgets+"/"}),navigator.appVersion&&-1!==navigator.appVersion.indexOf("MSIE 10")?a.remoteURL[s.portalId]+="&fullScreen=false":"Mobile"!==n.device&&"Tablet"!==n.device||(a.remoteURL[s.portalId]+="&fullScreen=true"),t.cacheManager.getWidgetCache(u,"widget-closed")||v?n.loadWidget(a):void(a.autoOpen=!0)):void 0})).then((function(){return e.status=!0,e}))},e.beforeNotify=function(i){var r=t.rulesEngine,o=Co(n.device),a=60;r.queueWaitTime&&(a=r.queueWaitTime());var s=i.rule,c=null;s&&s.id?c=s.id:ye.log("Chat Widget:beforeNotify: rule id missing from obj:",i);var u=i.parameters,l=t.serviceUrl.connector+"/connector/channels/queue_status/"+u.portalId+"/device/"+o;return t.httpGet(l).then((function(r){var o=r.response.id;if(u.serviceLineId=r.response.id,u.serviceLine=r.response.name,t.serviceLines.setName(u.serviceLineId,u.serviceLine),t.cacheManager.getWidgetCache(e.name,"suspended_session",!0))return i.status=!1,function(e,t){for(var n=e.getData("profileJSON"),i=n.session.visits.length-1,r=0;r<n.session.visits[i].journey.length;r++)if(n.session.visits[i].journey[r].engagements)for(var o=0;o<n.session.visits[i].journey[r].engagements.length;o++)if(n.session.visits[i].journey[r].engagements[o].id===t)return n.session.visits[i].journey[r].engagements.splice(o,1),e.setData("profileJSON",JSON.stringify(n));return A.resolve()}(t.cacheManager,i.engagementId).then((function(){return i}));var s=parseInt(r.response.holdtime||"0",10);if("true"===r.response.slotavailable&&"true"===r.response.queueopen&&"true"===r.response.agentavailable&&s<a)i.status=!0;else{var l=function(e){var t=arguments;e=pt(e);for(var n=1;n<arguments.length;n++)mt(e,t[n]);return e}({},n.getEngagementRecord(i.engagementId));"false"===r.response.queueopen?(l.chat.missed_reason=2,Cn(t,"service-line-closed",o,c,"proactive")):s>=a?(l.chat.missed_reason=3,Cn(t,"wait-too-long",o,c,"proactive")):"false"===r.response.agentavailable&&(l.chat.missed_reason=1,Cn(t,"no-agent-available",o,c,"proactive")),n.setEngagementRecord(i.engagementId,l),i.status=!1}return i}))},e.startNewSession=function(){var n=t.widgetManager,r=Co(n.device),o=t.serviceUrl.connector+"/connector/channels/queue_status/"+e.parameters.portalId+"/device/"+r;return t.httpGet(o).then((function(r){if(e.shouldReplaceIframeSrc){var o=e.getRemoteURL();"true"!==r.response.slotavailable&&(o=Io(i,e.oldRemoteUrl)),navigator.appVersion&&-1!==navigator.appVersion.indexOf("MSIE 10")?o+="&fullScreen=false":"Mobile"!==n.device&&"Tablet"!==n.device||(o+="&fullScreen=true"),Bt("#concierge-widget-chat .widget-content").attr("src",o)}else Bt("#concierge-widget-chat iframe.widget-content").replaceWith('<iframe frameborder="no" class="widget-content"></iframe>'),t.widgetManager.writeSrcToIframe(e.name)}))},e.checkAvailability=function(e){var i=e.parameters,r=Co(n.device);if(!e.ruleSettings)return A.resolve({status:!1});var o=t.serviceUrl.connector+"/connector/channels/queue_status/"+i.portalId+"/device/"+r;return t.httpGet(o).then((function(t){return t.response?e.ruleSettings.hide_on_demand_chat_when_service_line_is_closed&&"true"!==t.response.queueopen?{status:!1}:e.ruleSettings.hide_on_demand_chat_when_no_available_agent_slots&&"true"!==t.response.slotavailable?{status:!1}:e.ruleSettings.check_queue_wait_time_for_on_demand_chat&&parseInt(t.response.holdtime,10)>e.ruleSettings.queue_wait_time?{status:!1}:{status:!0}:{status:!1}})).catch((function(e){return ye.log("checkAvailability error thrown: "+e),{status:!1}}))},e&&e.titleBar&&(e.titleBar.onclick=function(){n.hideWidget(!1),Ln("widgetMinimized",{widgetName:e.name})})}(this,t)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(wo),So={};function Co(e){var t=So[e];return t||(t=0),t}So.Mobile=1,So.Tablet=2,So.Desktop=3;var _o=function(e){return parseInt(e)};function Io(e,t){var n,i=e.getVolatileData("moxie_channels_custom_data");if(function(e,t){if(e)for(var n=t.split("&"),i=0;i<n.length;i++){var r=n[i].split("=");0===i&&((r=r[0].split("?"))[0]=r[1]),e&&K(e,r[0])&&delete e[r[0]]}}(i,t),i){if("object"!=typeof i)try{i=JSON.parse(i)}catch(e){ye.log("Error parsing "+i+": err")}"object"==typeof i&&(n=i,0!==Object.keys(n).length)&&(t=t+"&"+function(e){for(var t=[],n=Object.keys(e),i=0;i<n.length;i++){var r=n[i];if(Array.isArray(e[r])){var o,a=[];for(o=0;o<e[r].length;o++)a.push(yt(r+"[]")+"="+yt(e[r][o]));t.push(a.join("&"))}else t.push(yt(r)+"="+yt(e[r]))}return t.join("&")}(i))}return t}function No(e,t){var n=t.widgetManager,i=t.cacheManager;e.getEngagmentId=function(){return i.getWidgetCache(this.name,"engagement_id",!0)},e.getActiveSession=function(){return i.getWidgetCache(this.name,"active_session")},e.getSuspendedSession=function(){return i.getWidgetCache(this.name,"suspended_session",!0)},e.closeWidget=function(){},e.getRemoteURL=function(){var e,t=this.remoteURL,n=this.parameters.portalId;return e="object"==typeof t?t[n]:t,Io(i,e)},e.updateBroadcastPayload=function(e,n){if(this.parameters){var i=this.parameters;if(i.portalId&&(n.portalId=i.portalId),i.serviceLineId){var r=i.serviceLineId;return n.serviceLineId=r,t.serviceLines.getName(r).then((function(e){return n.serviceLine=e,n}))}}return A.resolve(n)},e.handleChannelsMessage=function(e,t){var i=this.name;switch(ye.log("Event: "+e.call+" URL: "+e.url+" DATA: "+t.data),e.call){case"openSurvey":n.handleBroadcast(i,"surveyLoaded",{sessionId:_o(n.concierge.cacheManager.getWidgetCache(i,"sessionId"))}),n.widgetAreaIFrameForWidget(i).attr("src",e.url);break;case"setReturnFromSurvey":n.handleBroadcast(i,"surveyCompleted",{sessionId:_o(n.concierge.cacheManager.getWidgetCache(i,"sessionId"))}),n.hideWidget(!1);break;case"setFlyoutContent":n.widgetAreaIFrameForWidget(i).attr("src",e.url);break;case"chatFocus":"Tablet"===n.device&&"object"!=typeof window.visualViewport&&(n.makePositionAbsolute(),n.needsForceBlur=!0);break;case"chatBlur":break;case"getTabInfo":n.handleGetTabInfo(t,i);break;case"setChatInProgress":var r=parseInt(e.sessionId);0===e.sessionId&&"Tablet"===n.device&&"object"!=typeof window.visualViewport&&(n.makePositionAbsolute(),n.needsForceBlur=!0),n.handleSetChatInProgress(r,i,this.parameters),r>0&&n.handleBroadcast(i,"chatSessionStarted",{sessionId:r})}},e.beforeLoad=function(){t.widgetManager.channelsWidget=this}}var Eo=function(e){function t(t,n){e.call(this,t,n),this.baseHideWidget=this.hideWidget,this.hideWidget=function(){this.baseHideWidget(),this.closeWidget()}}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(wo);function Oo(e,t,n,i,r,o,a,s){Object.defineProperty(this,"name",{value:t,enumerable:!0,writable:!1}),Object.defineProperty(this,"maxLength",{value:n,enumerable:!0,writable:!1}),Object.defineProperty(this,"required",{value:i,enumerable:!0,writable:!1}),Object.defineProperty(this,"label",{value:r,enumerable:!0,writable:!1}),Object.defineProperty(this,"type",{value:o,enumerable:!0,writable:!1}),Object.defineProperty(this,"defaultvalue",{value:a,enumerable:!0,writable:!1}),Object.defineProperty(this,"options",{value:s,enumerable:!0,writable:!1}),this.hide=e}function To(){this.hide=!1,this.questions=[]}Oo.prototype.setAnswer=function(e){var t=void 0!==e.hide?e.hide:this.hide;if("16"===this.type||"15"===this.type||"4"===this.type||"6"===this.type){for(var n=0;n<this.options.length;n++)if(this.options[n].value===e.value){this.answer=e.value,this.hide=t;break}}else this.answer=e.value,this.hide=t},To.prototype.getQuestionByName=function(e){for(var t=0;t<this.questions.length;t++)if(this.questions[t].name===e)return this.questions[t];return null},To.prototype.loadQuestions=function(e){for(var t=0;t!==e.length;t++){var n=e[t],i=new Oo(!1,n.formatParameters.elementname,n.formatParameters.elementmaxlength,n.formatParameters.elementrequired,n.actualquestion,n.type,n.formatParameters.elementdefaultvalue||n.formatParameters.elementchecked,n.options);"14"===i.type?i.answer="true"===n.formatParameters.elementchecked:i.answer=i.defaultvalue,this.questions.push(i)}},To.load=function(e){var t=new To;t.hide=!0===e.hide;for(var n=e.questions?e.questions.length:0,i=0;i<n;i++){var r=e.questions[i],o=new Oo(r.hide,r.name,r.maxLength,r.required,r.label,r.type,r.defaultvalue,r.options);o.answer=r.answer,t.questions.push(o)}return void 0!==e.sendChatTranscript&&(t.sendChatTranscript=e.sendChatTranscript),t},To.prototype.toJson=function(){return JSON.stringify(this)};var ko=function(e){function t(t,n){e.call(this,t,n),No(this,t),function(e,t){var n=t.widgetManager,i=t.cacheManager;e.preferredSpotName=function(){return"chat"},e.titleBar.onclick=function(){sessionStorage.getItem("kbot-disableTitleClick")||(n.hideWidget(!1),Ln("widgetMinimized",{widgetName:"kbot"}),i.setWidgetCache("kbot","shouldReopen",!1,!1))},e.sendSearchGuid=function(e,n){var r={chat_session_id:e},o=n.kbPortalId,a=i.getWidgetCache("kbot","search-guid",!1);if(o&&a){var s=new XMLHttpRequest,c=t.serviceUrl.connector+"/connector/kb/suggestions/"+o+"/"+a;s.open("PUT",c,!0),s.setRequestHeader("Content-Type","application/json"),s.withCredentials=!1,s.onerror=function(){ye.log("Received failure response from connector endpoint for kb search_guid")},s.onreadystatechange=function(){this.readyState===XMLHttpRequest.DONE&&200===this.status&&(ye.log("Sent to kb: "+JSON.stringify(r)),i.removeWidgetCache("kbot","search-guid",!1))},s.send(JSON.stringify(r))}},e.prepareToLoad=function(r){var o,a=r.parameters,s="questionnaire-"+r.parameters.questId,c=t.serviceUrl.connector+"/connector/channels/questionnaire/"+a.questId+"/"+a.styleId;return t.httpGet(c).then((function(e){return r.parameters.parameters=e.response.parameters,(o=new To).loadQuestions(e.response.questions),t.onQuestionnaireLoadedCallbacks.doCallbacksAsync(o)})).then((function(){return i.setWidgetCache("kbot",s,o.toJson())})).then((function(){return sessionStorage.getItem("MoxieFlyout.chatInProgress")?e.autoOpen=!0:i.getWidgetCache("kbot","shouldReopen",!1)&&"null"===sessionStorage.getItem("MoxieFlyout.chatInProgress")&&(e.autoOpen=!0),e})).catch((function(t){return ye.log("kbot failed in prepare to load:"+JSON.stringify(t)),n.removeWidget(e),null}))},e.shouldRebuildIframe=function(){var e=this.getActiveSession();return i.getWidgetCache(this.name,"rebuildIframe",!1)&&!e},e.beforeAdd=function(r){var o,a,s=r.ref,c=r.parameters,u=Co(n.device),l=this.getEngagmentId(),d=this.getSuspendedSession(),g=this.getActiveSession(),h=i.getWidgetCache("kbot","active_kb_session");if(!r.ruleSettings)throw new Error("obj.ruleSettings is missing");return a=r.ruleSettings.skip_chat_queue_status_check?t.serviceUrl.connector+"/connector/channels/portal_with_service_line/"+c.portalId+"/device/"+u:t.serviceUrl.connector+"/connector/channels/queue_status/"+c.portalId+"/device/"+u,t.httpGet(a).then((function(e){if(r.ruleSettings.skip_chat_queue_status_check)c.serviceLineId||(c.serviceLineId=e.response.serviceLineId,c.serviceLine=e.response.serviceLineName),t.serviceLines.setName(c.serviceLineId,c.serviceLine);else{if(c.serviceLineId||(c.serviceLineId=e.response.id,c.serviceLine=e.response.name),t.serviceLines.setName(c.serviceLineId,c.serviceLine),c.serviceLineStatus={open:"true"===e.response.queueopen,slotAvailable:"true"===e.response.slotavailable},!e.response)throw new Error("status.response evaluates to false");if(!Tr(c.rule.source)&&r.ruleSettings.hide_on_demand_chat_when_service_line_is_closed&&"true"!==e.response.queueopen)throw new Error("service line is closed");if(o="true"===e.response.slotavailable,!Tr(c.rule.source)&&r.ruleSettings.hide_on_demand_chat_when_no_available_agent_slots&&!o&&!d&&!g&&!r.engagementId)throw new Error("slot not available");qr(r.ruleSettings.check_queue_wait_time_for_on_demand_chat,me(e,"response","queueStatus","holdtime"),r.ruleSettings.queue_wait_time,d,g)}if(c.widgetpath=t.scriptLocation+"/widgets/kbot/"+t.assetVersion.widgets+"/",c.langOptions=t.langOptions,r.ruleSettings.skip_chat_queue_status_check)return e;var n=t.serviceUrl.connector+"/connector/channels/portals/"+c.portalId;return t.httpGet(n)})).then((function(o){var a=0;o.response.deviceList.length>1&&(a=Co(n.device));(!s.remoteURL||"string"==typeof s.remoteURL||s.remoteURL instanceof String)&&(s.remoteURL={}),s.portalId=c.portalId,s.remoteURL[c.portalId]=Yr("<%=host %>/netagent/cimlogin.aspx?questid=<%=questId %>&portid=<%=portalId %>&defaultStyleId=<%=styleId %>&widgetpath=<%=widgetpath %>&flyout=1")({host:c.host,questId:o.response.deviceList[a].questid,styleId:o.response.deviceList[a].styleid,portalId:o.response.deviceList[a].styleid,widgetpath:t.scriptLocation+"/widgets/kbot/"+t.assetVersion.widgets+"/"}),s.hashedQuestId=o.response.deviceList[a].questid,s.hashedPortalId=o.response.deviceList[a].styleid,navigator.appVersion&&-1!==navigator.appVersion.indexOf("MSIE 10")?(c.fullScreen=!1,s.remoteURL[c.portalId]+="&fullScreen=false"):"Mobile"!==n.device&&"Tablet"!==n.device||(c.fullScreen=!0,s.remoteURL[c.portalId]+="&fullScreen=true"),r.engagementId&&r.engagementId!==l&&(l=!1);var u=0!==n.notificationType;if(c.questId=o.response.deviceList[a].questid,c.styleId=o.response.deviceList[a].styleid,i.getWidgetCache("kbot","suspended_session",!0)&&l)return u&&n.widgetsType.closeNotification(),e.shouldReplaceIframeSrc=!0,i.removeWidgetCache("kbot","suspended_session",!0),void(e.autoOpen=!0);var d=i.getWidgetCache("kbot","widget-closed");if(n.loadingActiveWidgets&&g&&l)return e.shouldReplaceIframeSrc=!0,s.origRemoteURL=s.remoteURL,s.oldRemoteUrl=s.remoteURL[c.portalId],s.remoteURL[c.portalId]=Yr(g)({host:c.host,widgetpath:t.scriptLocation+"/widgets/kbot/"+t.assetVersion.widgets+"/"}),d||u?n.loadWidget(e):void(e.autoOpen=!0);if(n.loadingActiveWidgets&&h&&l){var f=i.getWidgetCache("kbot","shouldReopen",!1);return d||u||!f?n.loadWidget(e):void(e.autoOpen=!0)}})).then((function(){return r.status=!0,r}))},e.beforeNotify=function(e){return A.resolve(yo(e,!1))},e.startNewSession=function(){var e=t.widgetManager.createEngagementRecord(this,"kb");i.setWidgetCache("kbot","engagement_id",e,!0),i.removeWidgetCache("kbot","active_session"),Bt("#concierge-widget-kbot iframe.widget-content").replaceWith('<iframe frameborder="no" class="widget-content"></iframe>'),t.widgetManager.writeSrcToIframe("kbot"),delete this.shouldReplaceIframeSrc},e.createChatEngagementRecord=function(){var e=t.widgetManager.createEngagementRecord(this,"chat");return i.setWidgetCache("kbot","engagement_id",e,!0),{id:e,data:t.widgetManager.getEngagementRecord(e)}}}(this,t)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(wo);var xo=function(e){function t(t,n){e.call(this,t,n),function(e,t){e.beforeAdd=function(n){if(n.parameters.langOptions=t.langOptions,!n.ruleSettings)throw new Error("obj.ruleSettings is missing");return e.parameters.ruleSettings=n.ruleSettings,n.status=!0,A.resolve(n)}}(this,t)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(wo);var Lo=function(e){function t(t,n){e.call(this,t,n),function(e,t){e.name="bell",e.priority=0,e.buttonEnabled=!1,e.icon=me(t,"widgetManager","engagementWidgets","conciergeTab","icon"),e.preferredSpotName=function(){return"bell"},e.execute=function(e){return A.resolve(null)}}(this,t)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(wo);var Wo=function(e){function t(t,n){e.call(this,t,n),this.engagement_type=5,function(e,t){var n=t.widgetManager;e.priority=0,e.shouldDisplayBell=function(){return!1},e.preferredSpotName=function(){return null},e.beforeAdd=function(e){if(Ar(n)){var i=n.wmState;if(null===i.spots.single.widget)return fr(i,new Lo(t,{rule:{source:"internal"},parameters:{}})).then((function(t){return yo(e,t.status)}))}return A.resolve(yo(e,!0))},e.execute=function(n){var i=this;if(!i.isExecuting){var r=this.parameters;return i.isExecuting=!0,"_blank"===r.linkStrategy?(Mo(t,r),wr(n.wmState,e),i._openTimeout=setTimeout((function(){i.isExecuting=!1,yr(n.wmState,e),delete i._openTimeout}),1e3),window.open(r.url,r.linkStrategy,"noopener")):t.logDisabled?window.open(r.url,r.linkStrategy,"noopener"):(window.addEventListener("GoMoxie:PriorityEvents",(function(){window.open(r.url,r.linkStrategy,"noopener")}),!1),wr(n.wmState,e),this._openTimeout=setTimeout((function(){delete i._openTimeout,window.open(r.url,r.linkStrategy,"noopener")}),3e3),Mo(t,r)),A.resolve(null)}},e.destroy=function(t){yr(t.wmState,e),this._openTimeout&&clearTimeout(this._openTimeout)}}(this,t)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(wo);function Mo(e,t){Ln("linkFollowed",{strategy:t.linkStrategy,url:t.url}),xn(e,t.url,t.linkStrategy,t.rule.id)}function Ao(e){e.bridgeListener=Do.bind(e),window.addEventListener("message",e.bridgeListener,!1)}function Do(e){var t,n=this.concierge,i=n.cacheManager,r=this.wmState;if("string"==typeof e.data&&"SessionCleared"!==e.data)try{t=JSON.parse(e.data)}catch(t){return ye.log("WidgetBridge received invalid JSON: ",t),void ye.log("Payload was:"+e.data)}else t=e.data;if(t&&t.call&&this.channelsWidget)this.channelsWidget.handleChannelsMessage(t,e);else{var o=t.widget;if(o){var a=this.engagementWidgets.widgets[o];if(a){var s=a.parameters;if(!Lr(o)){var c=Wr(o)&&"object"==typeof a.remoteURL?a.remoteURL[a.portalId]:a.remoteURL;if(void 0!==a.shouldReplaceIframeSrc&&c&&e.origin.toLowerCase()!==c.match(/^https?:\/\/[^/]+/)[0].toLowerCase()&&(e.origin!=="http://"+window.location.hostname||e.origin!=="https://"+window.location.hostname))return}var u=e.data,l=e.data.parameters;ye.log("["+u.type+"] message accepted from: "+e.origin);var d={},g=null,h=null;switch(u.type){case"focusEvent":"Tablet"===this.device&&"object"!=typeof window.visualViewport&&(this.makePositionAbsolute(),this.needsForceBlur=!0);break;case"blurEvent":"Tablet"===this.device&&"object"!=typeof window.visualViewport&&(this.needsForceBlur=!1);break;case"resetConcierge":jr(this,!0),this.removeWidget(a,!0),this.addWidget(a.parameters,a.parameters.rule);break;case"getVisitorProfile":g="profileJSON",d={type:"getVisitorProfileResponse",replyForMsgId:u.msgId,parameters:{data:i.getData(g)}},Ro(e,d);break;case"setVisitorProfile":g="profileJSON",i.setData(g,JSON.stringify(l.data));break;case"getEngagementRecord":h=i.getWidgetCache(o,"engagement_id",!0),d={type:"getEngagementRecordResponse",replyForMsgId:u.msgId,parameters:{id:h,data:Ur(i,h)}},Ro(e,d);break;case"onQuestionnaireSubmit":d={type:"onQuestionnaireSubmitResponse",replyForMsgId:u.msgId},n.onQuestionnaireSubmitCallbacks?n.onQuestionnaireSubmitCallbacks.doCallbacksAsync(To.load(l.data)).then((function(t){d.parameters=t.toJson(),Ro(e,d)})):(d.parameters=JSON.stringify(l),Ro(e,d));break;case"getParameters":d={type:"getParametersResponse",replyForMsgId:u.msgId,parameters:{data:s}},Ro(e,d);break;case"setEngagementRecord":h=i.getWidgetCache(o,"engagement_id",!0),Hr(i,h,l.data);break;case"createEngagementRecord":h=this.createEngagementRecord(a),i.setWidgetCache(o,"engagement_id",h,!0),d={type:"createEngagementRecordResponse",replyForMsgId:u.msgId,parameters:{id:h,data:this.getEngagementRecord(h)}},Ro(e,d);break;case"getWidgetInitData":d={type:"getWidgetInitDataResponse",replyForMsgId:u.msgId,parameters:{data:{clientHref:window.location.href,parameters:a.parameters,configuration:a.configuration,translation:n.localization.data}}},Ro(e,d);break;case"getConfiguration":d={type:"getConfigurationResponse",replyForMsgId:u.msgId,parameters:{data:a.configuration}},Ro(e,d);break;case"getCache":d={type:"getCacheResponse",replyForMsgId:u.msgId,parameters:{key:l.key,value:i.getWidgetCache(o,l.key,l.persist)}},Ro(e,d);break;case"getCacheData":d={type:"getCacheDataResponse",replyForMsgId:u.msgId,parameters:{key:l.key,value:i.getData(l.key)}},Ro(e,d);break;case"getTranslation":d={type:"getTranslationResponse",replyForMsgId:u.msgId,parameters:{value:n.localization.data}},Ro(e,d);break;case"getOtherCache":d={type:"getOtherCacheResponse",replyForMsgId:u.msgId,parameters:{key:l.key,value:i.getWidgetCache(o,l.key,l.persist)}},Ro(e,d);break;case"setCache":i.setWidgetCache(o,l.key,l.value,l.persist);break;case"removeCache":i.removeWidgetCache(o,l.key,l.persist);break;case"notificationMessage":if(Zi(r)||er(r))return;l.title&&(l.title=n.getTranslation(Mr(o),l.title)),a.parameters.title=l.title,a.parameters.message=l.message,a.parameters.icon=l.icon,a.parameters.callToAction=l.callToAction,a.parameters.notificationType=2,a.notificationType=2,this.showNotification(a);break;case"updateWidgetTitle":this.updateWidgetTitle(o,l);break;case"updateTabText":Bt("#concierge .con_tab_text").text(l.text);break;case"hideWidget":a.hideWidget();break;case"setServiceLineId":this.setServiceLineId(l,o);break;case"setActive":l.active?br(r,a):Sr(r,a);break;case"handleClose":i.setWidgetCache(o,"willHandleClose",l.value,!0);break;case"callFunction":d={type:"callFunctionResponse",replyForMsgId:u.msgId,parameters:{}},a[l.funcName]&&(d.parameters.result=a[l.funcName](l.funcArgs)),Ro(e,d);break;case"broadcast":this.handleBroadcast(o,l.eventType,l.data)}}}}}var Ro=function(e,t){e&&e.source&&e.source.postMessage(zr(t),e.origin)};function Po(e){this.shouldDisplayBell=!1,this.KNOWN_WIDGETS={chat:{requires:["portalId","host"]},email:{requires:["mailboxId"]},kb:{requires:["articleLimit","portalId","searchText"]},kbot:{requires:["portalId","host"]}},this.notificationType=0;var t=navigator;this.concierge=e,this.journeyViewManager=new mo(e),this.stashedConciergeCss={top:"",bottom:""},this.needsForceBlur=!1,this.state="tab",this.device=Zt(t),this.openWidget=!1,this.widgetLoadPromises={},ye.log("WidgetManager constructor: device="+this.device),"Mobile"===this.device?this.widgetsType=new fo(this):this.widgetsType=new ho(this),this.bridgeListener={}}function jo(e){var t,n=e.concierge.cacheManager;return e.tabStyle=e.tabStyle||{verticalOffset:"100",verticalAnchor:1,horizontalOffset:"20",cascade:1},n&&e.engagementWidgets&&(t=e.engagementWidgets).conciergeTab&&t.conciergeTab.tabStyle&&(void 0!==t.conciergeTab.tabStyle.verticalOffset&&(e.tabStyle.verticalOffset=t.conciergeTab.tabStyle.verticalOffset),void 0!==t.conciergeTab.tabStyle.verticalAnchor&&(e.tabStyle.verticalAnchor=t.conciergeTab.tabStyle.verticalAnchor),void 0!==t.conciergeTab.tabStyle.horizontalOffset&&(e.tabStyle.horizontalOffset=t.conciergeTab.tabStyle.horizontalOffset),void 0!==t.conciergeTab.tabStyle.cascade&&(e.tabStyle.cascade=t.conciergeTab.tabStyle.cascade)),e.tabStyle}function Vo(e,t){var n,i,r,o,a,s=t.widget,c={},u=e.engagementWidgets.widgets[s].parameters;return"email"===s?(r="mailboxId",i="mailbox ID"):(r="portalId",i="portal ID"),u&&(a=u[r],n=u.host),(o=t[r]||a)||ye.log("No Moxie "+i+" specified for engagement."),c[r]=o,Wr(s)&&function(e,t,n){var i=e||t;i||ye.log("No Moxie chat host specified for engagement.");n.host=i}(t.host,n,c),c}function Fo(e){window.MOXIE_CONCIERGE&&delete window.MOXIE_CONCIERGE.startEngagement,e.dataStartListener&&(ut(document,"click",e.dataStartListener),delete e.dataStartListener),function(e){e.bridgeListener&&(window.removeEventListener("message",e.bridgeListener,!1),delete e.bridgeListener)}(e)}function Jo(e){e.initEngagementWidgets(),Ao(e),jo(e),function(e){var t=e.widgetsType.html();t=(t=t.replace(/\/SCRIPT_LOCATION\//g,e.concierge.scriptLocation+"/")).replace(/\/DEVICE\//g,e.device);var n=!1;if(e.concierge.cacheManager&&e.engagementWidgets&&(n=e.engagementWidgets).conciergeTab&&n.conciergeTab.icon&&n.conciergeTab.icon.svg){var i=n.conciergeTab.icon.svg;t=t.replace(/<!-- replace: ICON -->/g,i)}var r=Bt(t=Yr(t)({concierge:e.concierge,CONCIERGE_TAB_ICON_SVG:e.engagementWidgets.conciergeTab.icon.svg,CON_CLOSED:Ar(e)?" single-channel":"",CON_ROLE_ATTRIBUTE:Ar(e)?"":' role="menu"',CLOSE_ICON:e.concierge.getTranslation("common","CLOSE_ICON"),CONCIERGE:e.concierge.getTranslation("common","CONCIERGE"),NOTIFICATION_ANNOUNCE:e.concierge.getTranslation("common","NOTIFICATION_ANNOUNCE")})),o=function(t){if("click"===t.type||13===t.which||32===t.which)return e.closeWidget(!1),!1};ct(r,"click",lt("con-close-area"),o),ct(r,"keypress",lt("con-close-area"),o);var a=lt("con-widget-title-section");ct(r,"keyup",a,(function(){return ze(this,{outline:"-webkit-focus-ring-color auto 5px"}),!1})),ct(r,"blur",a,(function(){return ze(this,{outline:"none"}),!1}));var s=function(t){if("click"===t.type&&ze(this,{outline:"none"}),"click"===t.type||13===t.which||32===t.which){var n=Bt(this).closest(".concierge-widget").data("widget");e.postMessageToWidget(n,"titleClicked");var i=e.engagementWidgets.widgets[n];return i.titleBar.onclick&&i.titleBar.onclick(e),!1}};ct(r,"click",a,s),ct(r,"keypress",a,s),e.widgetsType.beforeAppend&&e.widgetsType.beforeAppend(r),Bt("body").append(r[0]),r.hide()}(e);var t=Bt("#concierge .con-icon svg");void 0!==t&&t.length>0&&Pr(t[0]),e.$concierge=Bt("#concierge"),e.widgetsType.start()}Po.prototype.startExternal=function(e,t){var n=!0===t.enableChatDeflection||"true"===t.enableChatDeflection;null!==t.widget&&void 0!==t.widget||(t.widget=t.startEngagement),"chat"===t.widget&&n&&(t.widget="kbot"),delete t.startEngagement,delete t.enableChatDeflection,t.ruleSource=e;var i=["externalLink","externalAPI"];if(t.ruleId=-1*(1+i.indexOf(e)),t.action="success",null!==t.widget&&void 0!==t.widget&&""!==t.widget){var r=this;return ht(t,Vo(this,t)),function(e,t){var n={name:t.ruleName,source:t.ruleSource,id:t.ruleId,action:t.action},i=A.resolve();return i=i.then((function(){if(e.notificationDisplayed())return ye.log("WidgetManager.displayWidget("+t.widget+":"+t.ruleName+"): is closing the notification"),hr(e.wmState)})).then((function(){return e.addWidget(t,n)})).then((function(n){return n&&void 0!==n.status&&!1===n.status?(ye.log("WidgetManager.displayWidget("+t.widget+":"+t.ruleName+"): halted because addWidget failed"),n):(!1!==e.openWidget&&e.openWidget!==t.widget&&e.hideWidget(!0),e.showWidget(n.ref).then((function(){return e.showConcierge(),e.widgetsType.openConcierge(),{ref:n.ref,status:!0}})))})).catch((function(e){return ye.log("WidgetManager.displayWidget("+t.widget+":"+t.ruleName+"): failed: "+e),ye.log(e.stack),xr}))}(this,t).then((function(e){return e&&!0===e.status&&("kbot"===t.widget?(ye.log("WidgetManager.startExternal removing previous chat widget if one exists."),r.removeWidget(r.findWidget("chat"),!0)):"chat"===t.widget&&(ye.log("WidgetManager.startExternal removing previous kbot widget if one exists."),r.removeWidget(r.findWidget("kbot"),!0))),e}))}ye.log("WidgetManager.startExternal invoked with improper widget specification")},Po.prototype.findWidget=function(e){for(var t in this.wmState.spots){var n=this.wmState.spots[t];if(n.widget&&n.widget.name===e)return n.widget;if(n.reactive&&n.reactive.name===e)return n.reactive}return this.wmState.offer&&this.wmState.offer.name===e?this.wmState.offer:this.engagementWidgets.widgets[e]},Po.prototype.addEventListeners=function(){var e=this;window.MOXIE_CONCIERGE=window.MOXIE_CONCIERGE||{},window.MOXIE_CONCIERGE.startEngagement=function(t){return e.startExternal("externalAPI",t)},this.dataStartListener&&ut(document,"click",this.dataStartListener),this.dataStartListener=ct(document,"click",st(Je,"data-moxie-start-engagement"),(function(t){var n=function(e){var t=/^moxie(.*)/,n={};for(var i in e)if(K(e,i)&&t.test(i)){var r=i.replace(t,"$1");n[r=r.charAt(0).toLowerCase()+r.slice(1)]=e[i]}return n}(Bt(this).data());return e.startExternal("externalLink",n),!1}))},Po.prototype.isMobile=function(){return"Mobile"===this.device},Po.prototype.createEngagementRecord=function(e,t){var n=function(e,t){var n=e.name,i=e.parameters.proactive,r=e.parameters.rule,o=Lr(t=t||e.name)?"kb":t,a={id:Bn(),dirty:!0,time:Date.now(),type:Dn[t],name:o,proactive:void 0!==i&&i,rule:void 0!==r?r:null,decision_type:"",kb:null,chat:null,email:null};return Wr(n)?a.chat={agents:[],missed_reason:0}:"email"===n&&(a.email={sent:!1}),a}(e,t);return $r(this.concierge.cacheManager,n),n.id},Po.prototype.getEngagementRecord=function(e){return Ur(this.concierge.cacheManager,e)},Po.prototype.setEngagementRecord=function(e,t){return Hr(this.concierge.cacheManager,e,t)},Po.prototype.getWidgetParameters=function(e){return this.widgetParameters[e]},Po.prototype.toggleWindow=function(){this.widgetsType.toggleWindow(this)},Po.prototype.knownWidgets={chat:bo,kbot:ko,kb:xo,email:Eo},Po.prototype.simpleWidgets={link:Wo},Po.prototype.createWidget=function(e){var t,n=this.concierge,i=JSON.parse(JSON.stringify(me(n,"configuration","widgets","widgets",e)||{}));return(t=this.knownWidgets[e]?new this.knownWidgets[e](n,i):this.simpleWidgets[e]?new this.simpleWidgets[e](n,i):new wo(n,i)).name=e,t},Po.prototype.initEngagementWidgets=function(){var e=JSON.parse(JSON.stringify(me(this.concierge,"configuration","widgets")||{}));for(var t in e.widgets)e.widgets[t]=this.createWidget(t);for(var n in self.simpleWidgets)e.widgets[n]=this.createWidget(t);this.engagementWidgets=e,this.wmState=new Ki(this)},Po.prototype.addWidget=function(e,t,n){var i,r=e.widget;return(i=this.createWidget(r)).widgetParameters=e,i.parameters=e,i.parameters.rule=t,i.parameters.proactive=i.parameters.proactive||!1,i.engagementId=n,fr(this.wmState,i)},Po.prototype.removeWidget=function(e,t){e&&(ye.log('WidgetManager.removeWidget("'+e.name+'"): invoked.'),function(e,t){if(t){e.notification===t&&hr(e);var n=t.spot;if(n){var i=Qi(e,n);i.widget===t&&i.reactive===t?(ir(e,i.widget),Rr(n).remove(),i.reactive=i.widget=null):(i.reactive===t&&(i.reactive=null),i.widget===t&&i.reactive&&rr(e,i.reactive))}}}(this.wmState,e),e.destroy(this),t||Bt("#concierge-widgets ul li").length||Bt("#concierge").hide())},Po.prototype.updateWidgetTitle=function(e,t){var n=this.widgetAreaForWidget(e),i=n.find(".concierge-widget-header .con-widget-title"),r=t.text;i.text(r&&this.concierge.getTranslation(e,r,""));var o="";switch(t.buttonType||""){case"minimizeIcon":o=this.concierge.getTranslation("common","MINIMIZE_ICON");break;case"searchIcon":o=this.concierge.getTranslation("common","SEARCH_ICON");break;case"backIcon":o=this.concierge.getTranslation("common","BACK_ICON");break;default:o=""}var a=n.find(".concierge-widget-header .con-widget-icon");a.empty();var s=t.graphic||"";if(s.length){if("<"===s.charAt(0))a.html(s);else{var c=this.concierge.scriptLocation+"/widgets/"+e+"/"+s;a.html('<img src="'+c+'" />')}a.attr("title",o)}var u=n.find(".concierge-widget-header .con-widget-title-section");t.hasCallback?u.addClass("clickable-title").addClass(".clickable-title"):u.removeClass("clickable-title").addClass(".clickable-title")},Po.prototype.makePositionAbsolute=function(){var e;"absolute"!==this.$concierge.css("position")&&(this.stashedConciergeCss=this.$concierge.css(["top","bottom"]),e=this.$concierge.offset().top,this.$concierge.css({position:"absolute",top:e,bottom:""}))},Po.prototype.makePositionFixed=function(){var e,t;"fixed"!==this.$concierge.css("position")&&this.stashedConciergeCss&&(t="auto"!==this.stashedConciergeCss.top?"top":"bottom",e=this.$concierge.offset().top-document.body.scrollTop,this.$concierge.css({position:"fixed",top:e,bottom:"auto"}),"top"===t?this.$concierge.animate({top:this.stashedConciergeCss.top},{label:"makePositionFixedTop"}):this.$concierge.animate({top:oe()-parseInt(this.stashedConciergeCss.bottom,10)-this.$concierge.height()},{label:"makePositionFixedBottom",done:function(){this.$concierge.css({top:"auto",bottom:this.stashedConciergeCss.bottom})}.bind(this)}))},Po.prototype.handleGetTabInfo=function(e,t){var n=this.concierge.cacheManager.getWidgetCache(t,"cookieId",!0);n||(n=Math.ceil(1e5*Math.random()),this.concierge.cacheManager.setWidgetCache(t,"cookieId",n,!0)),e.source.postMessage(JSON.stringify(zr({origWindowName:window.name,cookieID:n,currentOrigin:window.location.protocol+window.location.host,previousOrigin:window.location.protocol+window.location.host,sessionId:this.concierge.cacheManager.getWidgetCache(t,"sessionId")})),e.origin)},Po.prototype.handleSetChatInProgress=function(e,t,n){var i=this.engagementWidgets.widgets[t];i&&void 0!==i.sendSearchGuid&&i.sendSearchGuid(e,n),this.concierge.cacheManager.setWidgetCache(t,"sessionId",Math.abs(parseInt(e))),e>0?this.markChat(e,"start"):e<0&&this.markChat(e,"end")},Po.prototype.setNotificationType=function(e){return e>=0&&e<=2&&(this.notificationType=e,!0)},Po.prototype.handleBroadcast=function(e,t,n){if(this[e+"HandleBroadcast"]&&this[e+"HandleBroadcast"](e,t,n))return A.resolve(!0);var i=this,r=this.engagementWidgets.widgets[e],o="widget:"+Mr(e)+":"+t;return(r&&r.updateBroadcastPayload?r.updateBroadcastPayload(o,n):A.resolve(n)).then((function(t){return function(e,t,n,i){try{switch(n){case"widget:chat:agentJoinedSession":un(e.concierge,!0,t,i.agentId,i.agentName,i.sessionId,i.serviceLine,i.serviceLineId);break;case"widget:chat:agentLeftSession":i.agentId&&un(e.concierge,!1,t,i.agentId,i.agentName,i.sessionId,i.serviceLine,i.serviceLineId);break;case"widget:chat:articleViewed":case"widget:kb:articleViewed":dn(e.concierge,t,i.articleId,i.articleTitle);break;case"widget:chat:articleRated":case"widget:kb:articleRated":gn(e.concierge,t,i.articleId,i.articleTitle,i.search,i.ratingType,i.rating);break;case"widget:chat:articleCommented":case"widget:kb:articleCommented":hn(e.concierge,t,i.articleId,i.articleTitle,i.search,i.ratingType,i.rating,i.comment);break;case"widget:chat:chatSessionStarted":ln(e.concierge,!0,t,i.sessionId,i.serviceLine,i.serviceLineId);break;case"widget:chat:chatSessionEnded":ln(e.concierge,!1,t,i.sessionId,i.serviceLine,i.serviceLineId),function(e,t){var n=t.sessionId;n&&e.concierge.cacheManager.setWidgetCache("kbot","lastChatSessionEnded",n,!1)}(e,i);break;case"widget:email:emailSent":fn(e.concierge,t,i.mailboxId);break;case"widget:kb:portalSearched":case"widget:chat:portalSearched":bn(e.concierge,t,i.searchText,i.portalId,i.articlesList);break;case"widget:chat:prechatQuestionnaireComplete":Sn(e.concierge,t,i.serviceLine,i.serviceLineId)}}catch(e){ye.log("Error in processBroadcast"+e)}}(i,e,o,t),Ln(o,t),null})).catch((function(e){ye.log("handleBroadcast Error:"+e)}))},Po.prototype.markChat=function(e,t){var n=this.concierge.cacheManager.getData("profileJSON"),i=this.journeyViewManager.markChat(n,e,t);this.concierge.cacheManager.setData("profileJSON",JSON.stringify(i))},Po.prototype.showNotification=function(e){ye.log("WidgetManager.showNotification called:",e.name),this.wmState.notification!==e&&hr(this.wmState),this.wmState.notification=e,function(e,t){var n=t.parameters,i=n.title,r=n.message,o=n.icon,a=n.callToAction,s=e.widgetsType.getNotification();s.attr("data-spot",t.spot),s.attr("data-widget",t.name),s.find(".concierge-notification-title").html(i||""),s.find(".con-notification-body").html(r||"");var c=s.find(".con-notification-calltoaction");a&&a.length?(c.show(),c.html(a||""),c.attr("tabindex","0")):(c.hide(),c.attr("tabindex","-1"));var u=s.find(".con-notification-icon"),l="";if(o){u.show();var d=e.concierge.scriptLocation+"";V(d,"/")||(d+="/"),l='<img alt="" tabindex="-1" src="'+(o=(o=o.replace(/\/SCRIPT_LOCATION\//g,d)).replace(/^http:/,""))+'" role="presentation">'}else u.hide();u.html(l)}(this,e),this.widgetsType.displayNotification(e,e.engagementId),this.setNotificationType(e.notificationType);var t,n,i=Mr(e.name);Ln("notification",{engagementId:e.engagementId,notificationType:Vr(e.notificationType),widgetName:i,status:"displayed",rule:e.parameters.rule}),1===e.notificationType&&(t=this.concierge,n=Date.now(),t.cacheManager.setClientCache("lastNotified",n),Ln("proactiveOffer",{widgetName:i,status:"displayed",rule:e.parameters.rule}),this.concierge.currentOfferCreatedAt=Date.now(),mn(this.concierge,i,e.parameters.rule))},Po.prototype.notificationDisplayed=function(){return tr(this.wmState)},Po.prototype.broadcastCloseProactiveNotification=function(e,t){var n=e.parameters;Ln("proactiveOffer",{widgetName:n.widget,status:t,rule:n.rule}),"accepted"===t?wn(this.concierge,n.widget,n.rule):"declined"===t&&yn(this.concierge,n.widget,n.rule)},Po.prototype.postMessageToWidget=function(e,t,n){var i,r,o=this.engagementWidgets.widgets[e],a=this.concierge.cacheManager.getWidgetCache(e,"active_session");"willClose"!==t&&"willTerminate"!==t||Sr(this.wmState,o),a&&o.remoteURL&&n?(r=Wr(e)&&"object"==typeof o.remoteURL?o.remoteURL[o.portalId]:o.remoteURL,i=r.match(/^https?:\/\/[^/]+/)[0]):i="*";var s=this.widgetAreaIFrameForWidget(e);if(s.length){var c=s[0].contentWindow,u={widget:e,type:t,parameters:n},l=function(){c.postMessage(zr(u),i),ye.log(u.type+" message posted to : "+i)},d=s.data("loadPromise");return d?d.then(l):Rn(l)}return A.resolve()},Po.prototype.callWidgetFunction=function(e,t,n){var i,r,o=this.engagementWidgets.widgets[e];o.remoteURL?(r=Wr(e)&&"object"==typeof o.remoteURL?o.remoteURL[o.portalId]:o.remoteURL,i=r.match(/^https?:\/\/[^/]+/)[0]):i="*";var a=this.widgetAreaIFrameForWidget(e),s=a[0].contentWindow,c={widget:e,type:"functionCall",parameters:{functionName:t,functionData:n}},u=function(){s.postMessage(zr(c),i),ye.log(c.type+" message posted to : "+i)};return a.data("loaded")?A.resolve(u()):(a.data("loadPromise")||A.resolve()).then(u)},Po.prototype.writeSrcToIframe=function(e){var t=this.widgetAreaIFrameForWidget(e);if(t.length>0){var n=this.concierge.scriptLocation+"/widgets/"+e+"/"+this.concierge.assetVersion.widgets+"/index.html";t.attr("src",n)}},Po.prototype.widgetAreaForWidget=function(e){return this.$concierge.find("#concierge-widget-"+e)},Po.prototype.widgetAreaIFrameForWidget=function(e){return this.widgetAreaForWidget(e).find("iframe")},Po.prototype.loadWidget=function(e){var t=e.name,n=e.parameters,i=e.engagementId;if(ye.log('WidgetManager.loadWidget("'+t+'", "'+JSON.stringify(n)+'", '+i+'"): invoked.'),!this._disabled){var r=i;if(!e.state){"externalAPI"!==n.rule.source&&(e.widgetParameters=n);var o=Bt("#concierge-widget-area");if(0===this.widgetAreaForWidget(t).length){var a={widget:e,widgetName:t,CLOSE_ICON:this.concierge.getTranslation("common","CLOSE_ICON"),FOOTER:this.concierge.getTranslation("common","FOOTER")},s="";this.engagementWidgets.globalSettings&&!this.engagementWidgets.globalSettings.hideMoxieBranding&&(s=Yr('<div class="concierge-widget-footer">\n  <span class="powered" aria-label="<%= FOOTER %> go moxie.com"><%=FOOTER%></span>\n  <svg focusable="false" version="1.1" id="black" xmlns="http://www.w3.org/2000/svg"\n    xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 547.2 91"\n    enable-background="new 0 0 547.2 91" xml:space="preserve">\n    <g>\n      <path d="M87.4,27.7c-1.8-0.2-3.1-0.3-4.3-0.1c-0.9,0.2-2.9,0.1-4.3,3.1c-0.4,0.9,1,1.5,2.3,1.3s3.9-0.1,5.6,1.4\n              c2,1.7,2.6,8.8-3.5,13.7c-5.7,4.6-17.5,3.5-20.1-3.3c-2.5-6.4,0.5-11.2,2.6-13.1c2.4-2.1,5-3.9,10.6-4.3c0.6,0,2.1-1.3,2.7-3.6\n              c0.2-1-1.2-1.9-1.9-1.9c-4.7-0.1-7.4,0.4-11.6,2.2c-4.4,1.8-10.7,5.9-11.7,14.5c-2.3,2.9-5.7,5.9-9.4,8.9c0,0-0.4,0.3-0.5,0.2\n              c-0.2-0.1-0.1-0.5-0.1-0.5c0.1-4.4-0.1-7.8-0.1-8.7c-0.1-2.3-0.3-3.6-0.5-5.3c-0.1-0.5-0.1-1.7-1.3-2.7c-1.3-1-1.8-1-2.1-0.9\n              c-0.6,0.3-0.5,1.6-0.8,2.7c-0.2,0.7-0.7,2.2-1.1,3c-0.5,1.3-1.4,2.7-2.5,4.4c-3.7,5.5-18.2,14.4-24.1,11.8\n              c-5.5-2.4-1.6-9.3-0.2-11.8s11.5-13.2,26.7-13c1.4,0,7.6,1.3,8.3,1.5c1-0.2,1.8-0.9,1.3-2.3c-0.8-2.2-0.6-3-6.1-4.2\n              c-7.2-1.6-34.1,0.1-40.6,22.2c-1.4,4.8,0.8,9,2.8,10.9c3.4,3.3,9.7,4.1,15.4,2.5c6-1.7,11.5-5.1,16.6-10.1c0.2-0.2,0.5-0.5,0.7-0.7\n              c0.4-0.4,1.4-1,1.3,0.9c-0.1,1-0.2,2.1-0.4,3.1c-0.1,1-0.2,2-0.4,3c-1.9,1.4-3.8,2.7-5.6,4c-4.1,2.9-7.5,4.8-11,7.1\n              c-3.7,2.4-7.1,5.4-8.8,7c-3.3,3.1-6.1,7-5.9,12c0.3,5,2,8.7,11.8,8.6c10.7-0.1,19.2-8.8,23.6-21.8c1.5-4.6,2.3-10.2,2.7-15.4\n              c4.8-3.5,8.3-6.7,10.2-8.7c0,0,0.4-0.3,0.6-0.2s0.4,0.7,0.4,0.7c2.8,7.1,11,10.6,19.7,10c12-0.8,20.8-8.4,21.1-16.6\n              C95.4,38,95.5,28.7,87.4,27.7z M28.4,77.9c-3.1,4.1-7.1,7.6-10.9,7.6c-3.9,0-5.3-2.1-4.7-4.7c0.6-2.9,3-6.1,4.8-7.8\n              c1.2-1.1,3.2-2.8,4.5-3.9c3.2-2.6,7.5-5.9,12.6-9.4c0.4-0.3,0.9-0.3,0.8,0.8c-0.2,1.5-0.5,2.9-0.7,4.1C34.2,67.2,32,73.1,28.4,77.9\n              z" />\n      <path\n        d="M359.1,47.2c-3.7-1.2-5.9,0.9-6.6,2.6c-0.7,1.6-0.8,4.6,2.5,5.6c3.3,1.1,6,0.1,7.1-2.8C363.2,49.7,361.3,47.9,359.1,47.2z" />\n      <path d="M546.4,54.7c-0.2,0.2-2.5,0.8-3.4,0.9c-2.1,0.1-7.5-0.2-13.3-6c-5.8-5.8-9.8-19.8-15.4-27.2c-1.5-1.9-3-3.3-4.8-3.9\n              c-1.3-0.5-3.1-0.4-4.3-0.2c-3.7,0.6-5.6,2.5-10.1,8.6c-3.7,5-5.8,10.2-6.7,12.5c-1.3-10.7-3.8-17.1-9.7-15.1\n              c-3.6,1.2-8.7,9.6-10.3,13.3c0-1.3-0.1-3.3-0.2-6.1c-0.4-6.8-1.7-10.1-5.1-11.6c-4.6-2.1-10.7-1.8-19.1,2.1\n              c-4.5,2.1-8,3.8-10.3,5.6c-2.4,1.9-3.7,7-0.7,6c4.8-1.5,5.7,0.3,6.1,3.7c0.1,1.1,0.1,2.1-0.1,3.1c-0.7,4.8-7.1,9.8-14.2,9.1\n              c-7-0.7-11.1-3.7-11.3-10.5c-0.2-6.7,4.9-10.2,6.7-11.2c2.6-1.5,7.4-2.6,7.4-2.6c0.9-1,2.1-3.5-0.5-3.8\n              c-4.4-0.6-16.5,1.2-20.3,11.1c-1.4,3.8-1.4,7.6-0.3,11c-3.3,2.4-10.2,6.4-19.8,6.4c-10.1,0-13-5.2-12.8-13\n              c0.2-7.3,6.9-11.1,13.4-11.3c6.6-0.2,8.3,1.9,10.4,3.1c1.9,0.2,3.7-1.6,3.2-3.3c-0.5-1.5-1.7-5-12.8-5.4\n              c-13.9-0.4-23.1,8.1-23.1,19.9c0.1,11.5,11,16.1,20.5,16c10.7-0.1,18.9-4.8,23.1-8.2c3.2,4.8,8.9,8,16,8\n              c15.7-0.2,20.8-10,20.7-17.4c-0.1-3.4-0.6-5.7-1.3-7.2c-0.7-1.5,0.6-3.2,1.6-3.8c3.2-1.9,6.5-3.4,10.4-3.2\n              c5.9,0.3,6.2,15.1,5.6,22.8c-0.6,7.7,1.3,7.7,2.9,7.7c0.7,0,2.6-1.6,3.1-2.8c0.5-1.2,0.8-2.4,1-2.9c2.9-7.5,8.9-16.7,9.3-17\n              c0.4-0.2,2.9-1.5,3.5,3c0.5,3.3,1.4,14,3.6,15c0.1,0.1,1.1,0.5,1.7,0.5c1.3,0.1,2.6-0.4,3.1-0.9c0.6-0.7,2.3-6.2,5.3-11.8\n              c3-5.5,7.9-12.4,10.6-12.7c2.9-0.4,5.4,6.9,9.1,15.2c2.3,5.1,4.9,10.7,8.7,14.6c3.5,3.6,7.7,5,12.3,5.2c6.1,0.2,10-1.8,11.1-3.2\n              C547.7,55.7,546.9,54.3,546.4,54.7z" />\n      <path d="M177.5,58.2c-0.3-0.1-0.8-0.1-1.1-0.1c-3.6,0-4.3-2.9-4.8-4.9c-0.8-3.3-0.7-7.7-0.9-12.1c-0.1-6.1,0.4-31.6,0.4-34.3\n              c0-1.4-1.5-2.4-2.7-2.8c-2-0.7-5-1.2-6.6,0.5c-2.2,2.3-8.4,10.4-14,21.3c-4.8,9.3-7.9,17.2-8.9,19.3c-0.3,0.6-0.7,0.6-0.9,0.4\n              c-1.6-1.8-9.5-18.4-13.7-33.8c-1.9-6.9-1.6-10.1-3.4-11.2c-1.2-0.7-2.5-0.5-6.3-0.1c-0.3,0-0.5,0.1-0.7,0.2\n              c-1.3,0.3-2.5,0.7-3.4,1.3c-1.6,1.2-1.6,3.2-1.8,4.4c-0.2,1.2-4.2,20.2-5.8,32.3c-1.6,12.1-3.5,28-2.6,31.4\n              c0.5,2.1,2.5,3.6,4.5,3.9c2,0.4,3.5-0.2,4.2-0.5c0.2-0.1,0.5-0.2,0.6-0.9c0-0.7-0.3-0.5-0.6-3.4c-0.4-3.8,1.3-23.3,2.1-31.7\n              c0.9-8.3,3.3-19.1,4.3-22.6c2.3,7.8,10.8,27.6,19,39.5c0.3,0.5,1.1,0.8,1.9,1c5.9,1.3,6-0.8,7.5-5.2c1.5-4.4,10.7-23.4,13.4-28.3\n              c1.6-2.9,3.9-6.4,6.2-8.7c-0.6,6.2-1.4,26.5-1,34.8c0.3,9.2,0.7,13.1,7,14.4c1.4,0.3,4.3,0.1,6.7-1.2\n              C178.8,59.7,178.3,58.6,177.5,58.2z" />\n      <path\n        d="M277,18c3.4-0.3,5.5-2.3,5.4-5.3c-0.1-3-2.6-3.9-4.9-3.7c-3.8,0.3-5,3.1-5,4.9C272.6,15.7,273.6,18.4,277,18z" />\n      <path\n        d="M345.7,46c-2.5,0.4-6,4.8-16.5,6.3c-6.3,0.9-11.9,0-15.4-2.6c-4.8-3.4-6.6-9.4-5.3-11.2c0.3-0.5,1.1-0.4,2,0.1\n              c1.9,1,5.8,2.7,11.2,2.3c9-0.7,15.2-4.9,14.5-11.8c-0.6-6-6.2-9.1-14-9.1c-11.7,0-22.2,8.4-22.4,19.6c0,0.4,0,0.8,0,1.1\n              c-8.5,7.8-15.8,9.6-18.9,7.4c-3-2.1-0.5-13.4,0-16.9c0.5-3.4,0.6-5.6-1.2-7.4c-1.9-1.8-4.6-1.4-5.6-1.2c-1,0.2-0.9,2.4-1,3.5\n              c-0.1,1.1-0.6,3.2-1.1,12.2c-0.3,4.5-0.2,9.3,2,12.6c2.2,3.3,6.3,4.6,11.4,3.7c5.6-1,11.4-5,15.6-8.4c3.2,8.1,12.6,12.1,22.8,12\n              c12.2-0.1,20-4.9,21.8-6.4c0.5-0.4,1.4-2.3,1.6-3.3C347.1,47.3,346.9,45.8,345.7,46z M311.1,30.5c1.4-2.5,4.6-4.4,7.4-4.9\n              c5-0.9,9.4,0.6,9.8,4.3c0.6,4.7-5.8,7.4-12.8,5.6c-1.1-0.3-2.5-0.8-3.5-1.5C310.7,32.8,310.8,31.2,311.1,30.5z" />\n      <path d="M269.5,58.3c-4.8,0.3-8.9-3.7-11.4-6.5c-1.3-1.5-6.5-7.5-8.7-10.9c-0.2-0.2-0.1-0.4,0.2-0.7c10.5-8.3,11.8-8.8,15.5-12.7\n              c4.2-4.5,2.9-7.1-0.6-9.2c-0.7-0.4-1.9-0.2-1.9,0.6c-0.2,3.1-4.4,6.9-14.2,15.3c-1.2,1-3.3,0.7-3.8,0c-0.3-0.4-0.8-1.2-1.2-1.8\n              c-4-6.3-7.3-8.3-9.4-8.8c-3.2-0.8-7.3-1.2-13.3,0.1c-6,1.3-12.8,2.5-13.7,3c-0.9,0.5-2.5,2.3-2.3,3.1c0.2,1,1.5,1,2.5,0.8\n              c1.3-0.1,3-0.2,4.4,1.3c2,2.1,4.1,8.1-2.4,13.7c-6.5,5.6-19.2,5.6-21.4-3c-1.9-7.5,3.1-12.2,5.7-13.8c1-0.6,2-1.1,3.1-1.6\n              c0.6-0.2,1.2-0.5,1.8-0.6c0.7-0.2,2-0.5,2.7-0.8c0.5-0.2,2.2-3,2.1-3.5c-0.1-0.4-0.3-0.8-0.7-1.1c-0.6-0.6-2.6-0.9-7.5,0.3\n              C190,22.9,179,27,178.3,39.1c-0.7,11,9.1,17.3,20.7,16.3c12.5-1.1,20-8,20.3-17c0-1.1,0-2.6-0.2-4.1c-0.3-2-0.6-3.9,0.2-4.6\n              c1.6-1.4,5.3-1.7,5.8-1.8c5.8-0.8,9.3,5.8,11.8,9c0.7,0.8,2,2.6,2.8,3.7c0.2,0.3-0.1,0.7-0.7,1.3c-9.6,8.2-13.3,11.8-15.1,14\n              c-1.9,2.4-4.8,6.9-2.1,9.6c1.4,1.4,3.7,1.5,4.2,0.4c1.2-2.7,4-9,15.4-19.1c0.8-0.7,2.1-1,2.5-0.7c3.1,4.2,6.6,8.6,9.3,11.6\n              c5.6,6.1,13.9,5,17.8,3C272.8,59.8,272.3,58.2,269.5,58.3z" />\n      <path d="M532.8,21.4h-2v-1.3h5.5v1.3h-2V27h-1.6V21.4z M543.1,20.1l-1.8,3.8l-1.8-3.8h-2.1v7h1.6v-4.4l1.9,3.8h0.9l1.9-3.8V27h1.6\n              v-7H543.1z" />\n    </g>\n  </svg>\n</div>')(a)),a.moxieBranding=s;var c=Yr('<div class="concierge-widget" id="concierge-widget-<%= widgetName %>" data-widget="<%= widgetName %>">\n  <header class="concierge-widget-header">\n    <div class="con-widget-title-section">\n      <div class="con-widget-icon"></div>\n      <h2 class="con-widget-title" tabindex="0"><%= widget.title %></h2>\n    </div>\n    <div class="con-close-area">\n      <button type="button" class="con-close-widget" aria-label="<%= CLOSE_ICON %>">\n        <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" enable-background="new 0 0 20 20" stroke-width="0">\n          <title><%= CLOSE_ICON %></title>\n          <polygon points="17.3,1.1 10.2,8.3 3.1,1.1 1.3,2.9 8.4,10 1.3,17.1 3.1,18.9 10.2,11.8 17.3,18.9 19.1,17.1 11.9,10 19.1,2.9 "/>\n        </svg>\n      </button>\n    </div>\n  </header>\n\n  <iframe allow="geolocation" frameborder="no" class="widget-content" aria-live="polite" aria-atomic="true"></iframe>\n  <%= moxieBranding %>\n</div>\n')(a);c=c.replace(/\/SCRIPT_LOCATION\//g,this.concierge.scriptLocation+"/"),o.append(c)}void 0===i&&(i=this.createEngagementRecord(e),r=i),e.state=2,e.proactive=n&&n.proactive||!1,ye.log("WidgetManager.loadWidget("+t+"): set widget.proactive="+e.proactive),e.beforeLoad();var u=this,l=this.concierge.cacheManager.getWidgetCache(t,"active_session");if(l||e.shouldReplaceIframeSrc){var d=this.widgetAreaIFrameForWidget(t),g=e.getRemoteURL();ye.log("WidgetManager.loadWidget("+t+"): requests iframe src="+g,"hasActive:",l,"shouldReplace:",e.shouldReplaceIframeSrc),d.data("loadPromise",i=new A((function(e){d.attr("src",g),d.on("load",(function(){d.data("loaded")||(d.data("loaded",!0),e(r))}))})))}else void 0!==e.prepareToLoadPromise?e.prepareToLoadPromise.then((function(){u.writeSrcToIframe(t)})):this.writeSrcToIframe(t);this.updateWidgetTitle(t,{text:e.titleBar&&e.titleBar.text?"title":"",graphic:e.titleBar&&e.titleBar.graphic?e.titleBar.graphic:null})}var h=this.concierge.getTranslation(t,"title","Concierge");return this.widgetAreaIFrameForWidget(t).attr("title",h),i}},Po.prototype.replaceWidget=function(e){var t=this,n={status:!0,ref:e,parameters:e.parameters,ruleSettings:this.concierge.rulesEngine.getSiteSettings(),engagementId:e.engagementId};return e.beforeAdd(n).then((function(n){return n&&n.status&&ar(t.wmState,e,!0),n}))},Po.prototype.getSeenChannelsHosts=function(){return this.seenChannelsHosts||(this.seenChannelsHosts=this.concierge.cacheManager.getClientCache("channelsHosts")||[]),this.seenChannelsHosts},Po.prototype.registerChatHost=function(e){var t=this.getSeenChannelsHosts();P(t,e)<0&&(t.push(e),this.seenChannelsHosts=t,this.concierge.cacheManager.setClientCache("channelsHosts",t,!1))},Po.prototype.showWidget=function(e){var t=e.name,n=e.parameters,i=e.engagementId,r=this.wmState;ye.log("WidgetManager.showWidget("+t+", "+JSON.stringify(e.parameters)+", "+i+"): invoked.");var o=A.resolve();if(e){var a=this,s=Bt("#concierge-widget-area");Wr(t)&&n.host&&this.registerChatHost(n.host),o=o.then((function(){return e.spot&&Dr(r,e)?a.replaceWidget(e):"function"==typeof e.shouldRebuildIframe&&e.shouldRebuildIframe()?(a.widgetAreaIFrameForWidget(t).replaceWith('<iframe frameborder="no" class="widget-content" allow="geolocation"></iframe>'),Rn((function(){a.writeSrcToIframe(t)})).then((function(){return a.concierge.cacheManager.removeWidgetCache(t,"rebuildIframe",!1)}))):void 0})).then((function(){e.proactive=n&&n.proactive||!1,ye.log("WidgetManager.showWidget("+e.label()+"): set widget.proactive="+e.proactive)})).then((function(){return e.state?A.resolve(a.postMessageToWidget(t,"willShow",n)).then((function(){return a.concierge.cacheManager.getWidgetCache(t,"engagement_id",!0)})):a.loadWidget(e)})).then((function(n){return n&&null!==a.getEngagementRecord(n)||(n=a.createEngagementRecord(e)),e.engagementId=i=n,a.concierge.cacheManager.setWidgetCache(t,"engagement_id",i,!0)})).then((function(){var e,n=a.getEngagementRecord(i);if(Wr(t)){if(null===n)ye.log('WidgetManager.showWidget("'+i+'"): was null.');else if(n.proactive&&void 0===n.chat.time_to_decide){var r=new Date(n.time).getTime();n.chat.time_to_decide=Math.round(((new Date).getTime()-r)/1e3),n.chat.missed_reason=0,n.decision_type="Accepted",e=a.setEngagementRecord(i,n)}}else null!==n&&n.proactive&&(n.decision_type="Accepted",e=a.setEngagementRecord(i,n));return e||(e=A.resolve()),e.then((function(){return a.concierge.contextMonitor.recordEngagementValue()}))})).then((function(){if(a.notificationDisplayed())return ye.log("WidgetManager.showWidget("+e.label()+"): ignoring the notification"),hr(r)})).then((function(){return s.addClass("con-open"),a.$concierge.addClass("con-open-widget"),r.open=e,a.openWidget!==t?(a.widgetsType.openWidget(e),Ln("widgetOpened",{widgetName:t,source:n.rule.source}),a.openWidget=t):a.widgetsType.makeWidgetActive(a.widgetAreaForWidget(t)),null}))}return o},Po.prototype.forceBlur=function(){if(this.needsForceBlur){Bt("#concierge").append('<input type="text" id="fakefocus" style="width:1px; height:1px" />');var e=Bt("#fakefocus");e.focus(),e.blur(),e.remove(),this.needsForceBlur=!1}},Po.prototype.hideWidget=function(e){var t=this,n=t.postMessageToWidget(t.openWidget,"willHide");return e||(n=n.then((function(){return jr(t,!1)}))),n},Po.prototype.closeWidget=function(e){var t=this,n=t.postMessageToWidget(t.openWidget,"willClose"),i=this.wmState.open;return e||t.concierge.cacheManager.getWidgetCache(t.openWidget,"willHandleClose",!0)||(n=n.then((function(){return jr(t,!0)})).then((function(){i&&i.closeWidget()}))),n},Po.prototype.fixPosition=function(e){this.widgetsType.fixPosition&&this.widgetsType.fixPosition(e,this.$concierge)},Po.prototype.expandConcierge=function(){ye.log("WidgetManager.expandConcierge(): invoked.")},Po.prototype.collapseConcierge=function(){ye.log("WidgetManager.collapseConcierge(): invoked.")},Po.prototype.preloadCSS=function(){return jo(this),function(e){var t="concierge-style-"+e.widgetsType.cssType;return 0===Bt("#"+t).length?new A((function(n){var i=e.concierge.scriptLocation+"/widgets/"+e.concierge.assetVersion.widgets+"/"+e.widgetsType.cssType+".css",r=document.getElementsByTagName("head")[0],o=document.createElement("link");o.onload=function(){n(!0)},o.id=t,o.rel="stylesheet",o.type="text/css",o.href=i,o.media="all",r.appendChild(o)})):A.resolve(!0)}(this)},Po.prototype.init=function(){ye.log("WidgetManager.init(): invoked."),this.$concierge=Bt("#concierge"),0===this.$concierge.length&&Jo(this)},Po.prototype.showConcierge=function(){ye.log("WidgetManager.showConcierge(): invoked."),Bt("#concierge-widgets ul li").length>0&&Bt("#concierge").show()},Po.prototype.hideConcierge=function(){ye.log("WidgetManager.hideConcierge(): invoked."),Bt("#concierge").hide()},Po.prototype.getWidgetPath=function(e){return this.concierge.widgetPath+e+"/"},Po.prototype.setServiceLineId=function(e,t){var n=this;if(t&&t.parameters){var i=t.name,r=t.parameters;r.serviceLineId!==e.serviceLineId&&(r.serviceLineId=e.serviceLineId,this.concierge.serviceLines.getName(e.serviceLineId).then((function(i){return r.serviceLine=i,r.serviceLineId=e.serviceLineId,r.parameters&&r.parameters.queue&&(r.parameters.queue=e.serviceLineId),br(n.wmState,t),null})).catch((function(t){ye.log('setServiceLineId("'+i+'", '+JSON.stringify(e)+"): ERROR: "+t)})))}},Po.prototype.loadActiveWidgets=function(){var e=this,t=e.wmState.wm.concierge.cacheManager.getClientCache("activeWidgets")||[],n=null,i=[];e.loadingActiveWidgets=!0;for(var r=0;r<t.length;r++)t[r].loadParams&&(n=this.concierge.cacheManager.getWidgetCache(t[r].widgetName,"engagement_id",!0),i.push(this.addWidget(t[r].loadParams,t[r].loadParams.rule,n).then((function(t){if(t&&t.status)return br(e.wmState,t.ref)}))));return A.all(i).finally((function(){delete e.loadingActiveWidgets}))},Po.prototype.notify=function(e,t){ye.log("WidgetManager.notify called with:",e,t);var n=e.widget,i=this.createWidget(n);return e.rule=t||{},e.proactive=!0,i.parameters=e,sr(this.wmState,i)},Po.prototype.terminateWidget=function(e,t){void 0===t&&(t=!1);var n=this,i=e.name;if(!Wr(i))return A.resolve(!0);if(!mr(n.wmState,e)||!function(e,t){return t&&0!==t.state}(n.wmState,e))return A.resolve(!0);var r=new A((function(e,r){var o=null;t&&(o=setTimeout((function(){r("willTerminate not answered with widgetTerminated in timely manner")}),1e3)),n[i+"HandleBroadcast"]=function(t,r){return t===i&&"widgetTerminated"===r&&(null!==o&&clearTimeout(o),delete n[i+"HandleBroadcast"],e(!0),!0)}}));return n.postMessageToWidget(i,"willTerminate").then((function(){return r}))},Po.prototype.disable=function(){this._disabled=!0},Po.prototype.enable=function(){this._disabled&&delete this._disabled},Po.prototype.clearHistory=function(){for(var e=this,t={},n=this.getSeenChannelsHosts(),i=0;i!==n.length;i++)t[n[i]]=!0;var r=A.resolve(!0);e.disable();for(var o=function(t){return function(){return e.removeWidget(t)}},a=function(e){return function(){var t=document.createElement("iframe");t.setAttribute("id","concierge.clear.history"),t.setAttribute("tabindex","-1"),t.style.display="none",t.style.height="400px",t.style.width="300px";var n,i=e+"/netagent/ClearChatSession.aspx";return t.setAttribute("src",i),new A((function(i){var r=function(e){"SessionCleared"===e.data&&(window.removeEventListener("message",r,!1),e.fromTimeout?i(!1):i(!0))};window.addEventListener("message",r,!1),document.body.appendChild(t),n=window.setTimeout((function(){ye.log("WidgetManager.clearHistory("+e+'): timeout waiting for "SessionCleared" event. Proceeding with clearHistory process.'),r({data:"SessionCleared",fromTimeout:!0})}),1e3)})).then((function(e){e&&n&&clearTimeout(n),t.remove?t.remove():null!==t.parentNode&&t.parentNode.removeChild(t)}))}},s=Object.keys(e.wmState.spots),c=[],u=0;u<s.length;u+=1){var l=Qi(e.wmState,s[u]);if(l&&l.widget){var d=s[u];l.widget.parameters&&l.widget.parameters.host&&(t[l.widget.parameters.host]=!0),c.push(e.terminateWidget(l.widget,!0).catch((function(e){ye.error("Could not terminate widget in spot "+d+": "+e)})).then(o(l.widget)))}}r=r.then(A.all(c)),c=[];for(var g=Object.keys(t),h=0;h<g.length;h+=1)c.push(a(g[h])());return r=r.then(A.all(c))},Po.prototype.destroy=function(){if(Fo(this),this.wmState){for(var e in this.removeWidget(this.wmState.notification),this.wmState.spots){var t=Qi(this.wmState,e);this.removeWidget(t.reactive),this.removeWidget(t.widget)}for(var n=ie(this.wmState.alive),i=0;i<n.length;i++)this.removeWidget(n[i])}Bt("#concierge-widget-area .concierge-widget iframe").remove(),Bt("#concierge-widget-area .concierge-widget").remove(),this.widgetsType.destroy&&this.widgetsType.destroy()},Po.prototype.isValidEngagementConfig=function(e){var t;if(void 0===e||!e.widget||!this.KNOWN_WIDGETS[e.widget])return!1;for(t=0;t<this.KNOWN_WIDGETS[e.widget].requires.length;t++)if(void 0===e[this.KNOWN_WIDGETS[e.widget].requires[t]])return!1;return!0};var qo=function(e){var t,n=e.Symbol;return"function"==typeof n?n.observable?t=n.observable:(t=n("observable"),n.observable=t):t="@@observable",t}("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof module?module:Function("return this")()),$o=function(){return Math.random().toString(36).substring(7).split("").join(".")},Ho={INIT:"@@redux/INIT"+$o(),REPLACE:"@@redux/REPLACE"+$o(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+$o()}};function Uo(e){if("object"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function Bo(e,t,n){var i;if("function"==typeof t&&"function"==typeof n||"function"==typeof n&&"function"==typeof arguments[3])throw new Error("It looks like you are passing several store enhancers to createStore(). This is not supported. Instead, compose them together to a single function.");if("function"==typeof t&&void 0===n&&(n=t,t=void 0),void 0!==n){if("function"!=typeof n)throw new Error("Expected the enhancer to be a function.");return n(Bo)(e,t)}if("function"!=typeof e)throw new Error("Expected the reducer to be a function.");var r=e,o=t,a=[],s=a,c=!1;function u(){s===a&&(s=a.slice())}function l(){if(c)throw new Error("You may not call store.getState() while the reducer is executing. The reducer has already received the state as an argument. Pass it down from the top reducer instead of reading it from the store.");return o}function d(e){if("function"!=typeof e)throw new Error("Expected the listener to be a function.");if(c)throw new Error("You may not call store.subscribe() while the reducer is executing. If you would like to be notified after the store has been updated, subscribe from a component and invoke store.getState() in the callback to access the latest state. See https://redux.js.org/api-reference/store#subscribelistener for more details.");var t=!0;return u(),s.push(e),function(){if(t){if(c)throw new Error("You may not unsubscribe from a store listener while the reducer is executing. See https://redux.js.org/api-reference/store#subscribelistener for more details.");t=!1,u();var n=s.indexOf(e);s.splice(n,1),a=null}}}function g(e){if(!Uo(e))throw new Error("Actions must be plain objects. Use custom middleware for async actions.");if(void 0===e.type)throw new Error('Actions may not have an undefined "type" property. Have you misspelled a constant?');if(c)throw new Error("Reducers may not dispatch actions.");try{c=!0,o=r(o,e)}finally{c=!1}for(var t=a=s,n=0;n<t.length;n++){(0,t[n])()}return e}function h(e){if("function"!=typeof e)throw new Error("Expected the nextReducer to be a function.");r=e,g({type:Ho.REPLACE})}function f(){var e,t=d;return(e={subscribe:function(e){if("object"!=typeof e||null===e)throw new TypeError("Expected the observer to be an object.");function n(){e.next&&e.next(l())}return n(),{unsubscribe:t(n)}}})[qo]=function(){return this},e}return g({type:Ho.INIT}),(i={dispatch:g,subscribe:d,getState:l,replaceReducer:h})[qo]=f,i}function Go(e,t){var n=t&&t.type;return"Given "+(n&&'action "'+String(n)+'"'||"an action")+', reducer "'+e+'" returned undefined. To ignore an action, you must explicitly return the previous state. If you want this reducer to hold no value, you can return null instead of undefined.'}function Ko(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function zo(e,t){var n=Object.keys(e);return Object.getOwnPropertySymbols&&n.push.apply(n,Object.getOwnPropertySymbols(e)),t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n}function Qo(e){for(var t=arguments,n=1;n<arguments.length;n++){var i=null!=t[n]?t[n]:{};n%2?zo(i,!0).forEach((function(t){Ko(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):zo(i).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Xo(){for(var e=arguments,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=e[i];return 0===n.length?function(e){return e}:1===n.length?n[0]:n.reduce((function(e,t){return function(){return e(t.apply(void 0,arguments))}}))}function Yo(e){return function(t){var n=t.dispatch,i=t.getState;return function(t){return function(r){return"function"==typeof r?r(n,i,e):t(r)}}}}var Zo=Yo();Zo.withExtraArgument=Yo;var ea=function(e,t){return function(e){for(var t=Object.keys(e),n=t.length,i=new Array(n);n--;)i[n]=[t[n],e[t[n]]];return i}(t).filter((function(t){var n=t[0];t[1];return n!==e})).reduce((function(e,t){var n,i=t[0],r=t[1];return ht(e,((n={})[i]=r,n))}),{})},ta="function"==typeof CustomEvent?function(e,t){return new CustomEvent(e,{detail:t})}:function(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n},na=function(e,t,n){var i=ta("GoMoxie:"+e,t);return i.version=n,i},ia=["u","w","W","p","q","V","v","$"],ra={events:[],eventsCount:0,sending:[],batchTimerState:"INITIALIZED",lastServerCallOK:!0,priorityEventAdded:!1,prevState:{},terminating:!1,failureStreak:0};var oa=function(e){for(var t=Object.keys(e),n={},i=0;i<t.length;i++){var r=t[i];"function"==typeof e[r]&&(n[r]=e[r])}var o,a=Object.keys(n);try{!function(e){Object.keys(e).forEach((function(t){var n=e[t];if(void 0===n(void 0,{type:Ho.INIT}))throw new Error('Reducer "'+t+"\" returned undefined during initialization. If the state passed to the reducer is undefined, you must explicitly return the initial state. The initial state may not be undefined. If you don't want to set a value for this reducer, you can use null instead of undefined.");if(void 0===n(void 0,{type:Ho.PROBE_UNKNOWN_ACTION()}))throw new Error('Reducer "'+t+"\" returned undefined when probed with a random type. Don't try to handle "+Ho.INIT+' or other actions in "redux/*" namespace. They are considered private. Instead, you must return the current state for any unknown actions, unless it is undefined, in which case you must return the initial state, regardless of the action type. The initial state may not be undefined, but can be null.')}))}(n)}catch(e){o=e}return function(e,t){if(void 0===e&&(e={}),o)throw o;for(var i=!1,r={},s=0;s<a.length;s++){var c=a[s],u=n[c],l=e[c],d=u(l,t);if(void 0===d){var g=Go(c,t);throw new Error(g)}r[c]=d,i=i||d!==l}return(i=i||a.length!==Object.keys(e).length)?r:e}}({schemaVersion:function(e,t){return void 0===e&&(e=1),e},eventService:function(e,t){void 0===e&&(e=ra);var n=ea("prevState",e),i=JSON.parse(JSON.stringify(n));if(!e.terminating)switch(t.type){case"ADD_EVENT":return ht(n,{prevState:i},{events:e.events.concat([ea("type",t)]),eventsCount:e.eventsCount+1});case"ADD_PRIORITY_EVENT":return ht(n,{prevState:i},{events:e.events.concat([ea("type",t)]),eventsCount:e.eventsCount+1,priorityEventAdded:!0})}switch(t.type){case"SEND_EVENTS":return ht(n,{prevState:i},{events:[],eventsCount:0,sending:e.events});case"SEND_PRIORITY_EVENTS":return ht(n,{prevState:i},{events:[],eventsCount:0,sending:e.events,priorityEventAdded:!1});case"CLEAR_SENT":return ht(n,{prevState:i},{sending:[],lastServerCallOK:!0,failureStreak:0});case"RETRY_SENT":return ht(n,{prevState:i},{events:e.sending.concat(e.events),eventsCount:e.eventsCount+e.sending.length,sending:[],lastServerCallOK:!1,failureStreak:e.failureStreak+1});case"SET_TIMER_STATE":return ht(n,{prevState:i},{batchTimerState:t.value||!1});case"TERMINATING":return ht(n,{prevState:i},{terminating:!0})}return e}});function aa(e,t,n){var i=3e4;return n>0&&(i+=1333*Math.pow(n,2),i=Math.min(3e5,i)),new A((function(n,r){var o=new XMLHttpRequest;o.timeout=i,o.open("POST",t.serverEndpoint),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("Accept","application/json"),o.onload=function(e){return n({status:o.status,body:o.response})},o.onerror=function(e){return n({status:o.status,message:"Could not read error response, probably because CORS headers are missing."})},o.send(JSON.stringify(function(e){for(var t={e:[]},n={},i=JSON.parse(JSON.stringify(e)),r=0;r<ia.length;r++){var o=ia[r],a=sa(i.map((function(e){return e.payload[o]})));if(1===a.length&&void 0!==a[0]){n[o]=a[0];for(var s=0;s<i.length;s++){delete i[s].payload[o]}}}return(t=ht(n,t)).e=i.map((function(e){return e.payload})),t.d=Date.now(),t}(e)))}))}function sa(e){for(var t=[],n=0;n<e.length;n++){var i=e[n];-1===ca(t,i)&&t.push(i)}return t}function ca(e,t,n){var i=isFinite(n)?Math.floor(n):0,r=e instanceof Object?e:new Object(e),o=isFinite(r.length)?Math.floor(r.length):0;if(i>=o)return-1;if(i<0&&(i=Math.max(o+i,0)),void 0===t){do{if(i in r&&void 0===r[i])return i}while(++i<o)}else do{if(r[i]===t)return i}while(++i<o);return-1}var ua=function(e,t){if("SEND_PRIORITY_EVENTS"===e){var n=new na("PriorityEvents",{status:t});window.dispatchEvent(n)}},la=function(e,t){return function(n,i){if(i().eventService.events.length>0){n({type:e});var r=i().eventService.failureStreak;aa(i().eventService.sending,t,r).then((function(t){i().eventService.terminating||(t.status>=200&&t.status<300||t.status>=400&&t.status<500?(ua(e,!0),n(ga())):r>=8640?(ua(e,!1),n(ga())):(ua(e,!1),n({type:"RETRY_SENT"})))}))}}};function da(e){return la("SEND_EVENTS",e)}function ga(){return{type:"CLEAR_SENT"}}var ha=function(e,t){void 0===t&&(t=function(e){return e}),this.timeout_in_ms=e,this.stateChangeCallbackFn=t,this.timerState="INITIALIZED"};ha.prototype.timerInternalState=function(){return this.timerState},ha.prototype.startTimer=function(e){var t=this;void 0===e&&(e=this.timeout_in_ms);this.timer=setTimeout((function(){t.timerState="EXPIRED",t.stateChangeCallbackFn("EXPIRED")}),e),this.timerState="RUNNING",this.stateChangeCallbackFn("RUNNING")},ha.prototype.cancelTimer=function(){clearTimeout(this.timer),this.timerState="CANCELLED",this.stateChangeCallbackFn("CANCELLED")};var fa=[function(e){var t={schemaVersion:1,eventService:ht({},e.eventService,{terminating:!1})};return ht({},e,t)}],pa=function(){try{var e=localStorage.getItem("moxieState");if(null===e)return;return function(e,t){void 0===t&&(t=fa);var n=e.schemaVersion||0,i=t.length;n<i&&t.slice(n,i).forEach((function(t){return e=t(e)}));return e}(JSON.parse(e))}catch(e){return}};function va(e,t,n){e.subscribe((function(){var i=e.getState().eventService.prevState.eventsCount,r=e.getState().eventService.eventsCount;if(i!==r){var o=e.getState().eventService.prevState.lastServerCallOK,a=e.getState().eventService.lastServerCallOK,s=e.getState().eventService.priorityEventAdded,c=0===e.getState().eventService.sending.length;c&&s?(t.cancelTimer(),e.dispatch(function(e){return la("SEND_PRIORITY_EVENTS",e)}(n))):c&&a&&r>=5?(t.cancelTimer(),e.dispatch(da(n))):0===i&&r>=1?(t.cancelTimer(),a?t.startTimer():t.startTimer(1e4)):!0===o&&!1===a&&(t.cancelTimer(),t.startTimer(1e4))}})),e.subscribe((function(){var t=e.getState().eventService.prevState.batchTimerState,i=e.getState().eventService.batchTimerState;t!==i&&"EXPIRED"===i&&e.dispatch(da(n))})),e.subscribe((function(){var t=e.getState().eventService.prevState.eventsCount,n=e.getState().eventService.eventsCount,i=e.getState().eventService.prevState.sending,r=e.getState().eventService.sending,o=e.getState().eventService.terminating;(t!==n||i!==r)&&!o&&function(e){try{var t=JSON.stringify(e);localStorage.setItem("moxieState",t)}catch(e){return}}(e.getState())}))}var ma=function(e){if(this.store=null,this.batchTimer=null,this.config=e,this.startEventService(),void 0===this.config.serverEndpoint)throw"serverEndpoint config value is required for the EventService"};function wa(e){this.scriptElement=e,this.engagementWidgetsVersion=null,this.engagementRulesVersion=null}ma.prototype.notifyEventService=function(e){this.store.dispatch({type:"ADD_EVENT",payload:e})},ma.prototype.notifyEventServiceImmediately=function(e){this.store.dispatch({type:"ADD_PRIORITY_EVENT",payload:e})},ma.prototype.startEventService=function(){var e=pa();null!=e&&null!==e.eventService&&void 0!==e.eventService&&(e.eventService.failureStreak=0),this.store=Bo(oa,e,function(){for(var e=arguments,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=e[i];return function(e){return function(){var t=e.apply(void 0,arguments),i=function(){throw new Error("Dispatching while constructing your middleware is not allowed. Other middleware would not be applied to this dispatch.")},r={getState:t.getState,dispatch:function(){return i.apply(void 0,arguments)}},o=n.map((function(e){return e(r)}));return Qo({},t,{dispatch:i=Xo.apply(void 0,o)(t.dispatch)})}}}(Zo));var t,n=(t=this.store,function(e){t.dispatch({type:"SET_TIMER_STATE",value:e})});this.batchTimer=new ha(5e3,n),va(this.store,this.batchTimer,this.config),this.store.dispatch({type:"CLEAR_SENT"}),this.batchTimer.startTimer()},ma.prototype.stopEventService=function(){this.store.dispatch({type:"TERMINATING"}),this.batchTimer.cancelTimer(),this.store.dispatch({type:"CLEAR_SENT"}),this.store.dispatch(da(this.config)),function(){try{localStorage.removeItem("moxieState")}catch(e){return}}()},wa.prototype.logError=function(e,t){var n=e+": ";t.stack?n+=t.stack:t.message?n+=t.message:n+=t.toString(),ye.error(n)},wa.prototype.getTranslation=function(e,t,n){return this.localization.translate(e+".client."+t,n)},wa.prototype.registerNamespace=function(){return window.GoMoxie=window.GoMoxie||{},window.GoMoxie.concierge={},window.GoMoxie.console=ye,this.isTestMode||ye.suppressLogs(),window.GoMoxie};function ya(){return function(){var e,t=["JxBrowser","MoxieAgentClient","JavaFX"];for(e=0;e!==t.length;e++)if(-1!==window.navigator.userAgent.indexOf(t[e]))return!1;var n=!1,i=li(window.navigator);if(-1!==P(["chrome","firefox","safari","msie","android"],i[0]))if("msie"===i[0]){if(-1!==window.navigator.userAgent.toLowerCase().indexOf("iemobile"))return!1;n=parseInt(i[1])>=11}else n="android"!==i[0]||parseFloat(i[1])>=5;else n=!1;return n}()}function ba(){var e="Concierge failed to load: ";if(!ya())throw Ln("conciergeFailedToLoad",e+="unsupported browser"),new Error(e);if(!function(){var e=!1;try{e=void 0!==window.localStorage.getItem("MoxieUndefinedKey")}catch(e){ye.error(e)}return e}())throw Ln("conciergeFailedToLoad",e+="localStorage required"),new Error(e);return!0}wa.prototype.prepare=function(e,t,n){n=n||{},Bt("#concierge").remove(),this.url=e,this.pageTitle=t,this.scriptLocation=this.scriptElement.getScriptLocation(),this.isTestMode=this.scriptElement.getTestMode(),this.logDisabled=this.scriptElement.getLogFlag(),this.clientName=this.scriptElement.getClientName(),this.positionMethod=this.scriptElement.getDisplayConfiguration().positionMethod,this.conciergeHost=this.scriptElement.getConciergeHost(),this.separator=this.scriptElement.getConciergeSeparator(),this.protocol=0===this.scriptLocation.indexOf("https:")?"https:":"http:",this.currentOfferCreatedAt=null,this.gomoxie=this.registerNamespace(),this.loadState="LOADING",this.serviceUrl={connector:this.protocol+"//connector"+this.separator+this.clientName+"."+this.conciergeHost,location:this.protocol+"//location."+this.conciergeHost,events:this.protocol+"//events"+this.separator+this.clientName+"."+this.conciergeHost+"/1.1/events"},this.assetVersion={rules:"",widgets:""},this.onQuestionnaireLoadedCallbacks=new ji,this.onQuestionnaireSubmitCallbacks=new ji,this.httpGet=this.httpGet||(new Kt).get,this.localization=n.localization||new Ri(this),this.rulesEngine=n.rulesEngine||new Ui(this),this.eventService=n.eventService||new ma({serverEndpoint:this.serviceUrl.events}),this.publicAPI=n.publicAPI||new Kr,this.publicAPI.registerMethods(this,this.gomoxie),this.publicApiV2=n.publicApiV2||new Gr(this,this.gomoxie),this.cacheManager=this.cacheManager||n.cacheManager||new Ni(this),this.widgetManager=n.widgetManager||new Po(this),this.contextMonitor=n.contextMonitor||new Di(this),this.serviceLines=n.serviceLines||new Vi(this)},wa.prototype.prepareAndInit=function(e,t,n){return this.prepare(e,t,n),this.init()},wa.prototype.initAPI=function(){var e=this,t=e.scriptLocation+"/config/latest/configuration.json";return-1!==this.url.indexOf("MoxieTest=true")&&sessionStorage.setItem("MoxieConfigCacheBust","true"),"true"===sessionStorage.getItem("MoxieConfigCacheBust")&&(t+="?cacheBuster="+Date.now()),this.apiReady=A.all([this.httpGet(t).then((function(t){return e.configuration=t,e.assetVersion.widgets=t.widgets.version,e.localization.init(),e.widgetManager.preloadCSS()})),e.cacheManager.init()]).then((function(){return e.contextMonitor.initTracking()})).then((function(){return e.widgetManager.init(),e.rulesEngine.init(e.configuration),e.widgetManager.loadActiveWidgets()})).then((function(){return function(e,t){var n=new Qt(e,t,"1.0");try{window.dispatchEvent(n)}catch(t){ye.log("PublicAPI.broadcastNow("+e+"): error: "+(t.stack?t.stack:t.message))}return n}("apiReady")})),this.apiReady},wa.prototype.init=function(){var e,t=this;return this.ready=this.initAPI().then((e=function(){return t.contextMonitor.start(),t.rulesEngine.run(),t.widgetManager.addEventListeners(t.widgetManager),t.widgetManager.showConcierge(),t.widgetManager.fixPosition(t.positionMethod),En(t),Ln("conciergeReady"),t.loadState="READY",!0},function(){return"LOADING"===t.loadState?e():null})),this.ready.catch((function(e){t.loadState="FAILED",t.logError("Concierge Unexpected Error",e),Ln("conciergeFailedToLoad")})),this.ready};var Sa=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],Ca=/^(?:([^:/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:/?#]*)(?::(\d*))?))?((((?:[^?#/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,_a=/^(?:(?![^:@]+:[^:@/]*@)([^:/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#/]*\.[^?#/.]+(?:[?#]|$)))*\/?)?([^?#/]*))(?:\?([^#]*))?(?:#(.*))?)/,Ia=/(?:^|&)([^&=]*)=?([^&]*)/g;function Na(e){ba(),this.element=e}Na.getScriptElement=function(){for(var e=document.getElementsByTagName("script"),t=0;t<e.length;t++)if(e[t].getAttribute("data-concierge")||e[t].getAttribute("concierge"))return new Na(e[t]);return null},ht(Na.prototype,{getSourceUri:function(){return function(e,t){for(var n=t?Ca:_a.exec(e),i={queryKey:{}},r=14;r--;)i[Sa[r]]=n[r]||"";return i.query.replace(Ia,(function(e,t,n){t&&(i.queryKey[t]=n)})),i}(this.element.src,!1)},getTestMode:function(){var e=this.getSourceUri();return e.queryKey.testmode?"true"===e.queryKey.testmode:localStorage.getItem("Moxie_testmode")},getLogFlag:function(){var e=this.getSourceUri();return e.queryKey.log?"false"===e.queryKey.log:localStorage.getItem("Moxie_log")},getAttribute:function(e){return this.element.getAttribute(e)},getScriptLocation:function(){var e=this.getAttribute("data-concierge-script-location");if(e)return e;var t=this.getSourceUri(),n=[t.protocol,"://",t.host];80===t.port&&443===t.port||!t.port||n.push(":"+t.port);var i=t.path?t.path.split("/").slice(0,-2).join("/"):"";return n.push(i),n.join("")},getClientName:function(){return this.getAttribute("data-client")?this.getAttribute("data-client"):this.getScriptLocation().match(/([^/]+)$/).pop()},getConciergeHost:function(){return this.getAttribute("data-concierge-host")?this.getAttribute("data-concierge-host"):"gomoxie.solutions"},getConciergeSeparator:function(){var e="-",t=this.getSourceUri();return t.queryKey.separator&&(e=t.queryKey.separator),e},getDisplayConfiguration:function(){var e=this.getAttribute("data-display-config");return e&&(e=JSON.parse(e)),e&&"object"==typeof e?{positionMethod:e.positionMethod||"css"}:{positionMethod:"css"}}}),function(){var e;try{ba();var t=new wa(Na.getScriptElement()),n=document.location.href,i=document.title;e=t.prepareAndInit(n,i)}catch(t){ye.error(t),e=A.reject(t)}window.conciergeReady=window.conciergeReady||e}()}();
